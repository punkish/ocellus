'use strict';

if (typeof(O) === 'undefined' || typeof(O) !== 'object') O = {};

// a place to cache the total number of images, treatments, 
// and citations, usually on page load. This way the db 
// doesn't have to be queried everytime the user changes 
// the resource being searched
O['num-of-records'] = {
    images: 0,
    treatments: 0,
    citations: 0
};

O.logger = function(fn, msg) {
    const line = '-'.repeat(50);
    log.info(line);
    log.info(`${fn}: ${msg}`);
    log.info(line);
};

O.init = function() {
    const resources = ['treatments', 'citations', 'images'];
    const pseudoResources = ['about', 'ip', 'contact', 'privacy'];

    // add click events to modal togglers and modal close links
    O.addEventHandlers([
        { 
            selectors: document.querySelectorAll('.modal-open'), 
            action: 'click', 
            handler: { name: 'openModal()', fn: O.openModal } 
        },
        { 
            selectors: document.querySelectorAll('.modal-close'), 
            action: 'click', 
            handler: { name: 'closeModal()', fn: O.closeModal } 
        }
    ]);

    // when page loads, try to determine the requested resource
    // from the URI. The resouce will default to 'index'
    const {hash, resource, search} = O.resourceFromUrl(location);

    if (O.closedForMaintenance) {

        const r = resource === 'index' || resources.includes(resource);

        if (r) {
            O.show('closedForMaintenance');
        }
        else if (pseudoResources.includes(resource)) {
            O.show(resource); 
        }     
    }
    else {

        O.addEventHandlers([
            { 
                selectors: [ document.querySelector('#searcher') ], 
                action: 'submit', 
                handler: { name: 'getResource()', fn: O.getResource } 
            },
            { 
                selectors: [ document.querySelector('input[name=submit]') ], 
                action: 'click', 
                handler: { name: 'getResource()', fn: O.getResource } 
            },
            {
                selectors: document.querySelectorAll('input[name=resource]'), 
                action: 'click', 
                handler: { name: 'selectResource()', fn: O.selectResource } 
            },
            { 
                selectors: [
                    document.querySelector('input[name=refreshCache]'), 
                    document.querySelector('input[name=communitiesChooser]')
                ],
                action: 'click', 
                handler: { name: 'toggler()', fn: O.toggler }
            }
        ]);

        if (pseudoResources.includes(resource)) {
            O.show(resource);
        }
        else {
            O.show('searcher');

            new autoComplete({
                selector: document.querySelector('input[name=q]'),
                minChars: 3,
                source: function(term, response) {
                    try { fetch.abort() } catch(e) {}
                    fetch(`${O.zenodeoUri}/families?q=${term}`)
                        .then(O.fetchReceive)
                        .then(response);
                }
            });

            if (resource === 'index') {
                O.setP(document.querySelector('input[name=resource]:checked').value);
                O.show('index');                
            }
            else if (resources.includes(resource)) {
                if (search) {
                    O.fillSearchForm(search, resource);
                }
                else {
                    O._selectResource(resource);
                    O.setP(resource);
                    O.show(resource);
                }
            }
        }
    
    }
};

// add event listeners to various elements that toggle
// visibility of other elements, or submit form
O.addEventHandlers = function(eventHandlers) {

    O.logger('addEventHandlers()', 'adding event handlers');

    for (let i = 0, j = eventHandlers.length; i < j; i++) {
        const {selectors, action, handler} = eventHandlers[i];
        
        for (let i = 0, j = selectors.length; i < j; i++) {
            const el = selectors[i];
            const id = el.name || el.id || `${el.nodeName}.${el.pathname.split('/').pop()}`;
                
            log.info(`- added ${handler.name} to ${id}`);
            el.addEventListener(action, handler.fn);
        }

    }
    
};

O.toggler = function(event) {
    const target_id = event.target.name;
    const t = document.querySelector(`#${target_id}`);

    if (t.classList.contains('hidden-none')) {
        t.classList.add('visible-block');
        t.classList.remove('hidden-none');
    }
    else if (t.classList.contains('hidden-block')) {
        t.classList.add('visible-block');
        t.classList.remove('hidden-block');
    }
    else if (t.classList.contains('visible-block')) {
        t.classList.add('hidden-block');
        t.classList.remove('visible-block');
    }
};

O.openModal = function(event) {

    // first, hide all modals and resources
    const modals = document.querySelectorAll('main section');
    for (let i = 0, j = modals.length; i < j; i++) {
        O.hide(modals[i].id);
    }

    const href = event.target.href;
    const modal = href.split('/').pop().split('.').shift();

    // now show the requested element and change the browser url
    const url = `${modal}.html`;
    history.pushState(null, null, url);

    O.show(modal);

    event.stopPropagation();
    event.preventDefault();
};

// handler attached to 'close' links in the modals
O.closeModal = function(event) {
    let modal = event.target.parentElement.id;

    // Note: all modals have display property 'none'
    O.hide(modal);

    if (O.closedForMaintenance) {
        modal = 'closedForMaintenance';
    }
    else {
        modal = 'index';
        O.show('searcher');
    }

    // now show the requested element and change the browser url
    const url = O.closedForMaintenance ? 'index.html' : `${modal}.html`;
    history.pushState(null, null, url);
    O.show(modal);
    
    event.stopPropagation();
    event.preventDefault();
};

// show
O.show = function(id) {
    log.info(`showing ${id}`);
    const el = document.querySelector(`#${id}`);
    el.classList.add('visible-block');
    el.classList.remove('hidden-none');    
};

// hide
O.hide = function(id) {
    log.info(`hiding ${id}`);
    const el = document.querySelector(`#${id}`);
    el.classList.add('hidden-none');
    el.classList.remove('visible-block');
};

// format the text for the search criteria using the input values
O.formatSearchCriteria = function(s) {
    
    // the following input params are ignored while creating the 
    // textual version of the search criteria
    const remove = [
        'resource', 
        'communities', 
        'communitiesChooser',
        'refreshCache', 
        'size', 
        'page',
        'reset',
        'submit'
    ];

    const criteria = [];
    for (let k in s) {
        if (!remove.includes(k)) {
            const v = s[k];

            if (k === 'q') {
                if (s[k].length === 32) {
                    if (s.resource === 'treatments') {
                        criteria.push(`<span class="crit-key">treatmentId</span> is <span class="crit-val">${v}</span>`);
                    }
                    else if (s.resource === 'citations') {
                        criteria.push(`<span class="crit-key">bibRefCitationId</span> is <span class="crit-val">${v}</span>`);
                    }
                }
                else {
                    criteria.push(`<span class="crit-val">${v}</span> is in the text`);
                }
            }
            else {
                criteria.push(`<span class="crit-key">${k}</span> is <span class="crit-val">${v}</span>`);
            }
        }
    }

    let l = criteria.length;
    let sc = '';

    if (l === 1) {
        sc += criteria[0];
    }
    else if (l === 2) {
        sc +=  criteria.join(' and ');
    }
    else if (l > 2) {
        l = l - 1;
        sc += criteria.slice(0, l).join(', ') + ', and ' + criteria[l];
    }
    
    return sc;
};

O.toggleFigcaption = function(event) {

    const figcaptions = document.querySelectorAll('figcaption');
    
    // closed figcaption height
    const cfh = '30px';

    // first, close all figcaptions 
    for (let i = 0, j = figcaptions.length; i < j; i++) {
        figcaptions[i].style.maxHeight = cfh;
        figcaptions[i].style.overflow = 'hidden';
    }

    // now open the clicked figcaption
    const fc = this.parentElement;
    fc.style.maxHeight = '100%';
    fc.style.overflow = 'auto';
    
};

// Ocellus is always showing a resource. A resource can be 
// requested either via the URI (a bookmark or direct entry),
// or by choosing a resource from the resourceChooser in the
// form, or by clicking on one of the .togglers, the links that 
// show (or hide) modals
O.resourceFromUrl = function(loc) {
    const {hash, pathname, search} = loc;

    O.logger('resourceFromUri()', loc);

    const resource = pathname.split('/').pop().split('.')[0] || 'index';
    
    log.info(`- hash: ${hash}`);
    log.info(`- resource: ${resource}`);
    log.info(`- search: ${search}`);

    return {hash, resource, search};
};

O.resourceFromForm = function(event) {
    return document.querySelector('input[name=resource]:checked').value;
};

O.resourceFromModalClick = function(event) {
    const href = event.target.href;

    O.logger('resourceFromUri()', loc);
    log.info(`- href: ${href}`);

    if (href) {
        return href.split('/').pop().split('.').shift();
    }
};

O._selectResource = function(resource) {

    // remove .searchfocus from all labels
    const ls = document.querySelectorAll('#resourceChooser label');
    const is = document.querySelectorAll('#resourceChooser input');

    for (let i = 0, j = ls.length; i < j; i++) {
        if (is[i].value === resource) {
            is[i].checked = true;
            ls[i].classList.add('searchfocus');
        }
        else {
            is[i].checked = false;
            ls[i].classList.remove('searchfocus');
        }
    }

};

O.selectResource = function(event) {

    const r = event.target;
    const resource = r.value;
    log.info(`selected resource ${resource}`);


    O._selectResource(resource);
    O.setP(resource);
};

O.setP = function(resource) {

    if (O['num-of-records'][resource]) {
        O.setPlaceHolder({
            'num-of-records': O['num-of-records'][resource],
            resource: resource
        })
    }
    else {
        O.getFoo({
            resource: resource,
            inputs: null,
            cb: O.setPlaceHolder
        });
    }
};

O.setPlaceHolder = function(result) {

    if (O['num-of-records'][result.resource] == 0) {
        O['num-of-records'][result.resource] = result['num-of-records']
    }

    const ph = `search ${result['num-of-records']} ${result.resource}`;
    log.info(`placeholder: "${ph}"`);

    // set focus in the search field and get ready
    const q = document.querySelector('input[name=q]');
    q.placeholder = ph;
    q.focus();
};

O.fetchReceive = function(response) {
    if (!response.ok) {
        throw new Error('HTTP error, status = ' + response.status);
    }

    return response.json();
};

O.hls = function(resource) {
    const rs = document.querySelectorAll('input[name=resource');
    for (let i = 0, j = rs.length; i < j; i++) {

        const r = rs[i];
        const l = r.parentElement;

        if (r.value === resource) {
            log.info(`setting checked of ${r.value} to true`);
            r.checked = true;

            // add searchfocus to its label
            l.classList.add('searchfocus');
            
        }
        else {
            r.checked = false;
            l.classList.remove('searchfocus');
        }
    }
};

O.fillSearchForm = function(search, resource) {

    O.logger('fillSearchForm()', 'filling search form');
    log.info(`- search: ${search}`);
    log.info(`- resource: ${resource}`);

    // the following are the valid query params
    const valid = ['communities', 'page', 'size', 'q', 'doi', 'author', 'text'];
    const f = document.querySelector('#searcher');

    // use search to fiil the form
    const s = new URLSearchParams(search);
    for (const [key, value] of s) {
        if (valid.includes(key)) {

            const inputs = f.querySelectorAll(`input[name=${key}]`);
            for (let i = 0, j = inputs.length; i < j; i++) {
                const input = inputs[i];

                if (input.type === 'checkbox') {
                    if (input.value === value) {
                        log.info(`setting checked of ${input.name} with value ${input.value} to 'true'`)
                        input.checked = true;
                    }
                }
                else {
                    input.value = value;
                }

            }
        }
    }

    O.hls(resource);
    O.getResource();
};
'use strict';

if (typeof(O) === 'undefined' || typeof(O) !== 'object') O = {};

O.niceNumbers = function(n) {
    return n > 9 ? n : ['No', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'][n];
};

O.renderResults = function(result) {

    const resource = result.resource;
    const template = result.template;

    // the result panel where the results are shown
    const rp = document.querySelector(`#${resource} div.result`);
    const tl = document.querySelector(`#template-${template}`).innerHTML;
    const tp = {
        'template-pager': document.querySelector('#template-pager').innerHTML,
        'template-records-found': document.querySelector('#template-records-found').innerHTML,
        'template-kein-preview': document.querySelector('#template-kein-preview').innerHTML
    };

    rp.innerHTML = Mustache.render(tl, result, tp);

    const fc = document.querySelectorAll('figcaption > a');
    for (let i = 0, j = fc.length; i < j; i++) {
        fc[i].addEventListener('click', O.toggleFigcaption);
    }

    return result.resource;
};

O.getResource = function(event) {

    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const f = document.querySelector('#searcher');
    const fe = f.elements;

    // don't go further if search field is empty
    const q = f.querySelector('input[name=q]');
    if (q.value === '') {
        q.placeholder = 'c‘mon, enter something';
        q.classList.remove('nudge');
        q.classList.add('warning');
        q.focus();
        return false;
    }
    else {
        q.classList.remove('warning');
        q.classList.add('nudge');
    }

    // we will collect all the form inputs in 'inputs'
    const inputs = {};
    for (let i = 0, j = fe.length; i < j; i++) {
        const inp = f[i];
        if (inp.name) {
            const n = inp.name;
            const v = inp.value;
            const t = inp.type;
            const c = inp.checked;

            if (t === 'checkbox') {
                if (c) {
                    if (n in inputs) {
                        inputs[n].push(v);
                    }
                    else {
                        inputs[n] = [v];
                    }
                }
            }
            else if (t === 'radio') {
                if (c) {
                    inputs[n] = v;
                }
            }
            else {
                inputs[n] = v;
            }
        }
    }
        
    O.getFoo({
        resource: document.querySelector('input[name=resource]:checked').value,
        inputs: inputs,
        cb: O.renderResults
    });
    
};

O.noThrob = function(resource) {

    // first, hide all modals and resources
    const modals = document.querySelectorAll('main section');
    for (let i = 0, j = modals.length; i < j; i++) {
        const id = modals[i].id;
        if (id !== resource) {
            O.hide(id);
        }
    }

    const t = document.querySelector('#throbber');
    t.classList.add('nothrob');
};

O.getFoo = function(obj) {

    const {resource, inputs, cb} = obj;
    const {z, b} = O.inputs2uris(inputs, resource);

    O.logger('getFoo()', `getting ${resource}`);
    log.info(`zenodeoUri: ${z}`);
    log.info(`browserUri: ${b}`);

    // activate the throbber
    const t = document.querySelector('#throbber');
    t.classList.remove('nothrob');

    // inputs will exist if getFoo() has been called from getResource(),
    // that is, a resource is being queried for either via the form
    // or by loading a URL with search params
    let sct;
    if (inputs) {

        // add the search criteria text to the resource page
        sct = inputs ? O.formatSearchCriteria(inputs) : '';
        O.waitMessage(resource, sct);

        // set the browser URL and show the resource page with the 
        // "Looking for…" message
        history.pushState(null, null, b);
        O.show(resource);
    }

    const _makeLayout = function(resource, records) {

        let figures = [];
    
        if (resource === 'treatments') {
            for (let i = 0, j = records.length; i < j; i++) {
                const r = records[i];
                r.recId = r.treatmentId;
                figures.push(r);
            }
        }

        else if (resource === 'images') {
            for (let i = 0, j = records.length; i < j; i++) {
                const r = records[i];
                
                figures.push({
                    title       : r.metadata.title,
                    creators    : r.metadata.creators ? r.metadata.creators.map(c => c.name) : [],
                    recId       : r.id,
                    zenodoRecord: `${O.zenodoUri}/${r.id}`,
                    description : r.metadata.description,
                    doi         : r.doi,
                    img         : r.links.thumbs ? true : false,
                    img10       : r.links.thumbs ? r.links.thumbs['10']   : '',
                    img50       : r.links.thumbs ? r.links.thumbs['50']   : '',
                    img100      : r.links.thumbs ? r.links.thumbs['100']  : '',
                    img250      : r.links.thumbs ? r.links.thumbs['250']  : '',
                    img750      : r.links.thumbs ? r.links.thumbs['750']  : '',
                    img1200     : r.links.thumbs ? r.links.thumbs['1200'] : ''
                })
            }
        }

        else if (resource === 'citations') {
            for (let i = 0, j = records.length; i < j; i++) {
                const r = records[i];
                r.recId = r.bibRefCitationId;
                figures.push(r);
            }
        }

        return figures;
    };

    try {

        // now fetch the records and process the result
        fetch(z)
            .then(O.fetchReceive)
            .then(function(ress) {

                log.info(ress);
                const res = 'value' in ress ? ress.value : ress;                
                const recs = res['num-of-records'];            

                const result = {
                    resource: resource,
                    'num-of-records': recs
                };

                if (inputs) {
                    
                    const limit = 30;
                    result['search-criteria-text'] = sct;

                    if (inputs.q.length === 32) {
                        if (res['search-criteria'].resource === 'treatments') {
                            result.template = 'treatment';
                        }
                        else if (res['search-criteria'].resource === 'citations') {
                            result.template = 'citation';
                        }

                        if (recs) {
                            result.figures = res.records[0];
                        }
                    }
                    else {
                        result.template = result.resource;

                        // make pager and layout ///////////////////////////////////////
                        result.niceNumbers = O.niceNumbers(recs);

                        if (recs) {
                            result.successful = true;

                            if (recs == 1) {
                                result.shown = 'it is shown below';
                            }
                            else if (recs > 1 && recs <= limit) {
                                result.shown = `${O.niceNumbers(res.from)} to ${O.niceNumbers(recs)} are shown below`;
                            }
                            else {
                                result.shown = `${O.niceNumbers(res.from)} to ${O.niceNumbers(res.to)} are shown below`;
                            }
                                            
                            result.figures = _makeLayout(resource, res.records);
                            

                            if (recs >= limit) {
                                result.prev = b.replace(/page=\d+/, `page=${res.prevpage}`);
                                result.next = b.replace(/page=\d+/, `page=${res.nextpage}`);
                                result.pager = true;
                            }
                            
                        }
                        else {
                            result.successful = false;
                            result.shown = '';
                            result.pager = false;
                            result.figures = [];
                        }
                        ////////////////////////////////////////////////////////////////

                    }
                    
                }

                return result;

            })
            .then(cb)
            .then(O.noThrob);
    }
    catch (error) {
        log.error(error);
    }
    
};

O.waitMessage = function(resource, searchcriteria) {
    const rp = document.querySelector(`#${resource}`);
    O.show(resource);
    const rf = rp.querySelector('.result');
    rf.innerHTML = `<p id="records-found" class="records-found">Looking for ${resource} where ${searchcriteria}</p>`;
};

O.inputs2uris = function(inputs, resource) {
    
    // valid params for zenodeo uri
    const zuValid = {
        images: [ 'q', 'size', 'page', 'communities', 'refreshCache' ],
        treatments: [ 'q', 'size', 'page', 'refreshCache' ],
        citations: [ 'q', 'size', 'page', 'refreshCache' ]
    };

    // valid params for browser uri
    const buValid = {
        images: [ 'q', 'size', 'page', 'communities' ],
        treatments: [ 'q', 'size', 'page' ],
        citations: [ 'q', 'size', 'page' ]
    };

    const zparams = [];
    const bparams = [];

    for (const key in inputs) {

        if (zuValid[resource].includes(key)) {
            if (key === 'q') {
                if (key.length == 32) {
                    if (resource === 'treaments') {
                        zparams.push(`treatmentId=${inputs[key]}`);
                    }
                    else if (resource === 'citations') {
                        zparams.push(`bibRefCitationId=${inputs[key]}`);
                    }
                }
                else {
                    zparams.push(`q=${inputs[key]}`);
                }
            }
            else {
                zparams.push(`${key}=${inputs[key]}`);
            }
        }

        if (buValid[resource].includes(key)) {
            bparams.push(`${key}=${inputs[key]}`);
        }
        
    }

    const zs = zparams.length ? `?${zparams.sort().join('&')}` : '';
    const z = `${O.zenodeoUri}/${resource}${zs}`;

    const bs = bparams.length ? `?${bparams.join('&')}` : '';
    const b = `${resource}.html${bs}`;
    return {z: z, b: b};
};