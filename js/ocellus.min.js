"undefined"!=typeof OCELLUS&&"object"==typeof OCELLUS||(OCELLUS={}),OCELLUS.templates={pager:document.querySelector("#template-pager").innerHTML,"records-found":document.querySelector("#template-records-found").innerHTML,charts:document.querySelector("#template-charts").innerHTML,figures:document.querySelector("#template-figures").innerHTML,treatments:document.querySelector("#template-treatments").innerHTML,treatment:document.querySelector("#template-treatment").innerHTML,images:document.querySelector("#template-images").innerHTML},OCELLUS["template-partials"]={},OCELLUS.figcaptionHeight="30px",OCELLUS.figcaptions=[],OCELLUS.compileTemplates=function(){for(let t in OCELLUS.templates)Mustache.parse(OCELLUS.templates[t]);OCELLUS["template-partials"]["template-pager"]=OCELLUS.templates.pager,OCELLUS["template-partials"]["template-records-found"]=OCELLUS.templates["records-found"],OCELLUS["template-partials"]["template-charts"]=OCELLUS.templates.charts,OCELLUS["template-partials"]["template-figures"]=OCELLUS.templates.figures},OCELLUS.dom={maintenance:document.querySelector("#maintenance"),about:document.querySelector("#about"),privacy:document.querySelector("#privacy"),ip:document.querySelector("#ip"),contact:document.querySelector("#contact"),panels:document.querySelectorAll(".panel"),modalOpen:document.querySelectorAll(".modal-open"),modalClose:document.querySelectorAll(".modal-close"),throbber:document.querySelector("#throbber"),form:document.querySelector("form[name=simpleSearch]"),inputs:document.querySelectorAll("form[name=simpleSearch] input"),q:document.querySelector("#q"),urlFlagSelectors:document.querySelectorAll(".urlFlag"),resourceSelector:document.querySelector("#resourceSelector"),goGetIt:document.querySelector("#go-get-it"),communitiesSelector:document.querySelector(".drop-down"),communityCheckBoxes:document.querySelectorAll("input[name=communities]"),allCommunities:document.querySelector('input[value="all communities"]'),refreshCacheSelector:document.querySelector("input[name=refreshCache]"),urlFlagSelectors:document.querySelectorAll(".urlFlag"),treatments:document.querySelector("#treatments"),bigmap:document.querySelector("#bigmap")},OCELLUS.saveable=["treatments"],OCELLUS.savedState=null,OCELLUS.model={treatments:{},treatment:{},images:{}},OCELLUS.size=30,OCELLUS.map={url:"https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets",accessToken:"pk.eyJ1IjoicHVua2lzaCIsImEiOiJjajhvOXY0dW8wMTA3MndvMzBlamlhaGZyIn0.3Ye8NRiiGyjJ1fud7VbtOA"},OCELLUS.init=function(state){const{maintenance:maintenance}=state||{maintenance:!1};OCELLUS.toggle(OCELLUS.dom.panels,"off"),maintenance?OCELLUS.toggle(OCELLUS.dom.maintenance,"on"):(OCELLUS.addEvents(OCELLUS.dom.modalOpen,OCELLUS.modalOpen),OCELLUS.addEvents(OCELLUS.dom.modalClose,OCELLUS.modalClose),OCELLUS.addEvents(OCELLUS.dom.goGetIt,OCELLUS.goGetIt),OCELLUS.addEvents(OCELLUS.dom.communitiesSelector,OCELLUS.toggleCommunities),OCELLUS.addEvents(OCELLUS.dom.refreshCacheSelector,OCELLUS.toggleRefreshCache),OCELLUS.suggest(OCELLUS.dom.q),OCELLUS.activateUrlFlagSelectors(),OCELLUS.compileTemplates(),location.search?OCELLUS.goGetIt():(OCELLUS.getResource({resource:"treatments"}),OCELLUS.dom.q.focus()))},"undefined"!=typeof OCELLUS&&"object"==typeof OCELLUS||(OCELLUS={}),OCELLUS.modalOpen=function(event){event.stopPropagation(),event.preventDefault();for(let i=0,j=OCELLUS.saveable.length;i<j;i++){const s=document.getElementById(OCELLUS.saveable[i]);if(s.classList.contains("visible")){OCELLUS.savedState=OCELLUS.saveable[i],OCELLUS.turnOff(s);break}}OCELLUS.toggle(OCELLUS.dom.panels,"off");const id=event.target.hash.substr(1);OCELLUS.toggle(OCELLUS.dom[id],"on")},OCELLUS.modalClose=function(event){event.stopPropagation(),event.preventDefault();const id=event.target.hash.substr(1);if(OCELLUS.toggle(OCELLUS.dom[id],"off"),OCELLUS.savedState){const s=document.getElementById(OCELLUS.savedState);OCELLUS.turnOn(s),OCELLUS.savedState=null}},OCELLUS.addEvents=function(elements,func){const len=elements.length;if(len>1)for(let i=0,j=len;i<j;i++)elements[i].addEventListener("click",func);else elements.addEventListener("click",func)},OCELLUS.turnOff=function(element){element.classList.remove("visible"),element.classList.add("hidden")},OCELLUS.turnOn=function(element){element.classList.add("visible"),element.classList.remove("hidden")},OCELLUS.toggle=function(elements,state){const len=elements.length;if("on"===state)if(len>1)for(let i=0,j=len;i<j;i++)OCELLUS.turnOn(elements[i]);else OCELLUS.turnOn(elements);else if("off"===state)if(len>1)for(let i=0,j=len;i<j;i++)OCELLUS.turnOff(elements[i]);else OCELLUS.turnOff(elements)},"undefined"!=typeof OCELLUS&&"object"==typeof OCELLUS||(OCELLUS={}),OCELLUS.getImages=function(queryObj,search,uri){fetch(uri).then(OCELLUS.fetchReceive).then(function(res){const data=res.value;OCELLUS.model.images.resource="images",OCELLUS.model.images["records-found"]=data.recordsFound,OCELLUS.model.images.statistics=data.statistics,OCELLUS.model.images["search-criteria"]=OCELLUS.formatSearchCriteria(data.whereCondition),[OCELLUS.model.images.figures,OCELLUS.model.images.imagesFound]=makeLayout(data.images),makePager(OCELLUS.model.images,search,queryObj.page),OCELLUS.model.images["records-found"]=niceNumbers(xh.value.recordsFound),OCELLUS.dom.images.innerHTML=Mustache.render(OCELLUS.templates.images,OCELLUS.model.images,OCELLUS["template-partials"]),OCELLUS.statsChart(OCELLUS.model.images.statistics);const figs=document.querySelectorAll("figcaption > a");for(let i=0,j=figs.length;i<j;i++)figs[i].addEventListener("click",OCELLUS.toggleFigcaption);const carousel=document.querySelectorAll(".carousel");for(let i=0,j=carousel.length;i<j;i++)carousel[i].addEventListener("click",function(event){turnCarouselOn(OCELLUS.model.images,OCELLUS.model.images.figures[i].recId)});OCELLUS.toggle(OCELLUS.dom.throbber,"off"),OCELLUS.toggle(OCELLUS.dom.images,"on")})},"undefined"!=typeof OCELLUS&&"object"==typeof OCELLUS||(OCELLUS={}),OCELLUS.getOneTreatment=function(uri,search){fetch(uri).then(OCELLUS.fetchReceive).then(function(res){if(OCELLUS.model.treatment=res.value,uri.indexOf("xml")>-1)return OCELLUS.model.treatment;if(OCELLUS.model.treatment.imgCount=OCELLUS.niceNumbers(OCELLUS.model.treatment.imgCount),OCELLUS.model.treatment.zenodeo=zenodeo,OCELLUS.model.treatment["related-records"].materialsCitations.length&&(OCELLUS.model.treatment.materialsCitations=OCELLUS.model.treatment["related-records"].materialsCitations,OCELLUS.model.treatment.mapState="open"),OCELLUS.model.treatment["related-records"].bibRefCitations.length&&(OCELLUS.model.treatment.bibRefCitations=OCELLUS.model.treatment["related-records"].bibRefCitations,OCELLUS.model.treatment.bibRefCitationsState="open"),OCELLUS.model.treatment["related-records"].figureCitations.length&&(OCELLUS.model.treatment.figureCitations=OCELLUS.model.treatment["related-records"].figureCitations,OCELLUS.model.treatment.figureCitationsState="open"),OCELLUS.model.treatment["related-records"].treatmentAuthors.length&&(OCELLUS.model.treatment.treatmentAuthors=OCELLUS.model.treatment["related-records"].treatmentAuthors,OCELLUS.model.treatment.treatmentAuthorsList=OCELLUS.formatAuthorsList(OCELLUS.model.treatment["related-records"].treatmentAuthors)),OCELLUS.dom.treatments.innerHTML=Mustache.render(OCELLUS.templates.treatment,OCELLUS.model.treatment,OCELLUS["template-partials"]),"Zero"!==OCELLUS.model.treatment.imgCount){const figs=document.querySelectorAll("figcaption > a");for(let i=0,j=figs.length;i<j;i++)figs[i].addEventListener("click",OCELLUS.toggleFigcaption)}OCELLUS.model.treatment["related-records"].materialsCitations.length&&OCELLUS.makeMap(OCELLUS.model.treatment.materialsCitations),OCELLUS.toggle(OCELLUS.dom.throbber,"off"),OCELLUS.toggle(OCELLUS.dom.treatments,"on")})},OCELLUS.getManyTreatments=function(uri,search){fetch(uri).then(OCELLUS.fetchReceive).then(function(res){if(OCELLUS.model.treatments=res.value,OCELLUS.model.treatments["num-of-records"])if(OCELLUS.model.treatments.resource="treatments",OCELLUS.model.treatments["num-of-records"]>0){OCELLUS.model.treatments.records&&OCELLUS.model.treatments.records.length?(OCELLUS.model.treatments.successful=!0,OCELLUS.model.treatments["num-of-records"]=OCELLUS.niceNumbers(OCELLUS.model.treatments["num-of-records"]),OCELLUS.model.treatments.from=OCELLUS.niceNumbers(OCELLUS.model.treatments.from),OCELLUS.model.treatments.to<10&&(OCELLUS.model.treatments.to=OCELLUS.niceNumbers(OCELLUS.model.treatments.to).toLowerCase()),OCELLUS.model.treatments["search-criteria-text"]=OCELLUS.formatSearchCriteria(OCELLUS.model.treatments["search-criteria"]),OCELLUS.makePager(OCELLUS.model.treatments,search,!1)):OCELLUS.model.treatments.successful=!1,OCELLUS.dom.treatments.innerHTML=Mustache.render(OCELLUS.templates.treatments,OCELLUS.model.treatments,OCELLUS["template-partials"]);new Tabs({elem:"tabs",open:0});OCELLUS.statsChart(OCELLUS.model.treatments.statistics),OCELLUS.dom.q.placeholder=`search ${OCELLUS.model.treatments["num-of-records"]} treatments`}else OCELLUS.model.treatments.successful=!1,OCELLUS.model.treatments["num-of-records"]="No",OCELLUS.dom.treatments.innerHTML=Mustache.render(OCELLUS.templates.treatments,OCELLUS.model.treatments,OCELLUS["template-partials"]);OCELLUS.toggle(OCELLUS.dom.throbber,"off"),OCELLUS.toggle(OCELLUS.dom.treatments,"on")})},OCELLUS.getTreatments=function(queryObj,search,uri){queryObj.treatmentId?(console.log("getting a single treatment "+queryObj.treatmentId),OCELLUS.getOneTreatment(uri,search)):(console.log("getting many treatments from "+uri),OCELLUS.getManyTreatments(uri,search))},OCELLUS.makeMap=function(mcs){const mcmap=L.map("map",{center:[0,0],zoom:8,scrollWheelZoom:!1});L.tileLayer(OCELLUS.map.url,{attribution:OCELLUS.map.attribution,maxZoom:18,id:OCELLUS.map.id,accessToken:OCELLUS.map.accessToken}).addTo(mcmap);const markers=[];mcs.forEach(mc=>{if(mc.latitude&&mc.longitude){const marker=L.marker([mc.latitude,mc.longitude]).addTo(mcmap);marker.bindPopup(mc.typeStatus),markers.push(marker)}});const bounds=new L.featureGroup(markers).getBounds();mcmap.fitBounds(bounds)},"undefined"!=typeof OCELLUS&&"object"==typeof OCELLUS||(OCELLUS={}),OCELLUS.statsChart=function(statistics){Chart.platform.disableCSSInjection=!0;const charts=document.querySelectorAll(".chart");for(let i=0,j=charts.length;i<j;i++){const ctx=charts[i].getContext("2d");return new Chart(ctx,{type:"bar",data:{labels:statistics[i]["x-axis"].values,datasets:[{label:statistics[i]["chart-name"],data:statistics[i]["y-axis"].values,datalabels:{color:"#000000"},backgroundColor:"#ff0000",borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{scaleLabel:{fontSize:8}}]},responsive:!0,tooltips:{enabled:!1},legend:{display:!1}}})}},OCELLUS.niceNumbers=function(num){return num<10?["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][num]:num},OCELLUS.formatSearchCriteria=function(queryObject){function str(el){return"q"===el[0]?`<span class='crit-val'>${el[1]}</span> is in the <span class='crit-key'>text</span>`:`<span class='crit-key'>${el[0]}</span> is <span class='crit-val'>${el[1]}</span>`}["id","size","communities","page"].forEach(e=>{Object.keys(queryObject).indexOf(e)>-1&&delete queryObject[e]});let c="";const el=Object.entries(queryObject),l=el.length;if(1===l)c+=str(el[0]);else if(2===l)c+=`${str(el[0])} and ${str(el[1])}`;else{const ab=el.slice(0,l-1),last=el[l-1];c+=ab.map(e=>str(e)).join(", ")+" and "+str(last)}return c},OCELLUS.formatAuthorsList=function(treatmentAuthors){let c="";const l=treatmentAuthors.length;if(1===l)c+=treatmentAuthors[0].author;else if(2===l)c+=`${treatmentAuthors[0].author} and ${treatmentAuthors[1].author}`;else{const ab=treatmentAuthors.slice(0,l-1),last=treatmentAuthors[l-1].author;c+=ab.map(e=>e.author).join(", ")+" and "+last}return c},OCELLUS.makeUris=function(queryObj,setHistory=!0){let hrefArray1=[],hrefArray2=[];for(let p in queryObj)"resource"!==p&&hrefArray1.push(p+"="+queryObj[p]),"refreshCache"!==p&&hrefArray2.push(p+"="+queryObj[p]);const uri=`${OCELLUS.zenodeo}/v2/${queryObj.resource}?${hrefArray1.join("&")}`,search=hrefArray2.join("&");return setHistory&&history.pushState("","",`?${hrefArray2.join("&")}`),{search:search,uri:uri}},OCELLUS.getResource=function(queryObj){const{search:search,uri:uri}=OCELLUS.makeUris(queryObj);"treatments"===queryObj.resource?OCELLUS.getTreatments(queryObj,search,uri):"images"===queryObj.resource&&OCELLUS.getImages(queryObj,search,uri)},OCELLUS.syntheticData=function(resource,queryObj){function getRandomInt(max){return Math.floor(Math.random()*Math.floor(max))}const alpha=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];function getRandomString(len){let s="";for(let i=0;i<len;i++)s+=alpha[getRandomInt(26)];return s}resource.statistics={"below 10":0,"10 to 50":0,"above 50":0};const numOfRecords=getRandomInt(100);for(let i=0;i<numOfRecords;i++){const age=getRandomInt(100);resource.data.push({name:getRandomString(getRandomInt(10)),age:age}),age<10?resource.statistics["below 10"]++:age>50?resource.statistics["above 50"]++:resource.statistics["10 to 50"]++}resource["records-found"]=OCELLUS.niceNumbers(numOfRecords),resource.resource="treatments",resource["search-criteria"]=OCELLUS.formatSearchCriteria(queryObj),resource.successful=!0,resource.from="One",resource.to=30},OCELLUS.fetchReceive=function(response){if(!response.ok)throw new Error("HTTP error, status = "+response.status);return response.json()},OCELLUS.isXml=function(s){return 32===s.length},OCELLUS.urlDeconstruct=function(s){"?"===s.substr(0,1)&&(s=s.substr(1));const queryObject={};s.split("&").forEach(p=>{r=p.split("="),queryObject[r[0]]=r[1]}),queryObject.q&&(q.value=queryObject.q);const rtLabels=OCELLUS.dom.resourceSelector.querySelectorAll("label"),rtInputs=OCELLUS.dom.resourceSelector.querySelectorAll("input");for(let i=0;i<rtLabels.length;i++)queryObject.resource===rtInputs[i].value?rtLabels[i].classList.add("searchFocus"):rtLabels[i].classList.remove("searchFocus");return queryObject},OCELLUS.urlConstruct=function(){const queryObject={},inputs=OCELLUS.dom.inputs;for(let i=0,j=inputs.length;i<j;i++){const input=inputs[i];"radio"===input.type||"checkbox"===input.type?input.checked&&(queryObject[input.name]=input.value):queryObject[input.name]=input.value}return"images"===queryObject.resource&&(queryObject.access_right="open"),queryObject.page=1,queryObject.id=0,queryObject},OCELLUS.makePager=function(data,search){"?"===search.substr(0,1)&&(search=search.substr(1));const queryObject={};return search.split("&").forEach(p=>{r=p.split("="),queryObject[r[0]]=r[1]}),data["num-of-records"]&&data["num-of-records"]>=OCELLUS.size&&(data.prev="?"+search.replace(/page=\d+/,`page=${data.prevpage}`),data.next="?"+search.replace(/page=\d+/,`page=${data.nextpage}`)),data.pager=!0,data},OCELLUS.goGetIt=function(event){if(!location.search&&""===OCELLUS.dom.q.value)return OCELLUS.toggle(OCELLUS.dom.panels,"off"),OCELLUS.dom.q.placeholder="c’mon, enter something",!1;{let qp;event?(event.preventDefault(),event.stopPropagation(),qp=OCELLUS.urlConstruct(OCELLUS.dom.form)):location.search&&(qp=OCELLUS.urlDeconstruct(location.search)),OCELLUS.toggle(OCELLUS.dom.throbber,"on"),OCELLUS.getResource(qp)}},OCELLUS.toggleRefreshCache=function(event){OCELLUS.dom.refreshCacheWarning.classList.toggle("show")},OCELLUS.toggleCommunities=function(event){OCELLUS.dom.communitiesSelector.classList.toggle("open")},OCELLUS.toggleFigcaption=function(event){0==OCELLUS.figcaptions.length&&(OCELLUS.figcaptions=document.querySelectorAll("figcaption"));let fc=this.parentElement.style.maxHeight;if(fc===OCELLUS.figcaptionHeight||""===fc){let i=0;for(;i<OCELLUS.figcaptions.length;i++)OCELLUS.figcaptions[i].style.maxHeight=OCELLUS.figcaptionHeight;this.parentElement.style.maxHeight="100%",this.parentElement.style.overflow="auto"}else this.parentElement.style.maxHeight=OCELLUS.figcaptionHeight,this.parentElement.style.overflow="hidden"},OCELLUS.suggest=function(field){new autoComplete({selector:field,minChars:3,source:function(term,response){try{fetch.abort()}catch(e){}fetch(`${zenodeo}/v2/families?q=${term}`).then(OCELLUS.fetchReceive).then(response)}})},OCELLUS.activateUrlFlagSelectors=function(){for(let i=0,j=OCELLUS.dom.urlFlagSelectors.length;i<j;i++){const element=OCELLUS.dom.urlFlagSelectors[i];element.addEventListener("click",function(event){OCELLUS.chooseUrlFlags(element),"communities"===element.name&&OCELLUS.dom.communitiesSelector.classList.remove("open")})}},OCELLUS.chooseUrlFlags=function(element){if("communities"===element.name)if("all communities"===element.value){const j=OCELLUS.dom.communityCheckBoxes.length;if(!0===element.checked)for(let i=0;i<j;i++)OCELLUS.dom.communityCheckBoxes[i].checked=!0;else for(let i=0;i<j;i++)"all communities"!==OCELLUS.dom.communityCheckBoxes[i].value&&(OCELLUS.dom.communityCheckBoxes[i].checked=!1)}else OCELLUS.dom.allCommunities.checked=!1;else if("resource"===element.name){const rtLabels=OCELLUS.dom.resourceSelector.querySelectorAll("label"),rtInputs=OCELLUS.dom.resourceSelector.querySelectorAll("input");for(let i=0;i<rtLabels.length;i++)element.value===rtInputs[i].value?(rtLabels[i].classList.add("searchFocus"),OCELLUS.getResource({resource:rtInputs[i].value,stats:!0})):rtLabels[i].classList.remove("searchFocus")}else"refreshCache"===element.name&&(element.value=element.checked)};