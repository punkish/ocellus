const e=e=>document.querySelector(e),t=e=>document.querySelectorAll(e),s={page:1,size:30,fpage:1,fsize:30,refreshCache:!1,views:{images:{description:"images from Zenodo",totalCount:0,figures:[],page:1,size:30},treatments:{description:"treatments with images",totalCount:0,countOfTreatments:0,countOfFigures:0,figures:[],page:1,size:30,figpage:2,figsize:30},map:{description:"treatments with locations",totalCount:0,obj:null,bounds:null,layers:{baselayer:{groups:{osm:null}},h3:{groups:{grid2:null},controls:{info:null,legend:null}},treatments:{groups:{treatmentsOnLand:null,treatmentsInWater:null},controls:{layerControl:null}}}}},results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],validQueryParams:["communities","view","page","size","q"],not_q:["view","refreshCache","go"],hiddenClasses:["hidden","noblock"],notInSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit"],closedFigcaptionHeight:"30px",zenodoUri:"https://zenodo.org/record",tbUri:"https://tb.plazi.org/GgServer/html",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],treatmentIcon:{iconUrl:"/img/treatment.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]},treatmentIconHighlighted:{iconUrl:"/img/treatment-highlighted.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]},pager_length:9,sep:"•••",sep_position1:2,sep_position2:6},r=t=>{e("#refreshCache").classList.contains("unchecked")?(e("#refreshCache").classList.remove("unchecked"),e("#refreshCache").classList.add("checked"),e("#refreshCache").checked=!0,e("#refreshCacheMsg").classList.remove("hidden")):(e("#refreshCache").classList.remove("checked"),e("#refreshCache").classList.add("unchecked"),e("#refreshCache").checked=!1,e("#refreshCacheMsg").classList.add("hidden"))},o=t=>{""===e("#q").value?a(t):(e("#q").classList.remove("red-placeholder"),e("#throbber").classList.remove("nothrob"),u()),t.stopPropagation(),t.preventDefault()},n=r=>{const o=new URL(r.target.href).hash,n=t(".modal");o.length>0?(n.forEach((e=>{e.classList.add(...s.hiddenClasses)})),e(o).classList.remove(...s.hiddenClasses)):n.forEach((e=>e.classList.add(...s.hiddenClasses)))},a=t=>{e("#q").placeholder="search for something",e("#q").classList.remove("red-placeholder"),t.stopPropagation(),t.preventDefault()},i=t=>{e("#q").value="",e("#refreshCache").checked=!1,t.stopPropagation(),t.preventDefault()},c=t=>{e("#brand").innerHTML="MAP • IMAGES • TREATMENTS",setTimeout((()=>{e("#brand").innerHTML="4"}),2e3),t.stopPropagation(),t.preventDefault()},l=e=>{const s=t("figcaption");for(let e=0,t=s.length;e<t;e++)s[e].querySelector("div").classList.remove("open"),s[e].querySelector("div").classList.add("closed");const r=e.target.parentElement;r.querySelector("div").classList.remove("closed"),r.querySelector("div").classList.add("open")};log.level=log[O.loglevel];const d=()=>{let e=new URL(location).search;e?("?"===e.substring(0,1)&&(e=e.substring(1)),h(e)):g()},g=()=>{log.info("case1()"),log.info("- listeners.addListeners()"),e("#refreshCache").addEventListener("click",r),e("#go").addEventListener("click",o),t(".modalToggle").forEach((e=>e.addEventListener("click",n))),e("#q").addEventListener("focus",a),e("#clear-q").addEventListener("click",i),e("#brand").addEventListener("click",c)},u=()=>{log.info("case2()");const e=f();m(e),v(e)},h=e=>{log.info("case3(qs)"),log.info(`- qs: ${e}`),g(),p(e),v(e)},f=()=>{log.info("- form2qs()");const e=new URLSearchParams;return t("form input").forEach((t=>{if("q"===t.id){new URLSearchParams(t.value).forEach(((t,s)=>{""===t?e.append("q",s):(e.append(s,t),source="treatments")}))}else"refreshCache"===t.id?t.checked&&e.append("refreshCache",!0):"source"===t.name?t.checked&&e.append("source",t.value):e.append(t.id,t.value)})),e.toString()},p=s=>{log.info("- qs2form(qs)"),log.info(`  - qs: ${s}`);const r=new URLSearchParams(s);r.delete("refreshCache");const o=["source","page","size"];let n=[];r.forEach(((s,r)=>{if(o.includes(r))if("source"===r){t("input[name=source]").forEach((e=>{e.value===s&&(e.checked=!0)}))}else e(`#${r}`).value=s;else{const e="q"===r?s:`${r}=${s}`;n.push(e)}})),e("#q").value=n.join("&")},m=e=>{log.info("- updateUrl(qs)"),log.info(`  - qs: ${e}`),history.pushState("",null,`?${e}`)},v=async function(e){log.info("- getImages(qs)"),log.info(`  - qs: ${e}`);const t=new URLSearchParams(e),s=t.get("source");t.delete("source");const r=t.toString(),o=[];if("all"===s){const e=L({resource:"images",queryString:r}),t=L({resource:"treatments",queryString:`${r}&httpUri=ne()&cols=treatmentTitle&cols=zenodoDep&cols=httpUri&cols=captionText`});o.push(e,t)}else if("Zenodo"===s){const e=L({resource:"images",queryString:r});o.push(e)}else if("treatments"===s){const e=L({resource:"treatments",queryString:`${r}&httpUri=ne()&cols=treatmentTitle&cols=zenodoDep&cols=httpUri&cols=captionText`});o.push(e)}const n=t.get("page"),a=t.get("size");Promise.all(o).then((e=>{const t={prev:n>1?n-1:1,next:parseInt(n)+1,size:a,count:0,recs:[]};return e.forEach((e=>{t.recs.push(...e.recs),t.count+=e.count})),t})).then((t=>{const s={};t.recs.forEach((e=>{const t=$({size:250,treatmentId:e.treatmentId,title:e.title,zenodoRec:e.zenodoRec,uri:e.uri,caption:e.caption});s[e.uri]=t})),q({figures:Object.values(s),qs:e,count:t.count,prev:t.prev,next:t.next})}))},L=async({resource:e,queryString:t})=>{log.info("- getResource()"),log.info(`  - resource: ${e}`),log.info(`  - queryString: ${t}`);const s=`${O.zenodeo3Uri}/${e}?${t}`,r=await fetch(s);if(r.ok){const t=await r.json(),s=t.item.result.records,o={count:0,recs:[],prev:"",next:""};if(s)return o.count=o.count+t.item.result.count,s.forEach((t=>{"images"===e?o.recs.push({treatmentId:"",title:t.metadata.title,zenodoRec:t.id,uri:t.links.thumbs[250],caption:t.metadata.description}):"treatments"===e&&o.recs.push({treatmentId:t.treatmentId,title:t.treatmentTitle,zenodoRec:t.zenodoDep,uri:t.httpUri,caption:t.captionText})})),o}else alert("HTTP-Error: "+r.status)},$=({size:e,treatmentId:t,title:r,zenodoRec:o,uri:n,caption:a})=>{log.info("- makeFigure()");let i="image",c="";return t&&(i="treatment",c=`<a href="${s.tbUri}/${t}" target="_blank">more on TreatmentBank</a>`),`<figure class="figure-${e} ${i}">\n    <div class="switches">\n        <div class="close"></div>\n    </div>\n    <picture>\n        <img src="/img/bug.gif" width="${e}" data-src="${n}" class="lazyload" data-recid="${t}">\n    </picture>\n    <figcaption>\n        <a class="transition-050">Zenodo ID: ${o}</a>\n        <div class="closed">\n            <b class="figTitle">${r}</b><br>\n            ${a}<br>\n            <a href="${s.zenodoUri}/${o}" target="_blank">more on Zenodo</a><br>\n            ${c}\n        </div>\n    </figcaption>\n</figure>`},q=({figures:e,qs:t,count:s,prev:r,next:o})=>{log.info("- renderPage()"),log.info(`  - figures: ${e.length} figures`),log.info(`  - qs: ${t}`),log.info(`  - count: ${s}`),log.info(`  - prev: ${r}`),log.info(`  - next: ${o}`),b(e),z(t,r,o)},b=s=>{log.info("- renderFigures()"),e("#grid-images").innerHTML=s.join(""),e("#throbber").classList.add("nothrob"),(()=>{const e=t("figcaption > a");for(let t=0,s=e.length;t<s;t++)e[t].addEventListener("click",l)})()},z=(t,s,r)=>{log.info("- renderPager()"),log.info(`  - qs: ${t}`),log.info(`  - prev: ${s}`),log.info(`  - next: ${r}`);const o=new URLSearchParams(t);o.delete("page"),e("#pager").innerHTML=`<a href="?${o.toString()}&page=${s}">prev</a> <a href="?${o.toString()}&page=${r}">next</a>`,e("#pager").classList.add("filled"),log.info("- listeners.addListenersToPagerLinks()")};export{u as case2,d as init};
