"use strict";const sel_throbber=document.getElementById("throbber"),sel_gridTarget=document.getElementById("grid-target"),sel_grid=document.getElementById("grid"),sel_puff=document.getElementById("puff"),sel_q=document.getElementById("q"),sel_brand=document.getElementById("brand"),sel_refreshCacheMsg=document.getElementById("refreshCacheMsg"),sel_about=document.getElementById("about"),sel_go=document.getElementById("go"),sel_clearQ=document.getElementById("clearQ"),sel_refreshCache=document.getElementById("refreshCache"),sel_imgSwap=document.querySelectorAll("input[name=imgSize]"),sel_modals=document.querySelectorAll(".modal"),sel_modalOpen=document.querySelectorAll(".modal-open"),sel_modalClose=document.querySelectorAll(".modal-close"),sel_palette=document.getElementById("palette"),sel_count=document.getElementById("count"),sel_pager=document.getElementById("pager"),sel_searchResults=document.getElementById("search-results"),sel_treatmentsPager=document.getElementById("treatments-pager"),sel_figuresPager=document.getElementById("figures-pager"),sel_treatmentDetails=document.getElementById("treatmentDetails"),sel_hiddenFigures=document.getElementById("hidden-figures"),unhide=()=>{hidden.forEach((e=>{e.style.opacity=1,e.style.display="block"})),hidden.splice(0),sel_hiddenFigures.innerHTML=""},RESULTS={countOfTreatments:0,countOfFigures:0,figures:[]},PAGE=1,SIZE=30,FIGPAGE=1,FIGSIZE=30;let gridIsVisible=!1;const updateUrl=({queryString:e,page:t,size:s,fp:i,fs:r})=>{const n=new URLSearchParams(e);n.set("page",t),n.set("size",s),n.sort();const a=n.toString();history.pushState({},"",`4t.html?${decodeURIComponent(a)}#fp=${i}&fs=${r}`)},showPage=function({queryString:e,page:t,size:s,fp:i,fs:r}){console.log(`page: ${t}, size: ${s}`),s=parseInt(s);const n=(i-1)*r;let a=n+r;a>=RESULTS.countOfFigures&&(a=RESULTS.countOfFigures);const l=RESULTS.figures.slice(n,a).join("");updateUrl({queryString:e,page:t,size:s,fp:i,fs:r}),sel_grid.innerHTML=l,sel_gridTarget.classList.contains("hide")&&(sel_gridTarget.classList.remove("hide"),sel_gridTarget.classList.add("show"));document.querySelectorAll("div.close").forEach((e=>{e.addEventListener("click",smoke)}));document.querySelectorAll("figcaption > a").forEach((e=>{e.addEventListener("click",toggleFigcaption)}));document.querySelectorAll(".showTreatment").forEach((e=>{e.addEventListener("click",showTreatment)})),sel_throbber.classList.add("nothrob")},toggleFigcaption=function(e){document.querySelectorAll("figcaption div.desc").forEach((e=>{e.classList.remove("show"),e.classList.add("hide")}));const t=e.currentTarget.parentNode.querySelector(".desc");t.classList.remove("hide"),t.classList.add("show")},onlyUnique=function(e,t,s){return s.indexOf(e)===t};function getRandomInt(e){return Math.floor(Math.random()*Math.floor(e))}const grid=function(e,t){const s=t.httpUri.indexOf("zenodo")>-1?`${O.globals.zenodoUri}/${t.id}/thumb${e}`:t.httpUri,i=getRandomInt(300);return`<figure class="figure-${e}">\n    <div class="switches">\n        <div class="close"></div>\n    </div>\n    <picture>\n        <img src="../img/bug.gif" width="${e}" data-src="${s}" class="lazyload" data-recid="${t.id}">\n    \x3c!-- <img src="../img/bug.gif" data-src="../img/i250.jpg" class="lazyload" data-recid="${t.id}"> --\x3e\n    \x3c!-- <div style="width: 250px; height:${i}px;">250px x ${i}px</div> --\x3e\n    </picture>\n    <figcaption>\n        <a class="transition-050">rec ID: ${t.id}</a>\n        <div class="desc hide">\n            ${t.captionText}. \n            <a class='showTreatment' href='${O.globals.zenodeo3Uri}/treatments?treatmentId=${t.treatmentId}'>more</a>\n        </div>\n    </figcaption>\n</figure>`},closeLightbox=()=>sel_treatmentDetails.classList.add("hidden"),getTreatment=async function(e){const t=await fetch(e);if(t.ok){const e=await t.json(),s=e.item.result.records[0],i=e.item.result["related-records"].figureCitations.map((e=>{let t;return t=e.httpUri.indexOf("zenodo")>-1?`${O.globals.zenodoUri}/${e.httpUri.split("/")[4]}/thumb50`:e.httpUri,`<img src ="${t}">`}));let r=`<h2>${s.treatmentTitle}</h2>`;r+=`<div class="figs">${i.join(" ")}</div>`,r+='<div class="cite">',s.authorityName&&(r+=s.authorityName+". "),s.authorityYear&&(r+=s.authorityYear+". "),s.articleTitle&&(r+=s.articleTitle+". "),s.journalTitle&&(r+=""+s.journalTitle),s.journalYear&&(r+=s.journalYear+", "),s.journalVolume&&(r+=`vol. ${s.journalVolume}, `),s.journalIssue&&(r+=s.journalIssue+", "),s.pages&&(r+="pp. "+s.pages),r+="</div>",s.status&&(r+=`<div class="status"><b>status:</b> ${s.status}</div>`),r+='<ul class="classification">',s.kingdom&&(r+=`<li class="${"kingdom"===s.rank?"rank":""}">${s.kingdom}</li>`),s.phylum&&(r+=`<li class="${"phylum"===s.rank?"rank":""}">${s.phylum}</li>`),s.order&&(r+=`<li class="${"order"===s.rank?"rank":""}">${s.order}</li>`),s.family&&(r+=`<li class="${"family"===s.rank?"rank":""}">${s.family}</li>`),s.genus&&(r+=`<li class="${"genus"===s.rank?"rank":""}">${s.genus}</li>`),s.species&&(r+=`<li class="${"species"===s.rank?"rank":""}">${s.species}</li>`),r+="</ul>",sel_treatmentDetails.querySelector("div.text").innerHTML=r,sel_treatmentDetails.classList.remove("hidden")}else alert("HTTP-Error: "+t.status)},showTreatment=async function(e){const t=e.target.href;getTreatment(t),e.stopPropagation(),e.preventDefault()},fillForm=function(e){e.has("q")?Array.from(e.entries()).length>1?sel_q.value=decodeURIComponent(e.toString()):sel_q.value=e.get("q"):sel_q.value=decodeURIComponent(e.toString())},figPageClick=function(e){const t=new URL(e.currentTarget.href),{queryObj:s,queryString:i,page:r,size:n,fp:a,fs:l}=extractParamsAndHash(t);RESULTS.countOfFigures>0&&pager({total:RESULTS.countOfFigures,subtotal:"",queryString:i,page:r,size:n,fp:a,fs:l,resource:"figures",subresource:"",htmlElement:sel_figuresPager}),showPage({queryString:i,page:r,size:n,fp:a,fs:l}),e.stopPropagation(),e.preventDefault()},go=function(e){const t=sel_q.value;if(""===t)sel_q.placeholder="câ€™mon, enter something",sel_q.classList.add("red-placeholder");else{sel_q.classList.remove("red-placeholder"),sel_throbber.classList.remove("nothrob");const e=[t.indexOf("=")>-1?t:"q="+t];getResource({resource:"treatments",queryString:e.join("&"),page:1,size:30,fp:1,fs:30})}e.stopPropagation(),e.preventDefault()},getResource=async function({resource:e,queryString:t,page:s,size:i,fp:r,fs:n}){let a=`${O.globals.zenodeo3Uri}/${e.toLowerCase()}`;t&&(a+="?"+t);const l=await fetch(a);if(l.ok){const a=await l.json(),o=a.item.result.records;if(o)if("treatments"===e)RESULTS.countOfTreatments=a.item.result.count,RESULTS._links=a.item._links,getFigureCitations({records:o,queryString:t,page:s,size:i,fp:r,fs:n});else if("figureCitations"===e){return packageFigureCitations(o)}}else alert("HTTP-Error: "+l.status)},getFigureCitations=function({records:e,queryString:t,page:s,size:i,fp:r,fs:n}){e.map((e=>e.treatmentId));Promise.all(e.map((e=>getResource({resource:"figureCitations",queryString:"treatmentId="+e.treatmentId,page:s,size:i,fp:r,fs:n})))).then((e=>{e.forEach((e=>{void 0!==e&&e.length&&RESULTS.figures.push(...e)})),RESULTS.countOfFigures=RESULTS.figures.length,pager({total:RESULTS.countOfTreatments,subtotal:RESULTS.countOfFigures,queryString:t,page:s,size:i,fp:r,fs:n,resource:"treatments",subresource:"figures",htmlElement:sel_treatmentsPager}),RESULTS.countOfFigures>0&&pager({total:RESULTS.countOfFigures,subtotal:"",queryString:t,page:s,size:i,fp:r,fs:n,resource:"figures",subresource:"",htmlElement:sel_figuresPager}),showPage({queryString:t,page:s,size:i,fp:r,fs:n})}))},packageFigureCitations=function(e){if(e.length){e=e.filter((e=>""!==e.httpUri));const t=[],s=new Map;for(const i of e)if(!s.has(i.httpUri)){s.set(i.httpUri,!0);const e=i.httpUri.split("/")[4];t.push(grid(250,{id:e,httpUri:i.httpUri,captionText:i.captionText,treatmentId:i.treatmentId}))}return t}},init=function(){log.level=log[O.globals.loglevel],log.info("log level is "+O.globals.loglevel),listen(),flashBrand(),loadPage()},smokeWorks=function(e){sel_puff.style.left=e.pageX-24+"px",sel_puff.style.top=e.pageY-24+"px",sel_puff.style.display="inline",sel_puff.style.visibility="visible",sel_puff.style.opacity=1,animatePoof();const t=e.currentTarget.parentNode.parentNode;t.style.opacity=1,intervalId=setInterval((function(){let e=Number(t.style.opacity);e>0?(e-=.1,t.style.opacity=e):(clearInterval(intervalId),t.style.display="none")}),50)},hidden=[],smoke=function(e){let t=0;sel_puff.style.left=e.pageX-24+"px",sel_puff.style.top=e.pageY-24+"px",sel_puff.style.display="inline",sel_puff.style.visibility="visible",sel_puff.style.opacity=1,function(){let e=0,t=0;!function s(){t<6&&(sel_puff.style.backgroundPosition="0 "+e+"px",e-=32,t++,setTimeout(s,80))}()}();const s=e.currentTarget.parentNode.parentNode;hidden.push(s),sel_hiddenFigures.innerHTML=` (${hidden.length} hidden) <a id="hide-unhide" href="#unhide">unhide</a>`,document.getElementById("hide-unhide").addEventListener("click",unhide),s.style.opacity=1,t=setInterval((function(){let e=Number(s.style.opacity);e>0?(e-=.1,s.style.opacity=e):(clearInterval(t),s.style.display="none")}),50)},revealBrand=function(e){sel_brand.innerHTML="4TREATMENTS",flashBrand()},clearQ=function(e){sel_q.value="",sel_refreshCache.checked=!1,e.stopPropagation(),e.preventDefault()},flashBrand=function(){setTimeout((function(){sel_brand.innerHTML="4T"}),2e3)},show=e=>{e.classList.remove("hide"),e.classList.add("show")},hide=e=>{e.classList.remove("show"),e.classList.add("hide")},toggle=function(e){const t=e.target,s=t.href?t.href.split("/").pop().split(".")[0]:t.id;let i=document.getElementById(s+"-target");if("index"===s&&gridIsVisible&&(i=sel_gridTarget),i.classList.contains("modal"))sel_modals.forEach((e=>hide(e))),i.classList.contains("hide")?(sel_gridTarget.classList.contains("show")&&(gridIsVisible=!0,hide(sel_gridTarget)),show(i)):i.classList.contains("show")&&(hide(i),(gridIsVisible=!0)&&sel_gridTarget.classList.contains("hide")&&(gridIsVisible=!1,show(sel_gridTarget)));else{const e=document.getElementById(s);e.classList.contains("unchecked")?(e.classList.remove("unchecked"),e.classList.add("checked"),sel_refreshCache.checked=!0,show(i)):(e.classList.remove("checked"),e.classList.add("unchecked"),sel_refreshCache.checked=!1,hide(i))}e.stopPropagation(),e.preventDefault()},listen=function(){sel_q.addEventListener("focus",(function(){sel_q.placeholder="search for something",sel_q.classList.remove("red-placeholder")})),sel_go.addEventListener("click",go),sel_clearQ.addEventListener("click",clearQ),sel_refreshCache.addEventListener("click",toggle),sel_modalOpen.forEach((e=>{e.addEventListener("click",toggle)})),sel_modalClose.forEach((e=>{e.addEventListener("click",toggle)})),sel_brand.addEventListener("click",revealBrand)},extractParamsAndHash=e=>{const t=e.searchParams;log.info(t.toString());const s=t.has("page")?t.get("page"):1,i=t.has("size")?t.get("size"):30;t.delete("page"),t.delete("size");const r=decodeURIComponent(t.toString()),n=e.hash.slice(1).split("&").reduce(((e,t)=>{const s=t.split("=");return e[s[0]]=s[1],e}),{});return{queryObj:t,queryString:r,page:s,size:i,fp:n.fp?n.fp:1,fs:n.fs?n.fs:30}},loadPage=function(){const e=new URL(location),{queryObj:t,queryString:s,page:i,size:r,fp:n,fs:a}=extractParamsAndHash(e);fillForm(t),getResource({resource:"treatments",queryString:s,page:i,size:r,fp:n,fs:a})};
"use strict";const PAGER_LENGTH=9,SEP="â€¢â€¢â€¢",SEPPOS1=2,SEPPOS2=6,range=(e,t,s)=>{const r=e*t+1;let a=r+t-1;return a>=s&&(a=s),[r,a]},_pager=({total:e,subtotal:t,queryString:s,page:r,size:a,fp:n,fs:l,resource:i,subresource:p,htmlElement:o})=>{r=parseInt(r),a=parseInt(a),n=parseInt(n),l=parseInt(l);const u=Math.ceil(e/(a||SIZE)),c=[];if(u<=9)for(let t=0;t<u;t++){const[s,p]=range(t,a,e),o=t+1;let u=!1;"treatments"===i?o===r&&(u=!0):"figures"===i&&o===n&&(u=!0),c.push({cp:u,page:o,page_link:"treatments"===i?o:r,size:a,fp:"treatments"===i?n:o,fs:l,from:s,to:p,sep1:!1,sep2:!1})}else{for(let t=0;t<u;t++){const[s,p]=range(t,a,e),o=t+1;let u=!1;"treatments"===i?o===r&&(u=!0):"figures"===i&&o===n&&(u=!0),c.push({cp:u,page:o,page_link:"treatments"===i?o:r,size:a,fp:"treatments"===i?n:o,fs:l,from:s,to:p,sep1:!1,sep2:!1})}let t,s;const p="treatments"===i?r:n;p<6&&(t=6,s=u-2-t,c.splice(t,s,{sep2:!0})),p>=6&&p<u-4&&(t=2,s=p-4,c.splice(t,s,{sep1:!0}),t=6,s=u-9-(p-t),c.splice(t,s,{sep2:!0})),p>=u-4&&(t=2,s=u-8,c.splice(t,s,{sep1:!0}))}outputPager({resource:i,page_list:c,queryString:s,page:r,size:a,fp:n,fs:l,htmlElement:o})},pager=({total:e,subtotal:t,queryString:s,page:r,size:a,fp:n,fs:l,resource:i,subresource:p,htmlElement:o})=>{if("treatments"===i)outputResult({total:e,subtotal:t,page:r,size:a,fp:n,fs:l,resource:i,subresource:p,htmlElement:o}),e>0&&t>0&&_pager({total:e,subtotal:t,queryString:s,page:r,size:a,fp:n,fs:l,resource:i,subresource:p,htmlElement:o});else if("figures"===i&&e>0){_pager({total:e,subtotal:t,queryString:s,page:r,size:a,fp:n,fs:l,resource:i,subresource:p,htmlElement:o});o.querySelectorAll(".pager a").forEach((e=>{e.addEventListener("click",figPageClick)}))}},outputPager=({resource:e,page_list:t,queryString:s,page:r,size:a,fp:n,fs:l,htmlElement:i})=>{O.globals.ocellus4tUri;const p=new URLSearchParams(s),o=t.map((e=>{let t;if(e.cp)t=`<div class="cp pager-cell"><span class="range">${e.from}â€“${e.to}</span></div>`;else if(e.sep1||e.sep2)t='<div class="sep pager-cell"><span>â€¢â€¢â€¢</span></div>';else{p.set("page",e.page_link),p.set("size",a),p.sort();t=`<div class="p pager-cell"><a href="?${decodeURIComponent(p.toString())}#fp=${e.fp}&fs=${e.fs}"><span class="range">${e.from}â€“${e.to}</span></a></div>`}return t}));if(o.length<9)for(let e=0,t=9-o.length;e<t;e++)o.push('<div class="e pager-cell"></div>');o.unshift(`<div class="header pager-cell">${e}</div>`),i.innerHTML=o.join("")},outputResult=({total:e,subtotal:t,page:s,size:r,fp:a,fs:n,htmlElement:l,resource:i,subresource:p})=>{let o;if(r=parseInt(r),0==e)o="No treatments found.";else if(o=`Found ${niceNumbers(e)} treatments`,0==t)o+=", but no related figures found. Please search again.";else{const t=(s-1)*r+1,a=t+r-1;let n=r;a>e&&(n=e-t+1),o+=a>e?`, showing the figures from the last ${niceNumbers(n)} treatments.`:`, showing the figures from the ${nth(s)} batch of ${niceNumbers(n)} treatments.`}sel_searchResults.innerHTML=o},nth=function(e){if(isNaN(e)||e%1)return e;const t=e%100;if(t>3&&t<21)return e+"th";switch(t%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd";default:return e+"th"}},niceNumbers=e=>e<10?["One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][e-1].toLowerCase():e;