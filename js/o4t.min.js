"use strict";const sel_throbber=document.getElementById("throbber"),sel_gridTarget=document.getElementById("grid-target"),sel_grid=document.getElementById("grid"),sel_puff=document.getElementById("puff"),sel_q=document.getElementById("q"),sel_brand=document.getElementById("brand"),sel_refreshCacheMsg=document.getElementById("refreshCacheMsg"),sel_about=document.getElementById("about"),sel_go=document.getElementById("go"),sel_clearQ=document.getElementById("clearQ"),sel_refreshCache=document.getElementById("refreshCache"),sel_imgSwap=document.querySelectorAll("input[name=imgSize]"),sel_modals=document.querySelectorAll(".modal"),sel_modalOpen=document.querySelectorAll(".modal-open"),sel_modalClose=document.querySelectorAll(".modal-close"),sel_palette=document.getElementById("palette"),sel_count=document.getElementById("count"),sel_pager=document.getElementById("pager"),sel_searchResults=document.getElementById("search-results"),sel_treatmentsPager=document.getElementById("treatments-pager"),sel_figuresPager=document.getElementById("figures-pager"),sel_treatmentDetails=document.getElementById("treatmentDetails"),sel_hiddenFigures=document.getElementById("hidden-figures"),unhide=()=>{hidden.forEach((e=>{e.style.opacity=1,e.style.display="block"})),hidden.splice(0),sel_hiddenFigures.innerHTML=""},RESULTS={countOfTreatments:0,currentBatch:0,pagesOfTreatments:0,_links:{self:"",prev:"",next:""},countOfFigures:0,figures:[],pagesOfFigures:0},PAGE=1,SIZE=30,FIGPAGE=1,FIGSIZE=30;let gridIsVisible=!1;const updateUrl=({queryString:e,page:t,size:s,fp:r,fs:n})=>{const i=new URLSearchParams(e);i.set("$page",t),i.set("$size",s),i.sort();const a=i.toString();history.pushState({},"",`4t.html?${decodeURIComponent(a)}#fp=${r}&fs=${n}`)},showPage=function({queryString:e,page:t,size:s,fp:r,fs:n}){const i=(r-1)*(s=parseInt(s));let a=i+s;a>=RESULTS.countOfFigures&&(a=RESULTS.countOfFigures);const l=RESULTS.figures.slice(i,a).join("");updateUrl({queryString:e,page:t,size:s,fp:r,fs:n}),sel_grid.innerHTML=l,sel_gridTarget.classList.contains("hide")&&(sel_gridTarget.classList.remove("hide"),sel_gridTarget.classList.add("show"));document.querySelectorAll("div.close").forEach((e=>{e.addEventListener("click",smoke)}));document.querySelectorAll("figcaption > a").forEach((e=>{e.addEventListener("click",toggleFigcaption)}));document.querySelectorAll(".showTreatment").forEach((e=>{e.addEventListener("click",showTreatment)})),sel_throbber.classList.add("nothrob")},toggleFigcaption=function(e){document.querySelectorAll("figcaption div.desc").forEach((e=>{e.classList.remove("show"),e.classList.add("hide")}));const t=e.currentTarget.parentNode.querySelector(".desc");t.classList.remove("hide"),t.classList.add("show")},onlyUnique=function(e,t,s){return s.indexOf(e)===t};function getRandomInt(e){return Math.floor(Math.random()*Math.floor(e))}const grid=function(e,t){const s=`${zenodoUri}/${t.id}/thumb${e}`,r=getRandomInt(300);return`<figure class="figure-${e}">\n    <div class="switches">\n        <div class="close"></div>\n    </div>\n    <picture>\n        <img src="../img/bug.gif" data-src="${s}" class="lazyload" data-recid="${t.id}">\n    \x3c!-- <img src="../img/bug.gif" data-src="../img/i250.jpg" class="lazyload" data-recid="${t.id}"> --\x3e\n    \x3c!-- <div style="width: 250px; height:${r}px;">250px x ${r}px</div> --\x3e\n    </picture>\n    <figcaption>\n        <a class="transition-050">rec ID: ${t.id}</a>\n        <div class="desc hide">\n            ${t.captionText}. \n            <a class='showTreatment' href='${zenodeo3Uri}/treatments?treatmentId=${t.treatmentId}'>more</a>\n        </div>\n    </figcaption>\n</figure>`},closeLightbox=()=>sel_treatmentDetails.classList.add("hidden"),foo=async function(e){const t=await fetch(e);if(t.ok){const e=await t.json(),s=e.item.records[0],r=e.item["related-records"].figureCitations.records.map((e=>`<img src ="${zenodoUri}/${e.httpUri.split("/")[4]}/thumb50">`));let n=`<h2>${s.treatmentTitle}</h2>`;n+=`<div class="figs">${r.join(" ")}</div>`,n+='<div class="cite">',s.authorityName&&(n+=s.authorityName+". "),s.authorityYear&&(n+=s.authorityYear+". "),s.articleTitle&&(n+=s.articleTitle+". "),s.journalTitle&&(n+=""+s.journalTitle),s.journalYear&&(n+=s.journalYear+", "),s.journalVolume&&(n+=`vol. ${s.journalVolume}, `),s.journalIssue&&(n+=s.journalIssue+", "),s.pages&&(n+="pp. "+s.pages),n+="</div>",s.status&&(n+=`<div class="status"><b>status:</b> ${s.status}</div>`),n+='<ul class="classification">',s.kingdom&&(n+=`<li class="${"kingdom"===s.rank?"rank":""}">${s.kingdom}</li>`),s.phylum&&(n+=`<li class="${"phylum"===s.rank?"rank":""}">${s.phylum}</li>`),s.order&&(n+=`<li class="${"order"===s.rank?"rank":""}">${s.order}</li>`),s.family&&(n+=`<li class="${"family"===s.rank?"rank":""}">${s.family}</li>`),s.genus&&(n+=`<li class="${"genus"===s.rank?"rank":""}">${s.genus}</li>`),s.species&&(n+=`<li class="${"species"===s.rank?"rank":""}">${s.species}</li>`),n+="</ul>",sel_treatmentDetails.querySelector("div.text").innerHTML=n,sel_treatmentDetails.classList.remove("hidden")}else alert("HTTP-Error: "+t.status)},showTreatment=async function(e){const t=e.target.href;foo(t),e.stopPropagation(),e.preventDefault()},fillForm=function(e){let t,s;e.has("$page")&&(t=e.get("$page"),e.delete("$page")),e.has("$size")&&(s=e.get("$size"),e.delete("$size")),e.has("q")?Array.from(e.entries()).length>1?sel_q.value=decodeURIComponent(e.toString()):sel_q.value=e.get("q"):sel_q.value=decodeURIComponent(e.toString()),e.set("$size",t),e.set("$page",s)},figPageClick=function(e){const t=new URL(e.currentTarget.href),{queryObj:s,queryString:r,page:n,size:i,fp:a,fs:l}=extractParamsAndHash(t);RESULTS.countOfTreatments>0&&RESULTS.countOfFigures>0&&pager({total:RESULTS.countOfFigures,subtotal:"",queryString:r,page:n,size:i,fp:a,fs:l,resource:"figures",subresource:"",htmlElement:sel_figuresPager}),showPage({queryString:r,page:n,size:i,fp:a,fs:l}),e.stopPropagation(),e.preventDefault()},go=function(e){const t=sel_q.value;if(""===t)sel_q.placeholder="câ€™mon, enter something",sel_q.classList.add("red-placeholder");else{sel_q.classList.remove("red-placeholder"),sel_throbber.classList.remove("nothrob");const e=[t.indexOf("=")>-1?t:"q="+t];res({resource:"treatments",queryString:e.join("&"),page:1,size:30,fp:1,fs:30})}e.stopPropagation(),e.preventDefault()},res=async function({resource:e,queryString:t,page:s,size:r,fp:n,fs:i}){let a=`${zenodeo3Uri}/${e.toLowerCase()}`;t&&(a+="?"+t);const l=await fetch(a);if(l.ok){const a=await l.json(),o=a.item.records;if("treatments"===e){RESULTS.countOfTreatments=a.item.count,RESULTS._links.self=a.item._links.self.href,RESULTS._links.prev=a.item._links.prev.href,RESULTS._links.next=a.item._links.next.href;then_t({records:o,queryString:t,page:s,size:r,fp:n,fs:i})}else if("figureCitations"===e)return then_f(o)}else alert("HTTP-Error: "+l.status)},then_t=function({records:e,queryString:t,page:s,size:r,fp:n,fs:i}){Promise.all(e.map((e=>res({resource:"figureCitations",queryString:"treatmentId="+e.treatmentId,page:s,size:r,fp:n,fs:i})))).then((e=>{e.forEach((e=>{void 0!==e&&e.length&&RESULTS.figures.push(...e)})),RESULTS.countOfFigures=RESULTS.figures.length,pager({total:RESULTS.countOfTreatments,subtotal:RESULTS.countOfFigures,queryString:t,page:s,size:r,fp:n,fs:i,resource:"treatments",subresource:"figures",htmlElement:sel_treatmentsPager}),RESULTS.countOfTreatments>0&&RESULTS.countOfFigures>0&&pager({total:RESULTS.countOfFigures,subtotal:"",queryString:t,page:s,size:r,fp:n,fs:i,resource:"figures",subresource:"",htmlElement:sel_figuresPager}),showPage({queryString:t,page:s,size:r,fp:n,fs:i})}))},then_f=function(e){if(e.length){e=e.filter((e=>""!==e.httpUri));const t=[],s=new Map;for(const r of e)s.has(r.httpUri)||(s.set(r.httpUri,!0),t.push(grid(250,{id:r.httpUri.split("/")[4],httpUri:r.httpUri,captionText:r.captionText,treatmentId:r.treatmentId})));return t}},init=function(){listen(),flashBrand(),loadPage()},smokeWorks=function(e){sel_puff.style.left=e.pageX-24+"px",sel_puff.style.top=e.pageY-24+"px",sel_puff.style.display="inline",sel_puff.style.visibility="visible",sel_puff.style.opacity=1,animatePoof();const t=e.currentTarget.parentNode.parentNode;t.style.opacity=1,intervalId=setInterval((function(){let e=Number(t.style.opacity);e>0?(e-=.1,t.style.opacity=e):(clearInterval(intervalId),t.style.display="none")}),50)},hidden=[],smoke=function(e){let t=0;sel_puff.style.left=e.pageX-24+"px",sel_puff.style.top=e.pageY-24+"px",sel_puff.style.display="inline",sel_puff.style.visibility="visible",sel_puff.style.opacity=1,function(){let e=0,t=0;!function s(){t<6&&(sel_puff.style.backgroundPosition="0 "+e+"px",e-=32,t++,setTimeout(s,80))}()}();const s=e.currentTarget.parentNode.parentNode;hidden.push(s),sel_hiddenFigures.innerHTML=` (${hidden.length} hidden) <a id="hide-unhide" href="#unhide">unhide</a>`,document.getElementById("hide-unhide").addEventListener("click",unhide),s.style.opacity=1,t=setInterval((function(){let e=Number(s.style.opacity);e>0?(e-=.1,s.style.opacity=e):(clearInterval(t),s.style.display="none")}),50)},revealBrand=function(e){sel_brand.innerHTML="4TREATMENTS",flashBrand()},clearQ=function(e){sel_q.value="",sel_refreshCache.checked=!1,e.stopPropagation(),e.preventDefault()},flashBrand=function(){setTimeout((function(){sel_brand.innerHTML="4T"}),2e3)},show=e=>{e.classList.remove("hide"),e.classList.add("show")},hide=e=>{e.classList.remove("show"),e.classList.add("hide")},toggle=function(e){const t=e.target,s=t.href?t.href.split("/").pop().split(".")[0]:t.id;let r=document.getElementById(s+"-target");if("index"===s&&gridIsVisible&&(r=sel_gridTarget),r.classList.contains("modal"))sel_modals.forEach((e=>hide(e))),r.classList.contains("hide")?(sel_gridTarget.classList.contains("show")&&(gridIsVisible=!0,hide(sel_gridTarget)),show(r)):r.classList.contains("show")&&(hide(r),(gridIsVisible=!0)&&sel_gridTarget.classList.contains("hide")&&(gridIsVisible=!1,show(sel_gridTarget)));else{const e=document.getElementById(s);e.classList.contains("unchecked")?(e.classList.remove("unchecked"),e.classList.add("checked"),sel_refreshCache.checked=!0,show(r)):(e.classList.remove("checked"),e.classList.add("unchecked"),sel_refreshCache.checked=!1,hide(r))}e.stopPropagation(),e.preventDefault()},listen=function(){sel_q.addEventListener("focus",(function(){sel_q.placeholder="search for something",sel_q.classList.remove("red-placeholder")})),sel_go.addEventListener("click",go),sel_clearQ.addEventListener("click",clearQ),sel_refreshCache.addEventListener("click",toggle),sel_modalOpen.forEach((e=>{e.addEventListener("click",toggle)})),sel_modalClose.forEach((e=>{e.addEventListener("click",toggle)})),sel_brand.addEventListener("click",revealBrand)},extractParamsAndHash=e=>{const t=e.searchParams,s=t.has("$page")?t.get("$page"):1,r=t.has("$size")?t.get("$size"):30;t.delete("$page"),t.delete("$size");const n=decodeURIComponent(t.toString()),i=e.hash.slice(1).split("&").reduce(((e,t)=>{const s=t.split("=");return e[s[0]]=s[1],e}),{});return{queryObj:t,queryString:n,page:s,size:r,fp:i.fp?i.fp:1,fs:i.fs?i.fs:30}},loadPage=function(){const e=new URL(location),{queryObj:t,queryString:s,page:r,size:n,fp:i,fs:a}=extractParamsAndHash(e);fillForm(t),res({resource:"treatments",queryString:s,page:r,size:n,fp:i,fs:a})};
"use strict";const PAGER_LENGTH=9,SEP="â€¢â€¢â€¢",SEPPOS1=2,SEPPOS2=6,range=(e,s,t)=>{const r=e*s+1;let a=r+s-1;return a>=t&&(a=t),[r,a]},_pager=({total:e,subtotal:s,queryString:t,page:r,size:a,fp:n,fs:p,resource:l,subresource:o,htmlElement:u})=>{r=parseInt(r),a=parseInt(a),n=parseInt(n),p=parseInt(p);const i=Math.ceil(e/(a||SIZE)),c=[];if(i<=9)for(let s=0;s<i;s++){const[t,o]=range(s,a,e),u=s+1;let i=!1;"treatments"===l?u===r&&(i=!0):"figures"===l&&u===n&&(i=!0),c.push({cp:i,page:u,page_link:"treatments"===l?u:r,size:a,fp:"treatments"===l?n:u,fs:p,from:t,to:o,sep1:!1,sep2:!1})}else{for(let s=0;s<i;s++){const[t,o]=range(s,a,e),u=s+1;let i=!1;"treatments"===l?u===r&&(i=!0):"figures"===l&&u===n&&(i=!0),c.push({cp:i,page:u,page_link:"treatments"===l?u:r,size:a,fp:"treatments"===l?n:u,fs:p,from:t,to:o,sep1:!1,sep2:!1})}let s,t;const o="treatments"===l?r:n;o<6&&(s=6,t=i-2-s,c.splice(s,t,{sep2:!0})),o>=6&&o<i-4&&(s=2,t=o-4,c.splice(s,t,{sep1:!0}),s=6,t=i-9-(o-s),c.splice(s,t,{sep2:!0})),o>=i-4&&(s=2,t=i-8,c.splice(s,t,{sep1:!0}))}outputPager({resource:l,page_list:c,queryString:t,page:r,size:a,fp:n,fs:p,htmlElement:u})},pager=({total:e,subtotal:s,queryString:t,page:r,size:a,fp:n,fs:p,resource:l,subresource:o,htmlElement:u})=>{if("treatments"===l)outputResult({total:e,subtotal:s,page:r,size:a,fp:n,fs:p,htmlElement:u,resource:l,subresource:o}),e>0&&s>0&&_pager({total:e,subtotal:s,queryString:t,page:r,size:a,fp:n,fs:p,resource:l,subresource:o,htmlElement:u});else if("figures"===l&&e>0){_pager({total:e,subtotal:s,queryString:t,page:r,size:a,fp:n,fs:p,resource:l,subresource:o,htmlElement:u});u.querySelectorAll(".pager a").forEach((e=>{e.addEventListener("click",figPageClick)}))}},outputPager_div=({page_list:e,queryString:s,page:t,size:r,fp:a,fs:n,htmlElement:p,resource:l})=>{const o=`${ocellus4tUri}?${s}`,u=e.map((e=>{let s;return s=e.cp?`<div class="cp"><span class="p">${e.page}</span><span class="range">${e.from}â€“${e.to}</span></div>`:e.sep1||e.sep2?'<div class="sep"><span>â€¢â€¢â€¢</span></div>':`<div><a href="${o}&$page=${e.page_link}&$size=${r}#fp=${e.fp}&fs=${e.fs}"><span class="p">${e.page}</span><span class="range">${e.from}â€“${e.to}</span></a></div>`,s})).join("");p.querySelector(".pager").innerHTML=u},outputPager=({resource:e,page_list:s,queryString:t,page:r,size:a,fp:n,fs:p,htmlElement:l})=>{const o=ocellus4tUri,u=new URLSearchParams(t),i=s.map((e=>{let s;if(e.cp)s=`<td class="cp"><span class="p">${e.page}</span><span class="range">${e.from}â€“${e.to}</span></td>`;else if(e.sep1||e.sep2)s='<td class="sep"><span>â€¢â€¢â€¢</span></td>';else{u.set("$page",e.page_link),u.set("$size",a),u.sort();const t=decodeURIComponent(u.toString());s=`<td class="p"><a href="${o}?${t}#fp=${e.fp}&fs=${e.fs}"><span class="p">${e.page}</span><span class="range">${e.from}â€“${e.to}</span></a></td>`}return s}));if(i.length<9)for(let e=0,s=9-i.length;e<s;e++)i.push('<td class="e"></td>');i.unshift(`<th>${e}</th>`),l.innerHTML=i.join("")},outputResult=({total:e,subtotal:s,page:t,size:r,fp:a,fs:n,htmlElement:p,resource:l,subresource:o})=>{let u;if(r=parseInt(r),0==e)u="No treatments found.";else if(u=`Found ${niceNumbers(e)} treatments`,0==s)u+=", but no related figures found. Please search again.";else{const s=(t-1)*r+1,a=s+r-1;let n=r;a>e&&(n=e-s+1),u+=a>e?`, showing the figures from the last ${niceNumbers(n)} treatments.`:`, showing the figures from the ${nth(t)} batch of ${niceNumbers(n)} treatments.`}sel_searchResults.innerHTML=u},outputResult_old=({total:e,subtotal:s,page:t,size:r,fp:a,fs:n,htmlElement:p,resource:l,subresource:o,showResults:u})=>{let i;if(0==e)i=`No ${l} found.`;else if(i=`Found ${niceNumbers(e)} ${l}`,"treatments"===l&0==s)i+=`, but no related ${o} found. Please search again.`;else{i+=`. Showing results from the ${nth("treatments"===l?t:a)} ${niceNumbers(r)} ${l} below.`}p.querySelector(".search-results").innerHTML=i},nth=function(e){if(isNaN(e)||e%1)return e;const s=e%100;if(s>3&&s<21)return e+"th";switch(s%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd";default:return e+"th"}},niceNumbers=e=>e<10?["One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][e-1].toLowerCase():e;