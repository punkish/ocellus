/* generated: Wed Oct 23 2024 17:01:03 GMT+0200 (Central European Summer Time) */
import{cellArea as e,UNITS as t,cellToBoundary as o}from"https://cdn.jsdelivr.net/npm/h3-js@4.1.0/+esm";const i=e=>document.querySelector(e),a=e=>document.querySelectorAll(e);const n={fetchOpts:{},uri:function(){const e="ocellus.localhost"===window.location.hostname,t="ocellus.local"===window.location.hostname,o="127.0.0.1"===window.location.hostname,i="localhost"===window.location.hostname;let a="https://test.zenodeo.org/v3",n="https://maps.zenodeo.org";return(e||t||o||i)&&(a=`http://${window.location.hostname}:3010/v3`,n=`http://${window.location.hostname}:3000`),{zenodeo:a,maps:n,zenodo:"https://zenodo.org",treatmentBank:"https://tb.plazi.org/GgServer/html"}}(),cache:{images:{yearlyCounts:!1,totals:!1},treatments:{yearlyCounts:!1,totals:!1},journals:null,collectionCodes:null,bins:{}},figureSize:{normal:250,small:100,tiny:50},defaultPlaceholder:"search images",results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],params:{notValidQ:["resource","page","size","grid","refreshCache","cols"],validImages:["httpUri","caption","captionText","q","treatmentId","treatmentTitle","articleTitle","treatmentDOI","articleDOI","zenodoDep","authorityName","collectionCode","status","journalTitle","journals_id","journalYear","kingdom","phylum","class","family","order","genus","species","publicationDate","checkinTime","latitude","longitude","geolocation","isOnLand","validGeo","eco_name","biome","biome_id"],validTreatments:["treatmentId","treatmentTitle","treatmentDOI","zenodoDep","articleTitle","articleDOI","publicationDate","journalYear","authorityName","status","checkinTime","validGeo","q","latitude","longitude","geolocation","eco_name","biome","isOnLand","journalTitle","kingdom","phylum","class","family","order","genus","species"],validCommon:["refreshCache","page","size","cols","groupby"],notValidSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit","source","grid"]},cols:{images:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","httpUri","caption","latitude","longitude"],treatments:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","journalTitle","latitude","longitude"]},maps:{},hiddenClasses:["hidden","noblock"],closedFigcaptionHeight:"30px",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],markerIcons:{default:L.icon({iconUrl:"/img/marker.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[11,37]}),active:L.icon({iconUrl:"/img/marker-active.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]}),clicked:L.icon({iconUrl:"/img/marker-clicked.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]})},months:["January","February","March","April","May","June","July","August","September","October","November","December"],charts:{termFreq:null,yearlyCounts:null}};async function r(i,a){if("imageMarkerClusters"in a&&i.hasLayer(a.imageMarkerClusters)&&(log.info("removing image marker clusters"),i.removeLayer(a.imageMarkerClusters),a.slidebar.remove()),"h3"in a)i.hasLayer(a.h3)||(log.info("re-adding existing h3 layer"),i.addLayer(a.h3),a.h3info.addTo(i));else{log.info("initializing h3 layer");const r=await async function(i){const a=`${n.uri.zenodeo}/bins/${i}`,r=await fetch(a,n.fetchOpts);if(r.ok){const i={type:"FeatureCollection",features:[]},a=["81033ffffffffff","83f293fffffffff"],n=await r.json();a.forEach((e=>delete n[e]));for(const[a,r]of Object.entries(n)){const n=Math.round(e(a,t.km2)),s={type:"Feature",properties:{numOfTreatments:r,area:n,density:r/n},geometry:{type:"Polygon",coordinates:[o(a).map((e=>[e[1],e[0]]))]}};i.features.push(s)}return s(i),i}alert("HTTP-Error: "+r.status)}(3),l=r.features.map((e=>e.properties.density)),c=1/Math.min(...l),h=function({data:e,scaleFactor:t,colorRamp:o,typeOfBins:i}){const a=o.length,n=[];if("equalWidth"===i){const t=Object.values(e);t.reduce(((e,t)=>e+t));const i=Math.max(...t)+1,r=Math.min(...t),s=(i-r)/a;let l=0;for(let e=r;e<i;e+=s){const t=e+s,i=o[l];n.push({from:Math.round(e),to:Math.round(t),fillColor:i,num:0}),l++}n.forEach((t=>{t.num=Object.values(e).filter((e=>e>=t.from&&e<t.to)).length}))}else if("equalFreq"===i){const i=Object.keys(e).length,r=Math.round(i/a),s=[];for(const[o,i]of Object.entries(e))s.push({id:o,num:Math.round(i*t)});const l=s.sort(((e,t)=>e.num-t.num));for(let e=0;e<a;e++){const t=e*r,i=t+r,a=l.slice(t,i),s=a[0].num,c=a[a.length-1].num;n[e]={from:s,to:c,fillColor:o[e],num:a.length}}}return n}({data:l,scaleFactor:c,colorRamp:n.H3ColorRamp,typeOfBins:"equalFreq"}),d=function(e){let t="#f5f5f5",o=0;const i=e.properties.density*c;return i>0&&(t=function(e,t){for(let o=0,i=t.length;o<i;o++)if(e>=t[o].from&&e<t[o].to)return t[o].fillColor}(i,h),o=.7),{fillColor:t,color:"grey",weight:0,fillOpacity:o}};a.h3=L.geoJSON(r,{style:d,onEachFeature:(e,t)=>{t.on({mouseover:e=>{!function({mapLayers:e,bin:t}){t.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.1}),L.Browser.ie||L.Browser.opera||L.Browser.edge||t.bringToFront();e.h3info.update(t.feature.properties)}({mapLayers:a,bin:e.target})},mouseout:e=>{!function({mapLayers:e,bin:t}){e.h3.resetStyle(t),e.h3info.update()}({mapLayers:a,bin:e.target})}})}}),i.addLayer(a.h3),function(e,t){const o=L.control(),i="Hover over a bin to see num of images";o.onAdd=function(e){return this._div=L.DomUtil.create("div","h3info"),this._div.innerHTML=i,this._div},o.update=function(e){this._div.innerHTML=e?`${e.numOfTreatments} treatments in ${e.area} km<sup>2</sup>`:i},t.h3info=o,o.addTo(e)}(i,a)}}function s(e){const{type:t}=e;if("FeatureCollection"===t)return void e.features.map(s);const{type:o,coordinates:i}=e.geometry;switch(o){case"LineString":return void l(i);case"Polygon":return void c(i);case"MultiPolygon":return void i.forEach((e=>c(e)));default:throw new Error(`Unknown geometry type: ${o}`)}}function l(e){let t=!1;for(let o=0;o<e.length;o++)if(Math.abs(e[0][0]-e[(o+1)%e.length][0])>180){t=!0;break}t&&e.forEach((e=>function(e){const t=e[0];e[0]=t<0?t+360:t}(e)))}function c(e){e.forEach((e=>l(e)))}const h=L.Control.extend({options:{content:"<i>Click on a marker for more info</i>",state:"full",threshold:50,doubleThreshold:200},initialize:function(e){return L.Util.setOptions(this,e),this.on("swipeup",(function(e){let t;if(e.value>this.options.doubleThreshold)t="full";else switch(this._size){case"closed":t="quarter";break;case"quarter":t="half";break;case"half":t="full"}this.toggleSize(t)})),this.on("swipedown",(function(e){let t;if(e.value>this.options.doubleThreshold)t="closed";else switch(this._size){case"full":t="half";break;case"half":t="quarter";break;case"quarter":t="closed"}this.toggleSize(t)})),this},toggleSize:function(e){const t=document.querySelector("#leaflet-slidebar");if(t.classList.contains(e));else{["closed","quarter","half","full"].forEach((e=>t.classList.remove(e))),t.classList.add(e),this._size=e}this.reCenter(this._newCenter)},onAdd:function(e){if(!this._div){this._div=L.DomUtil.create("div","leaflet-slidebar"),this._div.classList.add(this.options.state),this._div.id="leaflet-slidebar",this._size=this.options.state;const e=L.DomUtil.create("nav","",this._div);L.DomUtil.create("hr","",e);const t=L.DomUtil.create("button","close-btn",e),o=e=>this.toggleSize("closed");L.DomEvent.on(t,"click",o,this),L.DomEvent.on(t,"touchend",o,this),L.DomUtil.create("main","",this._div)}return this._div},onRemove:function(e){return this},reCenter:function(){const e=this._map.latLngToLayerPoint(this._newCenter),t=[],{min:o,max:i}=this._map.getPixelBounds();if(document.body.clientWidth<400){const a=i.y-o.y;let n=0;"full"===this._size?n=.375:"half"===this._size?n=.25:"quarter"===this._size&&(n=.125),t.push(e.x,e.y+n*a)}else t.push(e.x,e.y);const a=this._map.layerPointToLatLng(t);this._map.flyTo(a)},update:async function({content:e,latlng:t}){return this._div.querySelector("#leaflet-slidebar main").innerHTML=e,this._newCenter=t,this.toggleSize("full"),this},addTo:function(e){return this.onRemove(),this._map=e,this._container=this.onAdd(e),L.DomUtil.addClass(this._container,"leaflet-slidebar"),L.Browser.touch&&L.DomUtil.addClass(this._container,"leaflet-touch"),L.DomEvent.disableScrollPropagation(this._container),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"contextmenu",L.DomEvent.stopPropagation),L.DomEvent.on(this._container,"touchstart",this._startSwipe,this),L.DomEvent.on(this._container,"touchend",this._endSwipe,this),e._container.insertBefore(this._container,e._container.firstChild),this},_startSwipe:function(e){const t=e.touches&&e.touches[0];t&&this._map&&(e.target&&"A"==e.target.tagName||(this._startPoint=this._map.mouseEventToContainerPoint(t),L.DomEvent.preventDefault(e)))},_endSwipe:function(e){const t=e.changedTouches&&e.changedTouches[0];if(!t||!this._startPoint||!this._map)return;const o=this._map.mouseEventToContainerPoint(t).subtract(this._startPoint),i=Math.abs(o.x),a=Math.abs(o.y);if(this._startPoint=null,i<this.options.threshold&&a<this.options.threshold)return;if(i/a>.5&&i/a<2)return;let n,r;i>a?(r=i,n=o.x<0?"left":"right"):(r=a,n=o.y<0?"up":"down"),this.fire("swipe"+n,{direction:n,value:r})}});async function d(e,t){const o=i("#throbber");o.classList.remove("nothrob");const a=e.getBounds(),r=await async function(e){const t=e.getSouthWest().lat,o=e.getSouthWest().lng,i=e.getNorthEast().lat,a=e.getNorthEast().lng,r=`${n.uri.zenodeo}/images?geolocation=within(min_lat:${t},min_lng:${o},max_lat:${i},max_lng:${a})&cols=treatmentId&cols=treatmentTitle&cols=latitude&cols=longitude&size=5000`,s=await fetch(r,n.fetchOpts);if(s.ok)return(await s.json()).item.result.records;alert("HTTP-Error: "+s.status)}(a);if(r){t.imageMarkerClusters||(t.imageMarkerClusters=L.markerClusterGroup({disableClusteringAtZoom:10}));const i=[];r.forEach((a=>{const r=a.images_id;if(!t.imageMarkers.has(r)){const s=a.treatmentId,l={title:s,icon:n.markerIcons.default},c=new L.LatLng(a.latitude,a.longitude),h=L.marker(c,l);h.on("click",(async function(l){o.classList.remove("nothrob");const h=l.target;h.setIcon(n.markerIcons.active);const d=await async function(e){if(!e)return"Click on an image marker for more info";{const t=e.treatmentId,o=`${n.uri.zenodeo}/images?id=${e.images_id}&cols=httpUri&cols=caption`;let i=`<h3>${e.treatmentTitle}</h3>`;const a=await fetch(o,n.fetchOpts);if(a.ok){const e=(await a.json()).item.result.records[0],o=`<a href="${n.uri.treatmentBank}/${t}" target="_blank">more on TB</a>`;if(e.httpUri){const t=250,a=e.httpUri.split("/")[4];let r;r=e.httpUri.indexOf("zenodo")>-1?e.httpUri.indexOf(".svg")>-1?"/img/kein-preview.png":`${n.uri.zenodo}/api/iiif/record:${a}:figure.png/full/250,/0/default.jpg`:`${e.httpUri}/singlefigAOF/`,i+=`\n                <figure class="figure-${t}">\n                    <img src="../img/bug.gif" width="${t}" data-src="${r}" \n                        class="lazyload" data-recid="${a}">\n                    <figcaption>${e.captionText} ${o}</figcaption>\n                </figure>`}else i+=o;return i}}}(a);t.slidebar.update({content:d,latlng:c}),o.classList.add("nothrob");document.querySelector("#leaflet-slidebar").style.visibility="visible",function(e,t,o){const i=e.getCenter(),a=Math.round(1e5*i.lat)/1e5,n=Math.round(1e5*i.lng)/1e5,r=e.getZoom();let s=`#show=maps&lat=${a}&lng=${n}&zoom=${r}&treatmentId=${t}-${o}`;const l={zoom:r,center:{lat:a,lng:n}};window.history.pushState(l,"map",s)}(e,s,r),t.imageMarkerClusters.getVisibleParent(h);const m=i[i.length-1];m&&m.setIcon(n.markerIcons.clicked),i.push(h)})),t.imageMarkers.set(r,h),t.imageMarkerClusters.addLayer(h)}})),e.hasLayer(t.imageMarkerClusters)?log.info("used existing image marker clusters layer"):(log.info("re-adding existing image marker clusters"),e.addLayer(t.imageMarkerClusters))}o.classList.add("nothrob")}async function m(e,t,o){if("h3"in t&&e.hasLayer(t.h3)&&(log.info("removing h3 layer"),e.removeLayer(t.h3),t.h3info.remove()),"imageMarkerClusters"in t?(await d(e,t),t.slidebar.addTo(e)):(log.info("initializing image marker clusters"),function(e,t){t.slidebar=new h({state:"closed"}),t.slidebar.addTo(e)}(e,t),t.imageMarkers=new Map,await d(e,t)),o){const[e,i]=o.split("-"),a=t.imageMarkers.get(Number(i));a&&(t.imageMarkerClusters.zoomToShowLayer(a),a.fireEvent("click"))}}async function u({baseLayerSource:e,map:t}){const o={minZoom:1,maxZoom:17,zoomOffset:-1,tileSize:512};let i;if("arcgis"===e)o.attribution="&copy; ESRI",i=L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",o).addTo(t);else if("geodeo"===e){const e=`${n.uri.maps}/nev_raster/{z}/{x}/{y}`,o={ne_50m_admin_1_states_provinces_lakes:{maxZoom:2,tms:!0,styles:{weight:1,color:"blue",fillColor:"",fillOpacity:.5,fill:!0}},ne_50m_admin_0_countries:{maxZoom:2,tms:!0,styles:{weight:1,color:"#444",fillColor:"f5f5f5",fillOpacity:.25,fill:!0}},ne_10m_admin_1_sel:{maxZoom:5,tms:!0,styles:{weight:1,color:"#444",fillColor:"#f5f5f5",fillOpacity:.25,fill:!0}},nev:{maxNativeZoom:7,maxZoom:10,tms:!0,vectorTileLayerStyles:{playa:{stroke:!0,weight:1,color:"aliceblue",fillColor:"aliceblue",fillOpacity:.25,fill:!0},urban:{stroke:!0,weight:1,color:"bisque",fillColor:"bisque",fillOpacity:.25,fill:!0},water:{stroke:!0,weight:1,color:"black",fillColor:"lightblue",fillOpacity:.25,fill:!0},ice:function(e){return"glacier"===e.type?{weight:1,color:"white",fillColor:"white",fillOpacity:.45,fill:!0}:"ice_shelf"===e.type?{weight:1,color:"white",fillColor:"lightgrey",fillOpacity:.45,fill:!0}:void 0},river:{weight:1,color:"blue",fillColor:"",fillOpacity:1,fill:!1},railroad:{stroke:!0,weight:1,color:"brown"},road:{weight:1,color:"#ffcc00",fillColor:"",fillOpacity:1,fill:!1},country_label:{stroke:!1,fill:!1},state_label:{stroke:!1,fill:!1},marine_label:{stroke:!1,fill:!1},lake_label:{stroke:!1,fill:!1},place_label:{stroke:!1,fill:!1},airport_label:{stroke:!1,fill:!1},port_label:{stroke:!1,fill:!1},admin:function(e,t){const o=e.admin_level;return 0===o?{weight:1,color:"#444",fill:!1}:1===o?{weight:.5,color:"#444",fill:!1}:2===o?{weight:1,color:"#cf52d3",dashArray:"2, 6",fillColor:"green",fillOpacity:.25,fill:!0}:void 0}}},nev_raster:{maxZoom:15,tms:!0}};L.tileLayer(e,{maxNativeZoom:6,maxZoom:10,tms:!0}).addTo(t);const i="nev",a=o[i];L.vectorGrid.protobuf(`${n.uri.maps}/${i}/{z}/{x}/{y}`,a).addTo(t)}else if("gbif"===e){o.attribution='&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> / &copy; <a href="https://www.openmaptiles.org/copyright">OpenMapTiles</a>';const e=parseInt(window.devicePixelRatio)||1;i=L.tileLayer("https://tile.gbif.org/3857/omt/{z}/{x}/{y}@{r}x.png?style=gbif-natural".replace("{r}",e),o).addTo(t)}return i}async function f({mapContainer:e,baseLayerSource:t,drawControl:o}){if(n.maps[e])"map"===e&&(i("#not-map").classList.add("hidden"),i("#map").classList.remove("hidden"));else{const{zoom:a,lat:r,lng:s,treatmentId:l}=function({zoom:e,lat:t,lng:o,treatmentId:i}){const a=new URLSearchParams(window.location.hash.substring(1));return{zoom:e=parseInt(a.get("zoom"),10)||e,lat:t=parseFloat(a.get("lat"))||t,lng:o=parseFloat(a.get("lng"))||o,treatmentId:i=a.get("treatmentId")||i}}({zoom:5,lat:0,lng:0}),c=L.map(e).setView({lat:r,lng:s},a);!function(e){let t=!0;e.on("moveend",(function(){if(!t)return void(t=!0);const o=e.getCenter(),i=Math.round(1e5*o.lat)/1e5,a=Math.round(1e5*o.lng)/1e5,n=e.getZoom(),r=window.location.pathname.split(".").shift().substring(1);let s;"maps"===r?s=`#lat=${i}&lng=${a}&zoom=${n}`:"index"===r&&(s=`#show=maps&lat=${i}&lng=${a}&zoom=${n}`);const l=new URLSearchParams(window.location.hash.substring(1)).get("treatmentId")||void 0;l&&(s+=`&treatmentId=${l}`);const c={zoom:n,center:{lat:i,lng:a}};window.history.pushState(c,"map",s)})),window.addEventListener("popstate",(function(o){null!==o.state&&(e.setView(o.state.center,o.state.zoom),t=!1)}))}(c),n.maps[e]=c,c.attributionControl.setPrefix(""),c.on("moveend",(async function(e){await g(c,h)}));const h={baseLayer:u({baseLayerSource:t,map:c})};o&&function(e,t){t.drawControls=new L.FeatureGroup,function(e,t){e.hasLayer(t)||e.addLayer(t)}(e,t.drawControls);const o={position:"topleft",draw:{polyline:!1,polygon:!1,circle:{shapeOptions:{weight:1}},rectangle:{shapeOptions:{clickable:!1,weight:1}},circlemarker:!1,marker:!1},edit:{featureGroup:t.drawControls}},a=new L.Control.Draw(o);e.addControl(a),e.on(L.Draw.Event.CREATED,(function(e){const o=e.layerType,a=e.layer,n=i("#coords"),r=i("input[name=as-geolocation");if("rectangle"===o){const e=a.toGeoJSON().geometry.coordinates,[t,o,i,s,l]=e[0],c=t[1].toFixed(2),h=t[0].toFixed(2),d=i[1].toFixed(2),m=i[0].toFixed(2);n.innerHTML=`lower left: lat ${c}, lng: ${h}; upper right: lat ${d}, lng ${m}`,r.value=`within(min_lat:${c},min_lng:${h},max_lat:${d},max_lng:${m})`}else if("circle"===o){const t=e.layer.getLatLng(),o=t.lng.toFixed(2),i=t.lat.toFixed(2),a=(e.layer.getRadius()/1e3).toFixed(2);n.innerHTML=`within ${a} kms of ${o}, ${i}`,r.value=`within(radius:${a},units:'kilometers',lat:${i},lng:${o})`}t.drawControls.addLayer(a)})),e.on(L.Draw.Event.DELETED,(function(e){i("input[name=as-geolocation").value="",i("#coords").innerHTML=""}))}(c,h),await g(c,h,l)}}async function g(e,t,o){e.getZoom()<=5?r(e,t):await m(e,t,o)}L.extend(h.prototype,L.Evented.prototype);const p=e=>{const t=new URL(e.target.href).hash,o=a(".modal");t.length>0?(o.forEach((e=>{e.classList.add(...n.hiddenClasses)})),i(t).classList.remove(...n.hiddenClasses)):o.forEach((e=>e.classList.add(...n.hiddenClasses)))};var y;log.level=log[(y=window.location.hostname,"localhost"===y?"INFO":"ERROR")],a(".modalToggle").forEach((e=>e.addEventListener("click",p)));export{f as initializeMap};
