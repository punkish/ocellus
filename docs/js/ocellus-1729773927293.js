/* generated: Thu Oct 24 2024 14:45:27 GMT+0200 (Central European Summer Time) */
import{cellArea as e,UNITS as t,cellToBoundary as n}from"https://cdn.jsdelivr.net/npm/h3-js@4.1.0/+esm";const a=e=>document.querySelector(e),o=e=>document.querySelectorAll(e);const i={fetchOpts:{},uri:{zenodeo:"http://localhost:3010/v3",maps:"http://localhost:3000",zenodo:"https://zenodo.org",treatmentBank:"https://tb.plazi.org/GgServer/html"},cache:{images:{yearlyCounts:!1,totals:!1},treatments:{yearlyCounts:!1,totals:!1},journals:null,collectionCodes:null,bins:{}},figureSize:{normal:250,small:100,tiny:50},defaultPlaceholder:"search images",results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],params:{notValidQ:["resource","page","size","grid","refreshCache","cols"],validImages:["httpUri","caption","captionText","q","treatmentId","treatmentTitle","articleTitle","treatmentDOI","articleDOI","zenodoDep","authorityName","collectionCode","status","journalTitle","journals_id","journalYear","kingdom","phylum","class","family","order","genus","species","publicationDate","checkinTime","latitude","longitude","geolocation","isOnLand","validGeo","eco_name","biome","biome_id"],validTreatments:["treatmentId","treatmentTitle","treatmentDOI","zenodoDep","articleTitle","articleDOI","publicationDate","journalYear","authorityName","status","checkinTime","validGeo","q","latitude","longitude","geolocation","eco_name","biome","isOnLand","journalTitle","kingdom","phylum","class","family","order","genus","species"],validCommon:["refreshCache","page","size","cols","groupby"],notValidSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit","source","grid"]},cols:{images:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","httpUri","caption","latitude","longitude"],treatments:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","journalTitle","latitude","longitude"]},maps:{},hiddenClasses:["hidden","noblock"],closedFigcaptionHeight:"30px",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],markerIcons:{default:L.icon({iconUrl:"/img/marker.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[11,37]}),active:L.icon({iconUrl:"/img/marker-active.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]}),clicked:L.icon({iconUrl:"/img/marker-clicked.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]})},months:["January","February","March","April","May","June","July","August","September","October","November","December"],charts:{termFreq:null,yearlyCounts:null}};function s(e){const t=document.getElementById("charts");let n=960;return t.offsetWidth<n&&(n=t.offsetWidth-100),e.style.display="block",e.style.width=`${n}px`,e.style.textAlign="center",e.style.margin="0 auto",e}function r(e,t){return e<1e3?e:e>=1e3&&e<1e6?e/1e3+"K":e>=1e6&&e<1e7?e/1e6+"M":void 0}!function(e){const t="ocellus.localhost"===window.location.hostname,n="ocellus.local"===window.location.hostname,a="127.0.0.1"===window.location.hostname,o="localhost"===window.location.hostname;t&&n&&a&&o?window.log.level="INFO":(e.uri.zenodeo="https://test.zenodeo.org/v3",e.uri.maps="https://maps.zenodeo.org",window.log.level="ERROR")}(i);const l=({yearlyCounts:e,totals:t})=>{const n=s(document.querySelector("#yearlyCounts"));n.innerHTML="";const a="Images",{years:o,series:l}=function(e,t){const n=[],a=[];"Treatments"===e||"Images"===e?(a.push({name:"Treatments",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_treatments))}),a.push({name:"Images",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_images))}),a.push({name:"Species",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_species))}),a.push({name:"Journals",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_journals))}),t.forEach((e=>n.push(e.year)))):(a.push({name:e,type:"bar",emphasis:{focus:"series"},data:t.map((t=>t[`num_of_${e.toLowerCase()}`]))}),t.forEach((e=>n.push(e.year))));return{years:n,series:a}}(a,e),c=function(e,t,n){return{legend:{left:65,top:60,orient:"horizontal",borderWidth:1,borderRadius:5,borderColor:"#444",backgroundColor:"#fff"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{precision:"0"}},formatter:'<div class="leg">\n    year {b}\n    <hr>\n    <div class="dot b"></div>{a0}: {c0}<br/>\n    <div class="dot g"></div>{a1}: {c1}<br/>\n    <div class="dot y"></div>{a2}: {c2}<br/>\n    <div class="dot r"></div>{a3}: {c3}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",splitLine:{show:!1},data:t}],yAxis:[{type:"value",axisLabel:{formatter:r}}],series:n}}(0,o,l),d=document.createElement("div");d.style.width="100%",d.style.height="200px",d.classList.add("viz"),n.appendChild(d),i.charts.yearlyCounts=echarts.init(d),i.charts.yearlyCounts.setOption(c);const u=t.treatments,h=t.images,m=t.species,p=t.journals,g=c.xAxis[0].data,f=function({resource:e,imagesTotal:t,treatmentsTotal:n,speciesTotals:a,journalsTotals:o,num_of_years:i}){let s="Treatments"===e?`with <span>${t}</span> images, and`:`in <span>${n}</span> treatments of`;s+=` <span>${a}</span> species from <span>${o}</span> journals`,i&&(s+=` over <span>${i}</span> years`);return s}({resource:a,imagesTotal:h,treatmentsTotal:u,speciesTotals:m,journalsTotals:p,num_of_years:g[g.length-1]-g[0]}),y=document.createElement("div");y.style.width="100%",y.classList.add("caption"),n.appendChild(y),y.innerHTML=f};class c{constructor(e){this.el=e,this.summary=e.querySelector("summary"),this.content=e.querySelector("#charts"),this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.summary.addEventListener("click",(e=>this.onClick(e)))}onClick(e){e.preventDefault(),this.el.style.overflow="hidden",this.isClosing||!this.el.open?this.open():(this.isExpanding||this.el.open)&&this.shrink()}shrink(){this.isClosing=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!1),this.animation.oncancel=()=>this.isClosing=!1}open(){this.el.style.height=`${this.el.offsetHeight}px`,this.el.open=!0,window.requestAnimationFrame((()=>this.expand()))}expand(){this.isExpanding=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight+this.content.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!0),this.animation.oncancel=()=>this.isExpanding=!1}onAnimationFinish(e){this.el.open=e,this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.el.style.height=this.el.style.overflow=""}}async function d(a,o){if("imageMarkerClusters"in o&&a.hasLayer(o.imageMarkerClusters)&&(log.info("removing image marker clusters"),a.removeLayer(o.imageMarkerClusters),o.slidebar.remove()),"h3"in o)a.hasLayer(o.h3)||(log.info("re-adding existing h3 layer"),a.addLayer(o.h3),o.h3info.addTo(a));else{log.info("initializing h3 layer");const s=await async function(a){const o=`${i.uri.zenodeo}/bins/${a}`,s=await fetch(o,i.fetchOpts);if(s.ok){const a={type:"FeatureCollection",features:[]},o=["81033ffffffffff","83f293fffffffff"],i=await s.json();o.forEach((e=>delete i[e]));for(const[o,s]of Object.entries(i)){const i=Math.round(e(o,t.km2)),r={type:"Feature",properties:{numOfTreatments:s,area:i,density:s/i},geometry:{type:"Polygon",coordinates:[n(o).map((e=>[e[1],e[0]]))]}};a.features.push(r)}return u(a),a}alert("HTTP-Error: "+s.status)}(3),r=s.features.map((e=>e.properties.density)),l=1/Math.min(...r),c=function({data:e,scaleFactor:t,colorRamp:n,typeOfBins:a}){const o=n.length,i=[];if("equalWidth"===a){const t=Object.values(e);t.reduce(((e,t)=>e+t));const a=Math.max(...t)+1,s=Math.min(...t),r=(a-s)/o;let l=0;for(let e=s;e<a;e+=r){const t=e+r,a=n[l];i.push({from:Math.round(e),to:Math.round(t),fillColor:a,num:0}),l++}i.forEach((t=>{t.num=Object.values(e).filter((e=>e>=t.from&&e<t.to)).length}))}else if("equalFreq"===a){const a=Object.keys(e).length,s=Math.round(a/o),r=[];for(const[n,a]of Object.entries(e))r.push({id:n,num:Math.round(a*t)});const l=r.sort(((e,t)=>e.num-t.num));for(let e=0;e<o;e++){const t=e*s,a=t+s,o=l.slice(t,a),r=o[0].num,c=o[o.length-1].num;i[e]={from:r,to:c,fillColor:n[e],num:o.length}}}return i}({data:r,scaleFactor:l,colorRamp:i.H3ColorRamp,typeOfBins:"equalFreq"}),d=function(e){let t="#f5f5f5",n=0;const a=e.properties.density*l;return a>0&&(t=function(e,t){for(let n=0,a=t.length;n<a;n++)if(e>=t[n].from&&e<t[n].to)return t[n].fillColor}(a,c),n=.7),{fillColor:t,color:"grey",weight:0,fillOpacity:n}};o.h3=L.geoJSON(s,{style:d,onEachFeature:(e,t)=>{t.on({mouseover:e=>{!function({mapLayers:e,bin:t}){t.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.1}),L.Browser.ie||L.Browser.opera||L.Browser.edge||t.bringToFront();e.h3info.update(t.feature.properties)}({mapLayers:o,bin:e.target})},mouseout:e=>{!function({mapLayers:e,bin:t}){e.h3.resetStyle(t),e.h3info.update()}({mapLayers:o,bin:e.target})}})}}),a.addLayer(o.h3),function(e,t){const n=L.control(),a="Hover over a bin to see num of images";n.onAdd=function(e){return this._div=L.DomUtil.create("div","h3info"),this._div.innerHTML=a,this._div},n.update=function(e){this._div.innerHTML=e?`${e.numOfTreatments} treatments in ${e.area} km<sup>2</sup>`:a},t.h3info=n,n.addTo(e)}(a,o)}}function u(e){const{type:t}=e;if("FeatureCollection"===t)return void e.features.map(u);const{type:n,coordinates:a}=e.geometry;switch(n){case"LineString":return void h(a);case"Polygon":return void m(a);case"MultiPolygon":return void a.forEach((e=>m(e)));default:throw new Error(`Unknown geometry type: ${n}`)}}function h(e){let t=!1;for(let n=0;n<e.length;n++)if(Math.abs(e[0][0]-e[(n+1)%e.length][0])>180){t=!0;break}t&&e.forEach((e=>function(e){const t=e[0];e[0]=t<0?t+360:t}(e)))}function m(e){e.forEach((e=>h(e)))}const p=L.Control.extend({options:{content:"<i>Click on a marker for more info</i>",state:"full",threshold:50,doubleThreshold:200},initialize:function(e){return L.Util.setOptions(this,e),this.on("swipeup",(function(e){let t;if(e.value>this.options.doubleThreshold)t="full";else switch(this._size){case"closed":t="quarter";break;case"quarter":t="half";break;case"half":t="full"}this.toggleSize(t)})),this.on("swipedown",(function(e){let t;if(e.value>this.options.doubleThreshold)t="closed";else switch(this._size){case"full":t="half";break;case"half":t="quarter";break;case"quarter":t="closed"}this.toggleSize(t)})),this},toggleSize:function(e){const t=document.querySelector("#leaflet-slidebar");if(t.classList.contains(e));else{["closed","quarter","half","full"].forEach((e=>t.classList.remove(e))),t.classList.add(e),this._size=e}this.reCenter(this._newCenter)},onAdd:function(e){if(!this._div){this._div=L.DomUtil.create("div","leaflet-slidebar"),this._div.classList.add(this.options.state),this._div.id="leaflet-slidebar",this._size=this.options.state;const e="",t=L.DomUtil.create("nav",e,this._div),n="";L.DomUtil.create("hr",n,t);const a="",o=L.DomUtil.create("button",a,t),i=e=>this.toggleSize("closed");L.DomEvent.on(o,"click",i,this),L.DomEvent.on(o,"touchend",i,this);const s="";L.DomUtil.create("main",s,this._div)}return this._div},onRemove:function(e){return this},reCenter:function(){const e=this._map.latLngToLayerPoint(this._newCenter),t=[],{min:n,max:a}=this._map.getPixelBounds();if(document.body.clientWidth<400){const o=a.y-n.y;let i=0;"full"===this._size?i=.375:"half"===this._size?i=.25:"quarter"===this._size&&(i=.125),t.push(e.x,e.y+i*o)}else t.push(e.x,e.y);const o=this._map.layerPointToLatLng(t);this._map.flyTo(o)},update:async function({content:e,latlng:t}){return this._div.querySelector("#leaflet-slidebar main").innerHTML=e,this._newCenter=t,this.toggleSize("full"),this},addTo:function(e){return this.onRemove(),this._map=e,this._container=this.onAdd(e),L.DomUtil.addClass(this._container,"leaflet-slidebar"),L.Browser.touch&&L.DomUtil.addClass(this._container,"leaflet-touch"),L.DomEvent.disableScrollPropagation(this._container),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"contextmenu",L.DomEvent.stopPropagation),L.DomEvent.on(this._container,"touchstart",this._startSwipe,this),L.DomEvent.on(this._container,"touchend",this._endSwipe,this),e._container.insertBefore(this._container,e._container.firstChild),this},_startSwipe:function(e){const t=e.touches&&e.touches[0];t&&this._map&&(e.target&&"A"==e.target.tagName||(this._startPoint=this._map.mouseEventToContainerPoint(t),L.DomEvent.preventDefault(e)))},_endSwipe:function(e){const t=e.changedTouches&&e.changedTouches[0];if(!t||!this._startPoint||!this._map)return;const n=this._map.mouseEventToContainerPoint(t).subtract(this._startPoint),a=Math.abs(n.x),o=Math.abs(n.y);if(this._startPoint=null,a<this.options.threshold&&o<this.options.threshold)return;if(a/o>.5&&a/o<2)return;let i,s;a>o?(s=a,i=n.x<0?"left":"right"):(s=o,i=n.y<0?"up":"down"),this.fire("swipe"+i,{direction:i,value:s})}});async function g(e,t){const n=a("#throbber");n.classList.remove("nothrob");const o=e.getBounds(),s=await async function(e){const t=e.getSouthWest().lat,n=e.getSouthWest().lng,a=e.getNorthEast().lat,o=e.getNorthEast().lng,s=`${i.uri.zenodeo}/images?geolocation=within(min_lat:${t},min_lng:${n},max_lat:${a},max_lng:${o})&cols=treatmentId&cols=treatmentTitle&cols=latitude&cols=longitude&size=5000`,r=await fetch(s,i.fetchOpts);if(r.ok)return(await r.json()).item.result.records;alert("HTTP-Error: "+r.status)}(o);if(s){t.imageMarkerClusters||(t.imageMarkerClusters=L.markerClusterGroup({disableClusteringAtZoom:10}));const a=[];s.forEach((o=>{const s=o.images_id;if(!t.imageMarkers.has(s)){const r=o.treatmentId,l={title:r,icon:i.markerIcons.default},c=new L.LatLng(o.latitude,o.longitude),d=L.marker(c,l);d.on("click",(async function(l){n.classList.remove("nothrob");const d=l.target;d.setIcon(i.markerIcons.active);const u=await async function(e){if(!e)return"Click on an image marker for more info";{const t=e.treatmentId,n=`${i.uri.zenodeo}/images?id=${e.images_id}&cols=httpUri&cols=caption`;let a=`<h3>${e.treatmentTitle}</h3>`;const o=await fetch(n,i.fetchOpts);if(o.ok){const e=(await o.json()).item.result.records[0],n=`<a href="${i.uri.treatmentBank}/${t}" target="_blank">more on TB</a>`;if(e.httpUri){const t=250,o=e.httpUri.split("/")[4];let s;s=e.httpUri.indexOf("zenodo")>-1?e.httpUri.indexOf(".svg")>-1?"/img/kein-preview.png":`${i.uri.zenodo}/api/iiif/record:${o}:figure.png/full/250,/0/default.jpg`:`${e.httpUri}/singlefigAOF/`,a+=`\n                <figure class="figure-${t}">\n                    <img src="../img/bug.gif" width="${t}" data-src="${s}" \n                        class="lazyload" data-recid="${o}">\n                    <figcaption>${e.captionText} ${n}</figcaption>\n                </figure>`}else a+=n;return a}}}(o);t.slidebar.update({content:u,latlng:c}),n.classList.add("nothrob");document.querySelector("#leaflet-slidebar").style.visibility="visible",function(e,t,n){const a=e.getCenter(),o=Math.round(1e5*a.lat)/1e5,i=Math.round(1e5*a.lng)/1e5,s=e.getZoom();let r=`#show=maps&lat=${o}&lng=${i}&zoom=${s}&treatmentId=${t}-${n}`;const l={zoom:s,center:{lat:o,lng:i}};window.history.pushState(l,"map",r)}(e,r,s),t.imageMarkerClusters.getVisibleParent(d);const h=a[a.length-1];h&&h.setIcon(i.markerIcons.clicked),a.push(d)})),t.imageMarkers.set(s,d),t.imageMarkerClusters.addLayer(d)}})),e.hasLayer(t.imageMarkerClusters)?log.info("used existing image marker clusters layer"):(log.info("re-adding existing image marker clusters"),e.addLayer(t.imageMarkerClusters))}n.classList.add("nothrob")}async function f(e,t,n){if("h3"in t&&e.hasLayer(t.h3)&&(log.info("removing h3 layer"),e.removeLayer(t.h3),t.h3info.remove()),"imageMarkerClusters"in t?(await g(e,t),t.slidebar.addTo(e)):(log.info("initializing image marker clusters"),function(e,t){t.slidebar=new p({state:"closed"}),t.slidebar.addTo(e)}(e,t),t.imageMarkers=new Map,await g(e,t)),n){const[e,a]=n.split("-"),o=t.imageMarkers.get(Number(a));o&&(t.imageMarkerClusters.zoomToShowLayer(o),o.fireEvent("click"))}}async function y({baseLayerSource:e,map:t}){const n={minZoom:1,maxZoom:17,zoomOffset:-1,tileSize:512};let a;if("arcgis"===e)n.attribution="&copy; ESRI",a=L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",n).addTo(t);else if("geodeo"===e){const e=`${i.uri.maps}/nev_raster/{z}/{x}/{y}`,n={ne_50m_admin_1_states_provinces_lakes:{maxZoom:2,tms:!0,styles:{weight:1,color:"blue",fillColor:"",fillOpacity:.5,fill:!0}},ne_50m_admin_0_countries:{maxZoom:2,tms:!0,styles:{weight:1,color:"#444",fillColor:"f5f5f5",fillOpacity:.25,fill:!0}},ne_10m_admin_1_sel:{maxZoom:5,tms:!0,styles:{weight:1,color:"#444",fillColor:"#f5f5f5",fillOpacity:.25,fill:!0}},nev:{maxNativeZoom:7,maxZoom:10,tms:!0,vectorTileLayerStyles:{playa:{stroke:!0,weight:1,color:"aliceblue",fillColor:"aliceblue",fillOpacity:.25,fill:!0},urban:{stroke:!0,weight:1,color:"bisque",fillColor:"bisque",fillOpacity:.25,fill:!0},water:{stroke:!0,weight:1,color:"black",fillColor:"lightblue",fillOpacity:.25,fill:!0},ice:function(e){return"glacier"===e.type?{weight:1,color:"white",fillColor:"white",fillOpacity:.45,fill:!0}:"ice_shelf"===e.type?{weight:1,color:"white",fillColor:"lightgrey",fillOpacity:.45,fill:!0}:void 0},river:{weight:1,color:"blue",fillColor:"",fillOpacity:1,fill:!1},railroad:{stroke:!0,weight:1,color:"brown"},road:{weight:1,color:"#ffcc00",fillColor:"",fillOpacity:1,fill:!1},country_label:{stroke:!1,fill:!1},state_label:{stroke:!1,fill:!1},marine_label:{stroke:!1,fill:!1},lake_label:{stroke:!1,fill:!1},place_label:{stroke:!1,fill:!1},airport_label:{stroke:!1,fill:!1},port_label:{stroke:!1,fill:!1},admin:function(e,t){const n=e.admin_level;return 0===n?{weight:1,color:"#444",fill:!1}:1===n?{weight:.5,color:"#444",fill:!1}:2===n?{weight:1,color:"#cf52d3",dashArray:"2, 6",fillColor:"green",fillOpacity:.25,fill:!0}:void 0}}},nev_raster:{maxZoom:15,tms:!0}};L.tileLayer(e,{maxNativeZoom:6,maxZoom:10,tms:!0}).addTo(t);const a="nev",o=n[a];L.vectorGrid.protobuf(`${i.uri.maps}/${a}/{z}/{x}/{y}`,o).addTo(t)}else if("gbif"===e){n.attribution='&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> / &copy; <a href="https://www.openmaptiles.org/copyright">OpenMapTiles</a>';const e=parseInt(window.devicePixelRatio)||1;a=L.tileLayer("https://tile.gbif.org/3857/omt/{z}/{x}/{y}@{r}x.png?style=gbif-natural".replace("{r}",e),n).addTo(t)}return a}async function v({mapContainer:e,baseLayerSource:t,drawControl:n}){if(i.maps[e])"map"===e&&(a("#not-map").classList.add("hidden"),a("#map").classList.remove("hidden"));else{const{zoom:o,lat:s,lng:r,treatmentId:l}=function({zoom:e,lat:t,lng:n,treatmentId:a}){const o=new URLSearchParams(window.location.hash.substring(1));return{zoom:e=parseInt(o.get("zoom"),10)||e,lat:t=parseFloat(o.get("lat"))||t,lng:n=parseFloat(o.get("lng"))||n,treatmentId:a=o.get("treatmentId")||a}}({zoom:5,lat:0,lng:0}),c={preferCanvas:!0},d=L.map(e,c).setView({lat:s,lng:r},o);!function(e){let t=!0;e.on("moveend",(function(){if(!t)return void(t=!0);const n=e.getCenter(),a=Math.round(1e5*n.lat)/1e5,o=Math.round(1e5*n.lng)/1e5,i=e.getZoom(),s=window.location.pathname.split(".").shift().substring(1);let r;"maps"===s?r=`#lat=${a}&lng=${o}&zoom=${i}`:"index"===s&&(r=`#show=maps&lat=${a}&lng=${o}&zoom=${i}`);const l=new URLSearchParams(window.location.hash.substring(1)).get("treatmentId")||void 0;l&&(r+=`&treatmentId=${l}`);const c={zoom:i,center:{lat:a,lng:o}};window.history.pushState(c,"map",r)})),window.addEventListener("popstate",(function(n){null!==n.state&&(e.setView(n.state.center,n.state.zoom),t=!1)}))}(d),i.maps[e]=d,d.attributionControl.setPrefix(""),d.on("moveend",(async function(e){await $(d,u)}));const u={baseLayer:y({baseLayerSource:t,map:d})};n&&function(e,t){t.drawControls=new L.FeatureGroup,function(e,t){e.hasLayer(t)||e.addLayer(t)}(e,t.drawControls);const n={position:"topleft",draw:{polyline:!1,polygon:!1,circle:{shapeOptions:{weight:1}},rectangle:{shapeOptions:{clickable:!1,weight:1}},circlemarker:!1,marker:!1},edit:{featureGroup:t.drawControls}},o=new L.Control.Draw(n);e.addControl(o),e.on(L.Draw.Event.CREATED,(function(e){const n=e.layerType,o=e.layer,i=a("#coords"),s=a("input[name=as-geolocation");if("rectangle"===n){const e=o.toGeoJSON().geometry.coordinates,[t,n,a,r,l]=e[0],c=t[1].toFixed(2),d=t[0].toFixed(2),u=a[1].toFixed(2),h=a[0].toFixed(2);i.innerHTML=`lower left: lat ${c}, lng: ${d}; upper right: lat ${u}, lng ${h}`,s.value=`within(min_lat:${c},min_lng:${d},max_lat:${u},max_lng:${h})`}else if("circle"===n){const t=e.layer.getLatLng(),n=t.lng.toFixed(2),a=t.lat.toFixed(2),o=(e.layer.getRadius()/1e3).toFixed(2);i.innerHTML=`within ${o} kms of ${n}, ${a}`,s.value=`within(radius:${o},units:'kilometers',lat:${a},lng:${n})`}t.drawControls.addLayer(o)})),e.on(L.Draw.Event.DELETED,(function(e){a("input[name=as-geolocation").value="",a("#coords").innerHTML=""}))}(d,u),await $(d,u,l)}}async function $(e,t,n){e.getZoom()<=5?d(e,t):await f(e,t,n)}L.extend(p.prototype,L.Evented.prototype);function w(e){const t=a("input[name=resource]").checked?"treatments":"images",n=`${e.target.href}&resource=${t}`;history.pushState({},"",n);const o=new URL(location);let i;o.search&&(i=o.search.substring(1)),J(i);const s=Y();Z(s),e.preventDefault(),e.stopPropagation()}function b(e){if("/"===e.key){if(/^(?:input|textarea|select|button)$/i.test(e.target.tagName))return;const t=a("#q");t.setSelectionRange(0,t.value.length),t.focus(),e.preventDefault()}}const k=e=>{const t=a(".examples").classList;t.contains("hidden")?t.remove("hidden"):t.add("hidden")},C=e=>{const t=e.target.classList;t.contains("required")&&t.remove("required")},_=e=>{log.info("- toggling advanced search"),a("#as-container").classList.toggle("noblock");a("input[name=searchtype]").checked?(a("#q").value="",a("#q").placeholder="use advanced search below",a("#q").disabled=!0,a("#refreshCache").disabled=!0,a("#clear-q").disabled=!0,a('input[name="as-q"]').focus(),v({mapContainer:"mapSearch",baseLayerSource:"geodeo",drawControl:!0})):(a("#q").placeholder=i.defaultPlaceholder,a("#q").disabled=!1,a("#refreshCache").disabled=!1,a("#clear-q").disabled=!1)},x=e=>{const t=a("input[name=resource]").checked?"treatments":"images";K(t)},T=e=>{if(e.target.open){var t=o("details[open]");Array.prototype.forEach.call(t,(function(t){t!==e.target&&t.removeAttribute("open")}))}},S=e=>{a("#q").value=e.target.textContent,a("#ns-go").classList.add("glowing");o("input[name=source").forEach((e=>{"treatments"===e.value&&(e.checked=!0)})),k(),e.stopPropagation(),e.preventDefault()},z=e=>{a("#refreshCache").toggleAttribute("data-pop-show")},E=e=>{""===a("#q").value?(M(),setTimeout(O,4e3)):(a("#q").classList.remove("red-placeholder"),a("#throbber").classList.remove("nothrob"),a("#ns-go").classList.remove("glowing"),V()),e.stopPropagation(),e.preventDefault()},q=e=>{a("#throbber").classList.remove("nothrob"),V(),e.stopPropagation(),e.preventDefault()},j=e=>{const t=new URL(e.target.href).hash,n=o(".modal");t.length>0?(n.forEach((e=>{e.classList.add(...i.hiddenClasses)})),a(t).classList.remove(...i.hiddenClasses)):n.forEach((e=>e.classList.add(...i.hiddenClasses)))},M=()=>{a("#q").placeholder="c'mon, type something",a("#q").classList.add("red-placeholder")},O=e=>{a("#q").placeholder=i.defaultPlaceholder,a("#q").classList.remove("red-placeholder"),a("#refreshCache").checked=!1},I=e=>{e.target.innerHTML='<a href="#map" id="mapInit">MAP</a> • IMAGES • TREATMENTS',e.target.querySelector("#mapInit").addEventListener("click",D),a("#brand").classList.add("smallbrand"),a("#brand").removeEventListener("click",I),setTimeout((()=>{e.target.innerHTML=4,a("#brand").classList.remove("smallbrand"),a("#brand").addEventListener("click",I)}),3e3),e.stopPropagation(),e.preventDefault()},D=e=>{a("#not-map").classList.add("hidden"),v({mapContainer:"map",baseLayerSource:"geodeo",drawControl:!1})};function F(e){const t=e.querySelector(".next"),n=e.querySelector(".prev");let a=0;const o=e.querySelectorAll(".content .slide"),s=o.length;let r=o[0];function l(e){r.classList.remove("current"),a+=e,-1===e&&a<0&&(a=s-1),1!==e||o[a]||(a=0),r=o[a],r.classList.add("current")}e.classList.add("active"),t.addEventListener("click",(function(e){l(1),function(e){const t=e.currentTarget;if(!i.maps[t.dataset.id]){const e=L.map(`map-${t.dataset.id}`);i.maps[t.dataset.id]=e;const n="http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}";L.tileLayer(n,{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(e);const a=L.icon({iconUrl:"img/treatment.svg",iconSize:[10,10],iconAnchor:[5,5]});let o;if("undefined"!==t.dataset.loc){JSON.parse(t.dataset.loc).map((e=>[e.latitude,e.longitude])).forEach(((t,n)=>{0===n&&(o=t),L.marker(t,{icon:a}).addTo(e)})),e.setView(o,10)}else if(t.dataset.convexhull){const n=JSON.parse(t.dataset.convexhull),o=L.polygon(n,{color:"#9BC134",weight:1}).addTo(e);n.forEach(((t,n)=>{L.marker(t,{icon:a}).addTo(e)})),e.fitBounds(o.getBounds())}}}(e)})),n.addEventListener("click",(function(e){l(-1)})),l(0)}const H=e=>{const t=e.target.name;if("between"===e.target.value){o(`#${t}-range .hidden`).forEach((e=>{e.classList.contains("hidden")&&(e.classList.remove("hidden"),e.classList.add("vis"))}))}else{o(`#${t}-range .vis`).forEach((e=>{e.classList.add("hidden"),e.classList.remove("vis")}))}};function A(e,t){const n=document.getElementById("tooltip");n.innerHTML=t,n.style.display="block",n.style.left=e.offsetX+"px",n.style.top=e.offsetY+"px"}function P(){document.getElementById("tooltip").style.display="none"}function U({resource:e,figureSize:t,rec:n}){const a="images"===e?(({figureSize:e,rec:t})=>{const n=t.zenodoRec?`<img src="img/zenodo-gradient-35.png" width="35" height="14"> <a href="${i.uri.zenodo}/records/${t.zenodoRec}" target="_blank">more on Zenodo</a>`:"",a=`<img src="img/treatmentBankLogo.png" width="35" height="14"> <a href="${i.uri.treatmentBank}/${t.treatmentId}" target="_blank">more on TreatmentBank</a>`,o=250===e?"visible":"noblock",s=`figure-${e}`+(t.treatmentId?" tb":""),r=`this.onerror=null; setTimeout(() => { this.src='${t.uri}' }, 1000);`,l=t.loc||t.convexHull?"this.parentNode.parentNode.parentNode.parentNode.style.height=this.height+150+'px'":"";return`<figure class="${s}">\n    <a class="zen" href="${t.fullImage}">\n\n            <img src="img/bug.gif" width="${t.figureSize}" \n                data-src="${t.uri}" \n                class="lazyload" \n                data-recid="${t.treatmentId}" \n                onerror="${r}"\n                onload="${l}">\n        \n    </a>\n    <figcaption class="${o}">\n        <details>\n            <summary class="figTitle" data-title="${t.treatmentTitle}">\n                ${t.treatmentTitle}\n            </summary>\n            <p>${t.captionText}</p>\n            ${a}<br>\n            ${n}\n        </details>\n    </figcaption>\n</figure>`})({figureSize:t,rec:n}):(({figureSize:e,rec:t})=>{let n="";t.zenodoRec&&(n=`<a href="${i.uri.zenodo}/records/${t.zenodoRec}" target="_blank" title="more on Zenodo" alt="more on Zenodo"><img class="zenodoLink" src="img/zenodo-gradient-round.svg" width="50"></a>`);const a=250===e?"visible":"noblock",o=`figure-${e} `+(t.treatmentId?"tb":""),s=t.treatmentDOI?`<a href="https://dx.doi.org/${t.treatmentDOI}">${t.treatmentDOI}</a>`:"";let r="";return t.articleTitle&&(r+=`<span class="articleTitle">${t.articleTitle}</span>`),t.articleAuthor&&(r+=` by <span class="articleAuthor">${t.articleAuthor}</span>`),t.journalTitle&&(r+=` in <span class="journalTitle">${t.journalTitle}</span>`),s&&(r+=`. ${s}`),`<figure class="${o}">\n    <p class="treatmentTitle">${t.treatmentTitle}</p>\n    <p class="citation">${r}</p>\n    <figcaption class="${a}">\n        \x3c!--  --\x3e\n        <div>\n            ${n} <a href="${i.uri.treatmentBank}/${t.treatmentId}" target="_blank" title="more on TreatmentBank" alt="more on TreatmentBank"><img class="tbLink" src="img/treatmentBankLogo.png" width="100"></a>\n        </div>\n    </figcaption>\n</figure>`})({figureSize:t,rec:n}),o="images"===e?`${n.treatments_id}-${n.images_id}`:n.treatments_id;return n.loc||n.convexHull?`\n        <div class="carouselbox">\n\n            <div class="buttons">\n                <button class="prev">\n                    ◀ <span class="offscreen">Previous</span>\n                </button>\n                <button class="next" \n                    data-loc=${JSON.stringify(n.loc)} \n                    data-convexhull=${JSON.stringify(n.convexHull)} \n                    data-id="${o}">\n                    <span class="offscreen">Next</span> ▶︎\n                </button>\n            </div> \n\n            <div class="content">\n                <div class="slide">\n                    ${a}\n                </div>\n                <div id="map-${o}" class="map slide"></div>\n            </div>\n        </div>`:`\n        <div class="slidr">\n            ${a}\n        </div>`}const R=({resource:e,figureSize:t,slides:n,qs:o,count:c,term:d,termFreq:u,yearlyCounts:h,prev:m,next:p,stored:g,ttl:f,cacheHit:y})=>{log.info(`- renderPage()\n    - figureSize: ${t}px\n    - figures: ${n.length} slides\n    - qs: ${o}\n    - count: ${c}\n    - prev: ${m}\n    - next: ${p}`),a("#grid-images").classList.add(`columns-${t}`),N(n),B(o,m,p),a("#throbber").classList.add("nothrob"),i.charts.termFreq&&(i.charts.termFreq.dispose(),a("#termFreq").style.visibility="hidden"),u&&u.length&&(((e,t)=>{const n=s(document.querySelector("#termFreq"));n.innerHTML="";const a="all",o="with images",l={legend:{left:55,top:60,orient:"vertical",borderWidth:1,borderRadius:5,borderColor:"silver",backgroundColor:"#fff"},tooltip:{trigger:"axis",formatter:'<div class="leg">\n    year {b}\n    <hr>\n    {a0}: {c0}<br/>\n    {a1}: {c1}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",splitLine:{show:!1},data:t.map((e=>e.journalYear))},yAxis:{type:"log",minorSplitLine:{show:!0},axisLabel:{formatter:r}},series:[{name:a,type:"line",data:t.map((e=>0==e.total?null:e.total)),color:"#f00",lineStyle:{color:"#f00",width:1}},{name:o,type:"line",data:t.map((e=>0==e.withImages?null:e.withImages)),color:"#00f",lineStyle:{color:"#00f",width:1}}]},c=document.createElement("div");c.style.width="100%",c.style.height="150px",c.classList.add("viz"),n.appendChild(c),i.charts.termFreq=echarts.init(c),i.charts.termFreq.setOption(l);const d=document.createElement("div");d.style.width="100%",d.classList.add("caption"),n.appendChild(d),d.innerHTML=`occurrence of <span>${e}</span> in the text by year`})(d,u),a("#termFreq").style.visibility="visible"),function(e,t,n,o,s){log.info("- renderSearchCriteria()");const r=new URLSearchParams(e);let l=r.get("resource");const c=[],d=[],u=[];i.params.notValidSearchCriteria.forEach((e=>r.delete(e)));const h='<span class="crit-key">',m='<span class="crit-val">',p='<span class="crit-count">',g="</span>",f={checkinTime:"checked in",updateTime:"updated",publicationDate:"published"};t?t<10&&(t=W(t)):t="Sorry, no";c.push(`${p}${t}${g}`),1===t&&(l=l.slice(0,-1));c.push(l),r.forEach(((e,n)=>{let a;if(Object.keys(f).includes(n)){const o=e.match(/(?<operator1>eq|since|until)?\((?<date>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)|(?<operator2>between)?\((?<from>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\s*and\s*(?<to>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)/);if(o){if(a=`${h}${f[n]}${g}`,o.groups.operator1){let e;e="since"===o.groups.operator1?1===t?"has been":"have been":1===t?"was":"were",c.push(e),"eq"===o.groups.operator1?a+=" on":a+=` ${o.groups.operator1}`,a+=` ${m}${o.groups.date}${g}`}else o.groups.operator2&&(a+=` ${m}between${g} ${m}${o.groups.from}${g} and ${m}${o.groups.to}${g}`);d.push(a)}}else{const t=e.match(/(?<operator>\w+)\((?<term>[\w\s]+)\)/);if(t){const{operator:e,term:o}=t.groups;a=`${h}${n}${g}${e.replace(/_/," ")} ${m}${o}${g}`}else if("q"===n)a=`${h}${e}${g} is in the text`;else if("captionText"===n)a=`${h}${e}${g} is in ${h}caption text${g}`;else if("geolocation"===n){const t=new RegExp("(?<operator>within)\\((radius:s*(?<radius>([+-]?([0-9]+)(.[0-9]+)?)),s*units:s*['\"](?<units>kilometers|miles)['\"],s*lat:s*(?<lat>([+-]?([0-9]+)(.[0-9]+)?)),s*lng:s*(?<lng>([+-]?([0-9]+)(.[0-9]+)?))|min_lat:s*(?<min_lat>([+-]?([0-9]+)(.[0-9]+)?)),min_lng:s*(?<min_lng>([+-]?([0-9]+)(.[0-9]+)?)),max_lat:s*(?<max_lat>([+-]?([0-9]+)(.[0-9]+)?)),max_lng:s*(?<max_lng>([+-]?([0-9]+)(.[0-9]+)?)))\\)"),n=e.match(t);if(n){let{operator:e,radius:t,units:o,lat:i,lng:s,min_lat:r,min_lng:l,max_lat:c,max_lng:d}=n.groups;t?(s=Number(s).toFixed(2),i=Number(i).toFixed(2),a=`${h}location${g} is within ${m}${t}${g} ${m}${o}${g} of ${m}lat ${i}${g} and ${m}lng ${s}${g}`):(l=Number(l).toFixed(2),r=Number(r).toFixed(2),d=Number(d).toFixed(2),c=Number(c).toFixed(2),a=`${h}location${g} is within a box with ${h}lower left corner${g} at ${m}lat ${r}, lng ${l}${g} and ${h}upper right corner${g} at ${m}lat ${c}, lng ${d}${g}`)}}else n=n.split(/([A-Z][a-z]+)/).filter((function(e){return e})).map((e=>e.toLowerCase())).join(" "),a=`${h}${n}${g} is ${m}${e}${g}`;u.push(a)}}));const y=[];d.length?y.push(...d):c.push("found");u.length&&c.push("where");let v;y.push(...u);const $=y.length;v=1===$?y[0]:2===$?`${y[0]} and ${y[1]}`:`${y.slice(0,$-2).join(", ")}, and ${y[$-1]}`;if(c.push(v),s){const e=new Date(n),t=new Date(n+o)-new Date;c.push(`<span aria-label="cache hit, stored ${ee(e)}, expires in ${X(t)}" data-html="true" data-pop="top" data-pop-no-shadow data-pop-arrow data-pop-multiline>💥</span>`)}a("details.charts summary").innerHTML=c.join(" "),a("#charts-container summary").style.visibility="visible"}(o,c,g,f,y),i.charts.yearlyCounts&&(i.charts.yearlyCounts.dispose(),a("#yearlyCounts").style.visibility="hidden"),h&&(l({yearlyCounts:h.yearlyCounts,totals:h.totals}),a("#yearlyCounts").style.visibility="visible"),(u||h)&&(a("#charts").style.visibility="visible");a("input[name=searchtype]").checked&&(a("input[name=searchtype]").checked=!1,_(),J(o)),"images"===e&&new SimpleLightbox({elements:"figure",loadingCaption:'<img src="../../img/bug.gif">'})},N=(e,t,n,i)=>{log.info("- renderSlides()"),e.length?(a("#grid-images").innerHTML=e.join(""),(()=>{const e=o("figcaption > details");for(let t=0,n=e.length;t<n;t++)e[t].addEventListener("toggle",(n=>{const a=n.target.querySelector("summary"),o=a.dataset.title,i=o.length>30?`${o.substring(0,30)}…`:o;a.innerText=e[t].open?o:i}))})(),(()=>{const e=o("figure .reveal");for(let t=0,n=e.length;t<n;t++)e[t].addEventListener("click",I)})(),o(".carouselbox").forEach((e=>{F(e)}))):a("#grid-images").innerHTML=""},B=(e,t,n)=>{log.info("- renderPager()"),log.info(`  - qs: ${e}`),log.info(`  - prev: ${t}`),log.info(`  - next: ${n}`);const o=new URLSearchParams(e);o.delete("page"),a("#pager").innerHTML=`<a href="?${o.toString()}&page=${t}">prev</a> <a href="?${o.toString()}&page=${n}">next</a>`,a("#pager").classList.add("filled"),log.info("- listeners.addListenersToPagerLinks()")};const Z=async e=>{log.info("- getResource(qs)"),a("#throbber").classList.remove("nothrob");const t=new URLSearchParams(e),n=t.get("page"),o=t.get("size"),s=t.get("grid")||"normal",r=i.figureSize[s],l=t.get("resource");let c;t.delete("resource"),t.has("q")&&(c=t.get("q"));const d="images"===l?i.params.validImages:i.params.validTreatments;d.push(...i.params.validCommon);let u=!0;if(Array.from(t).forEach((([e,n])=>{var o;d.includes(e)?n||(t.set("q",e),t.delete(e),c=e):(o=`"${e}" is not a valid param`,a(".warn").classList.contains("hidden")&&(a(".warn").innerHTML=o,a(".warn").classList.remove("hidden"),a("#throbber").classList.add("nothrob"),setTimeout((()=>{a(".warn").innerHTML="",a(".warn").classList.add("hidden")}),3e3)),u=!1)})),!1===u)return;const h="images"===l?`${i.cols.images.join("&cols=")}`:`${i.cols.treatments.join("&cols=")}`;let m=`${t.toString()}&cols=${h}`;c&&(m+="&termFreq=true"),t.has("treatmentId")||(m+="&yearlyCounts=true");const p=[];p.push(G({resource:l,queryString:m,figureSize:r})),Promise.all(p).then((e=>{const t={resource:l,prev:n>1?n-1:1,next:parseInt(n)+1,size:o,count:0,recs:[]};return e.forEach((e=>{void 0!==e&&(t.recs.push(...e.recs),t.count+=e.count,t.termFreq=e.termFreq,t.yearlyCounts=e.yearlyCounts,t.cacheHit=e.cacheHit,t.stored=e.stored,t.ttl=e.ttl)})),t})).then((t=>{const n=t.recs.map((e=>U({resource:l,figureSize:r,rec:e}))),a={resource:l,figureSize:r,slides:n,qs:e,count:t.count,prev:t.prev,next:t.next,stored:t.stored,ttl:t.ttl,cacheHit:t.cacheHit};t.termFreq&&(a.termFreq=t.termFreq,a.term=c),t.yearlyCounts&&(a.yearlyCounts=t.yearlyCounts),R(a)}))},G=async({resource:e,queryString:t,figureSize:n})=>{log.info(`- getResults({ resource, queryString, figureSize })\n    - resource: ${e}\n    - queryString: ${t},\n    - figureSize: ${n}`);const a=`${i.uri.zenodeo}/${e}?${t}`,o=await fetch(a,i.fetchOpts);if(o.ok){const t=await o.json(),a=t.item.result.records;let s;if(t.item.result.yearlyCounts){s={};const e=t.item.result.yearlyCounts,n=e.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});s.yearlyCounts=e,s.totals=n}const r={resource:e,count:0,recs:[],termFreq:t.item.result.termFreq,yearlyCounts:s,prev:"",next:"",stored:t.stored,ttl:t.ttl,cacheHit:t.cacheHit||!1};if(a)return r.count=r.count+t.item.result.count,a.forEach((t=>{const a={};if("images"===e){a.treatmentId=t.treatmentId,a.treatments_id=t.treatments_id,a.images_id=t.images_id,a.treatmentTitle=t.treatmentTitle,a.zenodoRec=t.zenodoDep,a.figureSize=n;const e=t.httpUri.split("/")[4];t.httpUri.indexOf("zenodo")>-1?t.httpUri.indexOf(".svg")>-1?(a.uri="/img/kein-preview.png",a.fullImage="/img/kein-preview.png"):(a.uri=`https://zenodo.org/api/iiif/record:${e}:figure.png/full/250,/0/default.jpg`,a.img=`${i.zenodoUri}/${e}/thumb${n}`,a.fullImage=`https://zenodo.org/api/iiif/record:${e}:figure.png/full/^1200,/0/default.jpg`,a.fullImg=`${i.zenodoUri}/${e}/thumb1200`):(a.uri=`${t.httpUri}/singlefigAOF/`,a.fullImage=t.httpUri),a.captionText=t.captionText,a.treatmentDOI=t.treatmentDOI,a.articleTitle=t.articleTitle,a.articleAuthor=t.articleAuthor,a.latitude=t.latitude,a.longitude=t.longitude,a.loc=t.loc,t.convexHull?a.convexHull=t.convexHull[0].map((([e,t])=>[t,e])):a.convexHull=void 0}else"treatments"===e&&(a.treatmentId=t.treatmentId,a.treatments_id=t.treatments_id,a.treatmentTitle=t.treatmentTitle,a.zenodoRec=t.zenodoDep,a.figureSize=n,a.journalTitle=t.journalTitle,a.treatmentDOI=t.treatmentDOI,a.articleTitle=t.articleTitle,a.articleAuthor=t.articleAuthor,a.latitude=t.latitude,a.longitude=t.longitude,a.loc=t.loc,t.convexHull?a.convexHull=t.convexHull[0].map((([e,t])=>[t,e])):a.convexHull=void 0);r.recs.push(a)})),r}else alert("HTTP-Error: "+o.status)},J=e=>{log.info(`- qs2form(qs)\n    - qs: ${e}`);const t=new URLSearchParams(e);t.delete("refreshCache");const n=[];t.forEach(((e,t)=>{if(log.info(`val: ${e}, key: ${t}`),i.params.notValidQ.includes(t))"resource"===t?(log.info(`setting form to query resource ${e}`),K(e),"treatments"===e?(log.info("setting toggle-resource to true"),a("input[name=resource]").checked=!0):(log.info("setting toggle-resource to false"),a("input[name=resource]").checked=!1)):(log.info(`setting input name ${t} to ${e}`),a(`input[name=${t}]`).value=e);else{let a=t;e&&(a="q"===t?decodeURIComponent(e):`${t}=${e}`),n.push(a)}})),a("#q").value=n.join("&")},W=e=>e<10?["One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][e-1].toLowerCase():e,V=()=>{log.info("submitForm()");const e=Y();if(!e)return!1;Q(e),Z(e)},K=async e=>{const t=await(async(e,t)=>{if(!i.cache[e].yearlyCounts){let n=`${i.uri.zenodeo}/${e}?cols=`;t&&(n+="&yearlyCounts=true");const a={method:"GET",headers:new Headers({"ngrok-skip-browser-warning":!0})},o=await fetch(n,a);if(o.ok){const n=await o.json(),a=n.item.result.count;if(t){const t=n.item.result.yearlyCounts,a=t.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});i.cache[e].yearlyCounts=t,i.cache[e].totals=a}else i.cache[e].totals[e]=a}else alert("HTTP-Error: "+o.status)}return i.cache[e]})(e,!0);((e,t)=>{let{images:n,treatments:o,species:i,journals:s}=t.totals;const r=t.yearlyCounts;let l="images"===e?n:o;a("#q").placeholder=`search ${e}`;const c=r.length,d=3*c;Math.max(...r);const u=40/l;function h(t,n,a,o,i,s,r){return`<g class="${n}" transform="translate(${t*i},0)">\n            <rect height="${a}" y="${o-a}" width="${i}" onmousemove="showTooltip(evt, '${s}: ${r} ${e}');" onmouseout="hideTooltip();"></rect>\n        </g>`}let m=`<svg id="svgSpark" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="chart" height="40" width="${d}" aria-labelledby="title" role="img">`;for(let t=0;t<c;t++){const n=r[t].year,a=r[t][`num_of_${e}`];m+=h(t,"bar",a*u,40,3,n,a)}m+="</svg>";const p=document.querySelector("#sparkBox");let g=m;l=Math.round(l/1e3,0),o=Math.round(o/1e3,0),n=Math.round(n/1e3,0),i=Math.round(i/1e3,0),s=Math.round(s/1e3,0),g+="images"===e?` <span>~${l}K</span> ${e}, <span>~${o}K</span> treatments, `:`<span>~${l}K</span> ${e}, <span>~${n}K</span> images, `,g+=`<span>~${i}K</span> species, <span>~${s}K</span> journals`,p.innerHTML=g})(e,t),a("#q").placeholder=`search ${e}`},Y=()=>{const e=new URLSearchParams,t=!0===a("input[name=searchtype").checked?"as":"ss";let n=!0;if("ss"===t)log.info("- form2qs(): simple search"),Array.from(o("form input.query")).filter((e=>e.value)).forEach((t=>{let n=t.name,a=t.value;if("q"===t.name){const o=t.value.replaceAll(/ & /g,"%20%26%20");new URLSearchParams(o).forEach(((t,o)=>{if(""===t){const e=a.match(/(^10\.[0-9]{4,}.*)/);e&&e[1]?(n="articleDOI",a=e[1]):(n="q",a=o)}else n=o,a=t;e.append(n,a)}))}else"radio"===t.type||"checkbox"===t.type?"resource"===t.name?t.checked||"true"===t.checked?e.append(n,a):e.append(n,"images"):(t.checked||"true"===t.checked)&&e.append(n,a):e.append(n,a)}));else if("as"===t){log.info("- form2qs(): advanced search");["page","size","resource","refreshCache"].forEach((t=>{const n=a(`input[name=${t}]`);"resource"===t?n.checked||"true"===n.checked?e.append(t,n.value):e.append(t,"images"):(n.checked||"true"===n.checked)&&e.append(t,n.value)}));["q","treatmentTitle","authorityName","articleTitle","journalTitle","journals_id","collectionCode"].forEach((t=>{const n=a(`input[name="as-${t}"]`);n.value&&e.append(t,n.value)}));["status","refreshCache"].forEach((t=>{const n=a(`input[name="as-${t}"]`);(n.checked||"true"===n.checked)&&e.append(t,n.value)}));const t=["journalYear","publicationDate","checkinTime","biome"],o=t=>{const n=a(`select[name="as-${t}"]`),o=n.selectedIndex,i=n.options[o].value;if(i)if("journalYear"===t)e.append(t,i);else if("biome"===t)e.append(t,i);else if("between"===i){const n=a(`input[name="as-${t}From`),o=n.value,i=a(`input[name="as-${t}To`),s=i.value;if(o&&s)e.append(t,`between(${o} and ${s})`);else{let e=!0;if(""===o&&(n.classList.add("required"),e=!1),""===s&&(i.classList.add("required"),e=!1),!e)return!1}}else{const n=a(`input[name="as-${t}From`);console.log(t);const o=n.value;if(!o)return n.classList.add("required"),!1;e.append(t,`${i}(${o})`)}return!0};for(const e of t){if(!o(e)){n=!1;break}}["geolocation"].forEach((t=>{const n=a(`input[name="as-${t}"]`);n.value&&e.append(t,n.value)}))}if(n){const t=e.toString();return console.log(t),t}return console.log("false"),!1},Q=e=>{log.info("- updateUrl(qs)");const t=`?${e}`;history.pushState({},"",t)},X=e=>{const t=36e5,n=864e5;let a=Math.floor(e/n),o=Math.floor((e-a*n)/t),i=Math.round((e-a*n-o*t)/6e4);const s=e=>e<10?"0"+e:e;return 60===i&&(o++,i=0),24===o&&(a++,o=0),`${a} days ${s(o)} hours ${s(i)} mins`},ee=e=>{const t=e.getFullYear(),n=e.getMonth(),a=e.getDate(),o=e.getHours(),s=e.getMinutes(),r=e.getSeconds();return`${a} ${i.months[n]}, ${t} ${o}:${s}:${r}`};function te(){new autoComplete({selector:'input[name="as-journalTitle"]',minChars:2,source:async function(e,t){e=e.toLowerCase();const n=await async function(){if(i.cache.journals)return i.cache.journals;{const e=`${i.server}/journals?size=1100&sortby=journalTitle:asc`,t=await fetch(e);if(t.ok){const e=(await t.json()).item.result.records;if(e)return i.cache.journals=e.map((e=>({journals_id:e.journals_id,journalTitle:e.journalTitle}))),i.cache.journals}else alert("HTTP-Error: "+t.status)}}(),a=[];for(let t=0;t<n.length;t++)~n[t].journalTitle.toLowerCase().indexOf(e)&&a.push({journals_id:n[t].journals_id,journalTitle:n[t].journalTitle});t(a)},renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");const n=new RegExp("("+t.split(" ").join("|")+")","gi"),a=e.journalTitle.replace(n,"<b>$1</b>");return`<div class="autocomplete-suggestion" data-id="${e.journals_id}" data-val="${e.journalTitle}">${a}</div>`},onSelect:function(e,t,n){document.querySelector(keySelector).value=n.getAttribute("data-id")}})}function ne(){new autoComplete({selector:'input[name="as-collectionCode"]',minChars:2,source:async function(e,t){e=e.toLowerCase();const n=await async function(){if(i.cache.collectionCodes)return i.cache.collectionCodes;{const e=`${i.server}/collectioncodes?cols=collectionCode&cols=name&size=4300`,t=await fetch(e);if(t.ok){const e=(await t.json()).item.result.records;if(e)return i.cache.collectionCodes=e.map((e=>({collectionCode:e.collectionCode,name:e.name}))),i.cache.collectionCodes}else alert("HTTP-Error: "+t.status)}}(),a=[];for(let t=0;t<n.length;t++)~n[t].collectionCode.toLowerCase().indexOf(e)&&a.push({collectionCode:n[t].collectionCode,name:n[t].name});t(a)},renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");const n=new RegExp("("+t.split(" ").join("|")+")","gi");let a=e.collectionCode.replace(n,"<b>$1</b>");return e.name&&(a+=` (${e.name})`),`<div class="autocomplete-suggestion" data-id="${e.collectionCode}">${a}</div>`},onSelect:function(e,t,n){document.querySelector('input[name="as-collectionCode"]').value=n.getAttribute("data-id")}})}var ae;function oe(){const e=new URLSearchParams(window.location.hash.substring(1));if("maps"===(e?e.get("show"):"index"))v({mapContainer:"map",baseLayerSource:"geodeo",drawControl:!1});else{const e=new URL(location);if(e.search){log.info(`- locSearch: ${e.search.substring(1)}`),J(e.search.substring(1));const t=Y();Z(t)}else K("images");log.info("- addListeners()"),a("#refreshCache").addEventListener("click",z),a("#ns-go").addEventListener("click",E),a("#as-go").addEventListener("click",q),a("#q").addEventListener("focus",O),a("#search-help").addEventListener("click",k),a("div.examples").addEventListener("toggle",T,!0),o(".modalToggle").forEach((e=>e.addEventListener("click",j))),o(".example-insert").forEach((e=>e.addEventListener("click",S))),a("input[name=searchtype").addEventListener("click",_),a("input[name=resource").addEventListener("click",x),a('select[name="as-publicationDate"]').addEventListener("change",H),a('select[name="as-checkinTime"]').addEventListener("change",H),o("input[type=date").forEach((e=>e.addEventListener("change",C))),o("#charts-container").forEach((e=>{new c(e)})),document.addEventListener("keydown",b),o("a.quicksearch").forEach((e=>e.addEventListener("click",w))),te(),ne()}}log.level=log[(ae=window.location.hostname,"localhost"===ae?"INFO":"ERROR")];export{P as hideTooltip,oe as init,v as initializeMap,A as showTooltip};
