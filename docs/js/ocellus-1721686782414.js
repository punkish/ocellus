/* generated: Tue Jul 23 2024 00:19:42 GMT+0200 (Central European Summer Time) */
const e=e=>document.querySelector(e),t=e=>document.querySelectorAll(e),a={server:"localhost"===window.location.hostname?"http://localhost:3010/v3":"https://test.zenodeo.org/v3",cache:{yearlyCounts:{yearlyCounts:!1,totals:!1}},figureSize:{normal:250,small:100,tiny:50},results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],params:{notValidQ:["resource","page","size","grid","refreshCache","cols"],validImages:["httpUri","caption","captionText","q","treatmentId","treatmentTitle","articleTitle","treatmentDOI","articleDOI","zenodoDep","authorityName","status","journalTitle","journalYear","kingdom","phylum","class","family","order","genus","species","publicationDate","checkinTime","latitude","longitude","geolocation","isOnLand","validGeo","eco_name","biome","biome_id"],validTreatments:["treatmentId","treatmentTitle","treatmentDOI","zenodoDep","articleTitle","articleDOI","publicationDate","journalYear","authorityName","status","checkinTime","validGeo","q","latitude","longitude","geolocation","eco_name","biome","isOnLand","journalTitle","kingdom","phylum","class","family","order","genus","species"],validCommon:["refreshCache","page","size","cols","groupby"],notValidSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit","source","grid"],images:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","httpUri","caption","latitude","longitude"],treatments:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","journalTitle","latitude","longitude"]},maps:{},hiddenClasses:["hidden","noblock"],closedFigcaptionHeight:"30px",zenodoUri:"https://zenodo.org/records",tbUri:"https://tb.plazi.org/GgServer/html",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],treatmentIcon:{iconUrl:"/img/treatment.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]},treatmentIconHighlighted:{iconUrl:"/img/treatment-highlighted.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]},months:["January","February","March","April","May","June","July","August","September","October","November","December"],charts:{termFreq:null,yearlyCounts:null}},s=function({selector:e,helpText:t,facets:a,cb:s}){const n=a.map((e=>e.key)),r=s;let i;const o=function({element:e,attribs:t,container:a}){const s=document.createElement(e);for(let[e,a]of Object.entries(t))"innerText"===e||"innerHTML"===e?s[e]=a:s.setAttribute(e,a);return a.appendChild(s),s},l=function(){const e=o({element:"div",attribs:{class:"fs-param-empty"},container:i});o({element:"div",attribs:{class:"fs-key fs-off"},container:e});const t=o({element:"input",attribs:{class:"query fs-key-input",placeholder:"choose a key…"},container:e});o({element:"div",attribs:{class:"fs-val fs-off"},container:e});const a=o({element:"input",attribs:{class:"query fs-val-input fs-off",placeholder:"choose a value…"},container:e}),s=o({element:"button",attribs:{class:"fs-cancel fs-off",type:"reset",innerHTML:"&#8855;"},container:e});t.addEventListener("keydown",c),a.addEventListener("keydown",c),s.addEventListener("click",d),u({type:"key",selector:t,values:n}),t.focus()},c=function(e){const t=(e=e||window.event).which||e.keyCode;let a=e.target;const s=a.parentElement,n=s.children[2],r=s.children[3],i=s.children[4];if(13==t)return""!==r.value&&(s.className="fs-param-filled",n.innerText=r.value,n.className="fs-val fs-on",r.className="fs-off",i.className="fs-cancel fs-on",l()),e.preventDefault(),e.stopPropagation(),!1;if((8==t||46==t)&&""===a.value){const e=`div#${fsDiv.id} div.fs-param-filled`,t=document.querySelectorAll(e),a=t[t.length-1];if(a)"fs-param-filled"===a.className?a.className="fs-param-filled fs-hilite":(a.className="fs-param-filled fs-hilite")&&a.parentElement.removeChild(a);else{const e=`div#${fsDiv.id} div.fs-param-empty`,t=document.querySelectorAll(e),a=t[t.length-1];a.parentElement.removeChild(a)}}},d=function(e){const t=this.parentElement;t.parentElement.removeChild(t)},u=function({type:e,selector:t,values:s}){new autoComplete({selector:t,source:async function(e,t){let a=[];if("function"==typeof s)a=s();else if("object"==typeof s&&s.url){const t=await fetch(`${s.url}${e}*`);if(!t.ok)throw Error("HTTP-Error: "+t.status);a=await s.cb(t)}else Array.isArray(s)&&(a=s);if(a.length){const s=[];for(let t=0;t<a.length;t++)~a[t].toLowerCase().indexOf(e)&&s.push(a[t]);t(s)}},minChars:Array.isArray(s)?0:3,delay:150,onSelect:function(t,s,r){const i=this.selector,o=i.parentElement;if("key"===e){const e=o.children[0];e.innerText=i.value,e.className="fs-key fs-on",i.className="fs-off";const t=a.filter((e=>e.key===s))[0];t.noDuplicates&&n.splice(n.indexOf(s),1);const r=o.children[3];r.className="fs-val-input fs-on",r.placeholder=t.prompt,u({type:"val",selector:r,values:t.values}),r.focus()}else if("val"===e){const e=o.children[2];s&&(e.innerText=i.value,e.className="fs-val fs-on"),i.className="fs-off",o.className="fs-param-filled",o.children[4].className="fs-cancel fs-on",l()}}})},m=function(e){const t=i.childNodes;let s={},n=0;const r=t.length;for(;n<r;n++){const e=t[n].children,r=e[1].value;if(r){const t=e[3].value.replace(/\n$/,""),n=a.filter((e=>e.key===r))[0].actualKey;if(n&&t)if(n in s)if("string"==typeof s[n]){const e=s[n];s[n]=[e,t]}else s[n].push(t);else s[n]=t}}e(s)};!function(e,t){const a=o({element:"div",attribs:{id:"fs-widget"},container:e});i=o({element:"div",attribs:{id:"fs",class:"fs"},container:a});const s=o({element:"div",attribs:{class:"switch resource regular pill green","aria-label":"toggle resource","data-pop":"right","data-pop-no-shadow":!0,"data-pop-arrow":!0},container:i});o({element:"input",attribs:{type:"radio",id:"switchResource-3",name:"resource",value:"images",class:"query",autocomplete:"off"},container:s}),o({element:"label",attribs:{for:"switchResource-3"},container:s}),o({element:"input",attribs:{type:"radio",id:"switchResource-4",name:"resource",value:"treatments",class:"query",autocomplete:"off"},container:s}),o({element:"label",attribs:{for:"switchResource-4"},container:s}),o({element:"button",attribs:{id:"fs-go",type:"submit",class:"fs-button-primary",innerText:"go"},container:a}).addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),m(r)})),l()}(e)},n=s=>{log.info(`- qs2form(qs)\n    - qs: ${s}`);const n=new URLSearchParams(s);n.delete("refreshCache");const r=[];n.forEach(((s,n)=>{if(log.info(`val: ${s}, key: ${n}`),a.params.notValidQ.includes(n))"resource"===n?(log.info(`setting form to query resource ${s}`),v(s),Array.from(t("input[name=resource]")).filter((e=>e.value===s))[0].checked="true"):e(`input[name=${n}]`).value=s;else{let e=n;s&&(e="q"===n?decodeURIComponent(s):`${n}=${s}`),r.push(e)}})),e("#q").value=r.join("&")};function r(e){const t=document.getElementById("charts");let a=960;return t.offsetWidth<a&&(a=t.offsetWidth-100),e.style.display="block",e.style.width=`${a}px`,e.style.textAlign="center",e.style.margin="0 auto",e}function i(e,t){return e<1e3?e:e>=1e3&&e<1e6?e/1e3+"K":e>=1e6&&e<1e7?e/1e6+"M":void 0}const o=({yearlyCounts:e,totals:t})=>{const s=r(document.querySelector("#yearlyCounts"));s.innerHTML="";const n="Images",{years:o,series:l}=function(e,t){const a=[],s=[];"Treatments"===e||"Images"===e?(s.push({name:"Treatments",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_treatments))}),s.push({name:"Images",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_images))}),s.push({name:"Species",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_species))}),s.push({name:"Journals",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_journals))}),t.forEach((e=>a.push(e.year)))):(s.push({name:e,type:"bar",emphasis:{focus:"series"},data:t.map((t=>t[`num_of_${e.toLowerCase()}`]))}),t.forEach((e=>a.push(e.year))));return{years:a,series:s}}(n,e),c=function(e,t,a){return{legend:{left:65,top:60,orient:"horizontal",borderWidth:1,borderRadius:5,borderColor:"#444",backgroundColor:"#fff"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{precision:"0"}},formatter:'<div class="leg">\n    year {b}\n    <hr>\n    <div class="dot b"></div>{a0}: {c0}<br/>\n    <div class="dot g"></div>{a1}: {c1}<br/>\n    <div class="dot y"></div>{a2}: {c2}<br/>\n    <div class="dot r"></div>{a3}: {c3}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",splitLine:{show:!1},data:t}],yAxis:[{type:"value",axisLabel:{formatter:i}}],series:a}}(0,o,l),d=document.createElement("div");d.style.width="100%",d.style.height="200px",d.classList.add("viz"),s.appendChild(d),a.charts.yearlyCounts=echarts.init(d),a.charts.yearlyCounts.setOption(c);const u=t.treatments,m=t.images,h=t.species,p=t.journals,f=c.xAxis[0].data,g=function({resource:e,imagesTotal:t,treatmentsTotal:a,speciesTotals:s,journalsTotals:n,num_of_years:r}){let i="Treatments"===e?`with <span>${t}</span> images, and`:`in <span>${a}</span> treatments of`;i+=` <span>${s}</span> species from <span>${n}</span> journals`,r&&(i+=` over <span>${r}</span> years`);return i}({resource:n,imagesTotal:m,treatmentsTotal:u,speciesTotals:h,journalsTotals:p,num_of_years:f[f.length-1]-f[0]}),y=document.createElement("div");y.style.width="100%",y.classList.add("caption"),s.appendChild(y),y.innerHTML=g};const l=({resource:e,figureSize:t,rec:s})=>{const n={figureSize:t,rec:s};return"images"===e?(({figureSize:e,rec:t})=>{const s=t.zenodoRec?`<img src="img/zenodo-gradient-35.png" width="35" height="14"> <a href="${a.zenodoUri}/${t.zenodoRec}" target="_blank">more on Zenodo</a>`:"",n=`<img src="img/treatmentBankLogo.png" width="35" height="14"> <a href="${a.tbUri}/${t.treatmentId}" target="_blank">more on TreatmentBank</a>`,r=250===e?"visible":"noblock",i=`figure-${e}`+(t.treatmentId?" tb":""),o=`this.onerror=null; setTimeout(() => { this.src='${t.uri}' }, 1000);`;let l="";return t.latitude&&(l="this.parentNode.parentNode.parentNode.parentNode.style.height=this.height+150+'px'"),`<figure class="${i}">\n    <a class="zen" href="${t.fullImage}">\n        <img src="img/bug.gif" width="${t.figureSize}" data-src="${t.uri}" \n            class="lazyload" data-recid="${t.treatmentId}" \n            onerror="${o}"\n            onload="${l}">\n    </a>\n    <figcaption class="${r}">\n        <details>\n            <summary class="figTitle" data-title="${t.treatmentTitle}">\n                ${t.treatmentTitle}\n            </summary>\n            <p>${t.captionText}</p>\n            ${n}<br>\n            ${s}\n        </details>\n    </figcaption>\n</figure>`})(n):(({figureSize:e,rec:t})=>{let s="";t.zenodoRec&&(s=`<a href="${a.zenodoUri}/${t.zenodoRec}" target="_blank" title="more on Zenodo" alt="more on Zenodo"><img class="zenodoLink" src="img/zenodo-gradient-round.svg" width="50"></a>`);const n=250===e?"visible":"noblock",r=`figure-${e} `+(t.treatmentId?"tb":""),i=t.treatmentDOI?`<a href="https://dx.doi.org/${t.treatmentDOI}">${t.treatmentDOI}</a>`:"";let o="";return t.articleTitle&&(o+=`<span class="articleTitle">${t.articleTitle}</span>`),t.articleAuthor&&(o+=` by <span class="articleAuthor">${t.articleAuthor}</span>`),t.journalTitle&&(o+=` in <span class="journalTitle">${t.journalTitle}</span>`),i&&(o+=`. ${i}`),`<figure class="${r}">\n    <p class="treatmentTitle">${t.treatmentTitle}</p>\n    <p class="citation">${o}</p>\n    <figcaption class="${n}">\n        \x3c!--  --\x3e\n        <div>\n            ${s} <a href="${a.tbUri}/${t.treatmentId}" target="_blank" title="more on TreatmentBank" alt="more on TreatmentBank"><img class="tbLink" src="img/treatmentBankLogo.png" width="100"></a>\n        </div>\n    </figcaption>\n</figure>`})(n)};const c=({resource:t,figureSize:s,slides:l,qs:c,count:u,term:p,termFreq:f,yearlyCounts:y,prev:v,next:$,stored:b,ttl:k,cacheHit:L})=>{log.info(`- renderPage()\n    - figureSize: ${s}px\n    - figures: ${l.length} slides\n    - qs: ${c}\n    - count: ${u}\n    - prev: ${v}\n    - next: ${$}`),e("#grid-images").classList.add(`columns-${s}`),d(l,c,v,$),e("#throbber").classList.add("nothrob"),a.charts.termFreq&&(a.charts.termFreq.dispose(),e("#termFreq").style.visibility="hidden"),f&&f.length&&(((e,t)=>{const s=r(document.querySelector("#termFreq"));s.innerHTML="";const n="all",o="with images",l={legend:{left:55,top:60,orient:"vertical",borderWidth:1,borderRadius:5,borderColor:"silver",backgroundColor:"#fff"},tooltip:{trigger:"axis",formatter:'<div class="leg">\n    year {b}\n    <hr>\n    {a0}: {c0}<br/>\n    {a1}: {c1}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",splitLine:{show:!1},data:t.map((e=>e.journalYear))},yAxis:{type:"log",minorSplitLine:{show:!0},axisLabel:{formatter:i}},series:[{name:n,type:"line",data:t.map((e=>0==e.total?null:e.total)),color:"#f00",lineStyle:{color:"#f00",width:1}},{name:o,type:"line",data:t.map((e=>0==e.withImages?null:e.withImages)),color:"#00f",lineStyle:{color:"#00f",width:1}}]},c=document.createElement("div");c.style.width="100%",c.style.height="150px",c.classList.add("viz"),s.appendChild(c),a.charts.termFreq=echarts.init(c),a.charts.termFreq.setOption(l);const d=document.createElement("div");d.style.width="100%",d.classList.add("caption"),s.appendChild(d),d.innerHTML=`occurrence of <span>${e}</span> in the text by year`})(p,f),e("#termFreq").style.visibility="visible"),function(t,s,n,r,i){const o=new URLSearchParams(t);let l=o.get("resource");const c=[],d=[],u=[];a.params.notValidSearchCriteria.forEach((e=>o.delete(e)));const p='<span class="crit-key">',f='<span class="crit-val">',y='<span class="crit-count">',v="</span>",$={checkinTime:"checked in",updateTime:"updated",publicationDate:"published"};s?s<10&&(s=g(s)):s="Sorry, no";c.push(`${y}${s}${v}`),1===s&&(l=l.slice(0,-1));c.push(l),o.forEach(((e,t)=>{let a;if(Object.keys($).includes(t)){const n=e.match(/(?<operator1>eq|since|until)?\((?<date>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)|(?<operator2>between)?\((?<from>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\s*and\s*(?<to>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)/);if(n){if(a=`${p}${$[t]}${v}`,n.groups.operator1){let e;e="since"===n.groups.operator1?1===s?"has been":"have been":1===s?"was":"were",c.push(e),"eq"===n.groups.operator1?a+=" on":a+=` ${n.groups.operator1}`,a+=` ${f}${n.groups.date}${v}`}else n.groups.operator2&&(a+=` ${f}between${v} ${f}${n.groups.from}${v} and ${f}${n.groups.to}${v}`);d.push(a)}}else{const s=e.match(/(?<operator>\w+)\((?<term>[\w\s]+)\)/);if(s){const{operator:e,term:n}=s.groups;a=`${p}${t}${v}${e.replace(/_/," ")} ${f}${n}${v}`}else a="q"===t?`${p}${e}${v} is in the text`:"captionText"===t?`${p}${e}${v} is in ${p}caption text${v}`:`${p}${t}${v} is ${f}${e}${v}`;u.push(a)}}));const b=[];d.length?b.push(...d):c.push("found");u.length&&c.push("where");let k;b.push(...u);const L=b.length;k=1===L?b[0]:2===L?`${b[0]} and ${b[1]}`:`${b.slice(0,L-2).join(", ")}, and ${b[L-1]}`;if(c.push(k),i){const e=new Date(n),t=new Date(n+r)-new Date;c.push(`<span aria-label="cache hit, stored ${h(e)}, expires in ${m(t)}" data-html="true" data-pop="top" data-pop-no-shadow data-pop-arrow data-pop-multiline>💥</span>`)}e("details.charts summary").innerHTML=c.join(" "),e("#charts-container summary").style.visibility="visible"}(c,u,b,k,L),a.charts.yearlyCounts&&(a.charts.yearlyCounts.dispose(),e("#yearlyCounts").style.visibility="hidden"),y&&(o({yearlyCounts:y.yearlyCounts,totals:y.totals}),e("#yearlyCounts").style.visibility="visible"),(f||y)&&(e("#charts").style.visibility="visible");e("input[name=searchtype]").checked&&(e("input[name=searchtype]").checked=!1,C(),n(c)),"images"===t&&new SimpleLightbox({elements:"figure",loadingCaption:'<img src="../../img/bug.gif">'})},d=(s,n,r,i)=>{log.info("- renderSlides()"),s.length?(e("#grid-images").innerHTML=s.join(""),u(n,r,i),R(),U(),t(".carouselbox").forEach((e=>{!function(e){const t=e.querySelector(".next"),s=e.querySelector(".prev");let n=0;const r=e.querySelectorAll(".content .slide"),i=r.length;let o=r[0];function l(e){o.classList.remove("current"),n+=e,-1===e&&n<0&&(n=i-1),1!==e||r[n]||(n=0),o=r[n],o.classList.add("current")}e.classList.add("active"),t.addEventListener("click",(function(e){l(1),function(e){const t=e.currentTarget,s=[t.dataset.latitude,t.dataset.longitude];if(!a.maps[t.dataset.id]){const e=L.map(`map-${t.dataset.id}`).setView(s,10);a.maps[t.dataset.id]=e,L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(e),L.marker(s).addTo(e)}}(e)})),s.addEventListener("click",(function(e){l(-1)})),l(0)}(e)}))):e("#grid-images").innerHTML=""},u=(t,a,s)=>{log.info("- renderPager()"),log.info(`  - qs: ${t}`),log.info(`  - prev: ${a}`),log.info(`  - next: ${s}`);const n=new URLSearchParams(t);n.delete("page"),e("#pager").innerHTML=`<a href="?${n.toString()}&page=${a}">prev</a> <a href="?${n.toString()}&page=${s}">next</a>`,e("#pager").classList.add("filled"),O()};const m=e=>{const t=36e5,a=864e5;let s=Math.floor(e/a),n=Math.floor((e-s*a)/t),r=Math.round((e-s*a-n*t)/6e4);const i=e=>e<10?"0"+e:e;return 60===r&&(n++,r=0),24===n&&(s++,n=0),`${s} days ${i(n)} hours ${i(r)} mins`},h=e=>{const t=e.getFullYear(),s=e.getMonth(),n=e.getDate(),r=e.getHours(),i=e.getMinutes(),o=e.getSeconds();return`${n} ${a.months[s]}, ${t} ${r}:${i}:${o}`},p=async t=>{log.info("- getResource(qs)"),e("#throbber").classList.remove("nothrob");const s=new URLSearchParams(t),n=s.get("page"),r=s.get("size"),i=s.get("grid")||"normal",o=a.figureSize[i],d=s.get("resource");let u;s.delete("resource"),s.has("q")&&(u=s.get("q"));const m="images"===d?a.params.validImages:a.params.validTreatments;m.push(...a.params.validCommon);let h=!0;if(Array.from(s).forEach((([e,t])=>{m.includes(e)?t||(s.set("q",e),s.delete(e),u=e):(S(`"${e}" is not a valid param`),h=!1)})),!1===h)return;const p="images"===d?`${a.params.images.join("&cols=")}&groupby=images.id`:`${a.params.treatments.join("&cols=")}&groupby=treatments.id`;let g=`${s.toString()}&cols=${p}`;u&&(g+="&termFreq=true"),s.has("treatmentId")||(g+="&yearlyCounts=true");const y=[];y.push(f({resource:d,queryString:g,figureSize:o})),Promise.all(y).then((e=>{const t={resource:d,prev:n>1?n-1:1,next:parseInt(n)+1,size:r,count:0,recs:[]};return e.forEach((e=>{void 0!==e&&(t.recs.push(...e.recs),t.count+=e.count,t.termFreq=e.termFreq,t.yearlyCounts=e.yearlyCounts,t.cacheHit=e.cacheHit,t.stored=e.stored,t.ttl=e.ttl)})),t})).then((e=>{const a=e.recs.map((e=>function({resource:e,figureSize:t,rec:a}){const s=l({resource:e,figureSize:t,rec:a}),n="images"===e?`${a.treatments_id}-${a.images_id}`:a.treatments_id;return a.latitude&&a.longitude?`\n        <div class="carouselbox">\n            <div class="buttons">\n                <button class="prev">◀ <span class="offscreen">Previous</span></button>\n                <button class="next map" \n                    data-latitude="${a.latitude}" \n                    data-longitude="${a.longitude}" \n                    data-id="${n}"><span class="offscreen">Next</span> ▶</button>\n            </div>\n            <div class="content">\n                <div class="slide">\n                    ${s}\n                </div>\n                <div id="map-${n}" class="map slide"></div>\n            </div>\n        </div>`:`\n        <div class="slidr">\n            ${s}\n        </div>`}({resource:d,figureSize:o,rec:e}))),s={resource:d,figureSize:o,slides:a,qs:t,count:e.count,prev:e.prev,next:e.next,stored:e.stored,ttl:e.ttl,cacheHit:e.cacheHit};e.termFreq&&(s.termFreq=e.termFreq,s.term=u),e.yearlyCounts&&(s.yearlyCounts=e.yearlyCounts),c(s)}))},f=async({resource:e,queryString:t,figureSize:s})=>{log.info(`- getResults({ resource, queryString, figureSize })\n    - resource: ${e}\n    - queryString: ${t},\n    - figureSize: ${s}`);const n=`${a.server}/${e}?${t}`,r=await fetch(n);if(r.ok){const t=await r.json(),n=t.item.result.records;let i;if(t.item.result.yearlyCounts){i={};const e=t.item.result.yearlyCounts,a=e.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});i.yearlyCounts=e,i.totals=a}const o={resource:e,count:0,recs:[],termFreq:t.item.result.termFreq,yearlyCounts:i,prev:"",next:"",stored:t.stored,ttl:t.ttl,cacheHit:t.cacheHit||!1};if(n)return o.count=o.count+t.item.result.count,n.forEach((t=>{const n={};if("images"===e){n.treatmentId=t.treatmentId,n.treatments_id=t.treatments_id,n.images_id=t.images_id,n.treatmentTitle=t.treatmentTitle,n.zenodoRec=t.zenodoDep,n.figureSize=s;const e=t.httpUri.split("/")[4];t.httpUri.indexOf("zenodo")>-1?t.httpUri.indexOf(".svg")>-1?(n.uri="/img/kein-preview.png",n.fullImage="/img/kein-preview.png"):(n.uri=`${a.zenodoUri}/${e}/thumb${s}`,n.fullImage=`${a.zenodoUri}/${e}/thumb1200`):(n.uri=t.httpUri,n.fullImage=t.httpUri),n.captionText=t.captionText,n.treatmentDOI=t.treatmentDOI,n.articleTitle=t.articleTitle,n.articleAuthor=t.articleAuthor,n.latitude=t.latitude,n.longitude=t.longitude}else"treatments"===e&&(n.treatmentId=t.treatmentId,n.treatments_id=t.treatments_id,n.treatmentTitle=t.treatmentTitle,n.zenodoRec=t.zenodoDep,n.figureSize=s,n.journalTitle=t.journalTitle,n.treatmentDOI=t.treatmentDOI,n.articleTitle=t.articleTitle,n.articleAuthor=t.articleAuthor,n.latitude=t.latitude,n.longitude=t.longitude);o.recs.push(n)})),o}else alert("HTTP-Error: "+r.status)},g=e=>e<10?["One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][e-1].toLowerCase():e,y=()=>{log.info("submitForm()");const e=$();if(!e)return!1;b(e),p(e)},v=async e=>{const t=await(async(e,t)=>{if(!a.cache.yearlyCounts.yearlyCounts){let s=`${a.server}/${e}?cols=`;t&&(s+="&yearlyCounts=true");const n=await fetch(s);if(n.ok){const s=await n.json(),r=s.item.result.count;if(t){const e=s.item.result.yearlyCounts,t=e.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});a.cache.yearlyCounts.yearlyCounts=e,a.cache.yearlyCounts.totals=t}else a.cache.yearlyCounts.totals[e]=r}else alert("HTTP-Error: "+n.status)}return a.cache.yearlyCounts})(e,!0);((e,t)=>{const{images:a,treatments:s,species:n,journals:r}=t.totals,i=t.yearlyCounts,o="images"===e?a:s,l=i.length,c=3*l;Math.max(...i);const d=40/o;function u(t,a,s,n,r,i,o){return`<g class="${a}" transform="translate(${t*r},0)">\n            <rect height="${s}" y="${n-s}" width="${r}" onmousemove="showTooltip(evt, '${i}: ${o} ${e}');" onmouseout="hideTooltip();"></rect>\n        </g>`}let m=`<svg id="svgSpark" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="chart" height="40" width="${c}" aria-labelledby="title" role="img">`;for(let t=0;t<l;t++){const a=i[t].year,s=i[t][`num_of_${e}`];m+=u(t,"bar",s*d,40,3,a,s)}m+="</svg>";const h=document.querySelector("#sparkBox");let p=m;p+="images"===e?` <span>~${Math.ceil(o/1e3)}K</span> ${e}, <span>~${Math.ceil(s/1e3)}K</span> treatments, `:`<span>~${Math.ceil(o/1e3)}K</span> ${e}, <span>~${Math.ceil(a/1e3)}K</span> images, `,p+=`<span>~${Math.ceil(n/1e3)}K</span> species from <span>~${Math.ceil(r/1e3)}K</span> journals`,h.innerHTML=p})(e,t)},$=()=>{log.info("- form2qs()");const a=new URLSearchParams;let s=!0;if("ss"===(!0===e("input[name=searchtype").checked?"as":"ss"))log.info("- form2qs(): simple search"),Array.from(t("form input.query")).filter((e=>e.value)).forEach((e=>{let t=e.name,s=e.value;if("q"===e.name){const n=e.value.replaceAll(/ & /g,"%20%26%20");new URLSearchParams(n).forEach(((e,n)=>{if(""===e){const e=s.match(/(^10\.[0-9]{4,}.*)/);e&&e[1]?(t="articleDOI",s=e[1]):(t="q",s=n)}else t=n,s=e;a.append(t,s)}))}else"radio"===e.type||"checkbox"===e.type?(e.checked||"true"===e.checked)&&a.append(t,s):a.append(t,s)}));else{log.info("- form2qs(): advanced search");["page","size","resource","refreshCache"].forEach((t=>{const s=e(`input[name=${t}]`);(s.checked||"true"===s.checked)&&a.append(t,s.value)}));["q","treatmentTitle","authorityName","articleTitle","journalTitle"].forEach((t=>{const s=e(`input[name="as-${t}"]`);s.value&&a.append(t,s.value)}));["status","refreshCache"].forEach((t=>{const s=e(`input[name="as-${t}"]`);(s.checked||"true"===s.checked)&&a.append(t,s.value)}));const t=["journalYear","publicationDate","checkinTime","biome"],n=t=>{const s=e(`select[name="as-${t}"]`),n=s.selectedIndex,r=s.options[n].value;if(r)if("journalYear"===t)a.append(t,r);else if("biome"===t)a.append(t,r);else if("between"===r){const s=e(`input[name="as-${t}From`),n=s.value,r=e(`input[name="as-${t}To`),i=r.value;if(n&&i)a.append(t,`between(${n} and ${i})`);else{let e=!0;if(""===n&&(s.classList.add("required"),e=!1),""===i&&(r.classList.add("required"),e=!1),!e)return!1}}else{const s=e(`input[name="as-${t}From`);console.log(t);const n=s.value;if(!n)return s.classList.add("required"),!1;a.append(t,`${r}(${n})`)}return!0};for(const e of t){if(!n(e)){s=!1;break}}}if(s){return a.toString()}return!1},b=e=>{log.info("- updateUrl(qs)"),history.pushState("",null,`?${e}`)};class k{constructor(e){this.el=e,this.summary=e.querySelector("summary"),this.content=e.querySelector("#charts"),this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.summary.addEventListener("click",(e=>this.onClick(e)))}onClick(e){e.preventDefault(),this.el.style.overflow="hidden",this.isClosing||!this.el.open?this.open():(this.isExpanding||this.el.open)&&this.shrink()}shrink(){this.isClosing=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!1),this.animation.oncancel=()=>this.isClosing=!1}open(){this.el.style.height=`${this.el.offsetHeight}px`,this.el.open=!0,window.requestAnimationFrame((()=>this.expand()))}expand(){this.isExpanding=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight+this.content.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!0),this.animation.oncancel=()=>this.isExpanding=!1}onAnimationFinish(e){this.el.open=e,this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.el.style.height=this.el.style.overflow=""}}const w=()=>{log.info("- addListeners()"),e("#refreshCache").addEventListener("click",_),e("#ns-go").addEventListener("click",I),e("#as-go").addEventListener("click",j),e("#q").addEventListener("focus",F),e("#search-help").addEventListener("click",x),e("div.examples").addEventListener("toggle",D,!0),t(".modalToggle").forEach((e=>e.addEventListener("click",H))),t(".reveal").forEach((e=>e.addEventListener("click",N))),t(".example-insert").forEach((e=>e.addEventListener("click",A))),t("input[name=searchType").forEach((e=>e.addEventListener("click",E))),e("#advSearch").addEventListener("click",C),t(".resource input").forEach((e=>e.addEventListener("click",z))),e('select[name="as-publicationDate"]').addEventListener("change",P),e('select[name="as-checkinTime"]').addEventListener("change",P),t("input[type=date").forEach((e=>e.addEventListener("change",q))),t("#charts-container").forEach((e=>{new k(e)})),document.addEventListener("keydown",T)};function T(t){if("/"===t.key){if(/^(?:input|textarea|select|button)$/i.test(t.target.tagName))return;const a=e("#q");a.setSelectionRange(0,a.value.length),a.focus(),t.preventDefault()}}const x=t=>{const a=e(".examples").classList;a.contains("hidden")?a.remove("hidden"):a.add("hidden")},q=e=>{const t=e.target.classList;t.contains("required")&&t.remove("required")},S=t=>{e(".warn").classList.contains("hidden")&&(e(".warn").innerHTML=t,e(".warn").classList.remove("hidden"),e("#throbber").classList.add("nothrob"),setTimeout((()=>{e(".warn").innerHTML="",e(".warn").classList.add("hidden")}),3e3))},C=t=>{log.info("- toggling advanced search"),e("#as-container").classList.toggle("noblock");e("input[name=searchtype]").checked?(e("#q").value="",e("#q").placeholder="use advanced search below",e("#q").disabled=!0,e("#refreshCache").disabled=!0,e("#clear-q").disabled=!0,e('input[name="as-q"]').focus()):(e("#q").placeholder="search for something",e("#q").disabled=!1,e("#refreshCache").disabled=!1,e("#clear-q").disabled=!1)},E=a=>{e("#fancySearch").classList.toggle("hidden"),e("#fancySearch").classList.toggle("noblock"),e("#normalSearch").classList.toggle("hidden"),e("#normalSearch").classList.toggle("noblock");const s=Array.from(t("input[name=searchType]")).filter((e=>e.checked))[0].value;if(a){if("true"===a.target.dataset.checked){const t=e("input[name=searchType][data-checked=false]");t.dataset.checked=!0,t.checked=!0,a.target.dataset.checked="false",a.target.checked=!1}else{const t=e("input[name=searchType][data-checked=true]");t.dataset.checked=!1,t.checked=!1,a.target.dataset.checked="true",a.target.checked=!0}const n="fs"===s?"#fs":window.location.pathname;history.pushState?history.pushState(null,null,n):location.hash=n;const r=Array.from(t("input[name=resource]")),i=r.filter((e=>e.checked))[0],o=r.filter((e=>!e.checked&&e.value===i.value))[0];i.checked=!1,o.checked=!0}else{e("ns"===s?"#switchSearch-1":"#switchSearch-2").checked=!0}},z=e=>{const a=Array.from(t("input[name=resource]")).filter((e=>e.checked))[0];v(a.value)},D=e=>{if(e.target.open){var a=t("details[open]");Array.prototype.forEach.call(a,(function(t){t!==e.target&&t.removeAttribute("open")}))}},A=a=>{e("#q").value=a.target.textContent,e("#ns-go").classList.add("glowing");t("input[name=source").forEach((e=>{"treatments"===e.value&&(e.checked=!0)})),x(),a.stopPropagation(),a.preventDefault()},_=t=>{e("#refreshCache").toggleAttribute("data-pop-show")},I=t=>{""===e("#q").value?(M(),setTimeout(F,4e3)):(e("#q").classList.remove("red-placeholder"),e("#throbber").classList.remove("nothrob"),e("#ns-go").classList.remove("glowing"),y()),t.stopPropagation(),t.preventDefault()},j=t=>{e("#throbber").classList.remove("nothrob"),y(),t.stopPropagation(),t.preventDefault()},H=s=>{const n=new URL(s.target.href).hash,r=t(".modal");n.length>0?(r.forEach((e=>{e.classList.add(...a.hiddenClasses)})),e(n).classList.remove(...a.hiddenClasses)):r.forEach((e=>e.classList.add(...a.hiddenClasses)))},M=()=>{e("#q").placeholder="c'mon, type something",e("#q").classList.add("red-placeholder")},F=t=>{e("#q").placeholder="search for something",e("#q").classList.remove("red-placeholder"),e("#refreshCache").checked=!1},N=t=>{const a=t.target.innerText;t.target.innerText=t.target.dataset.reveal,e("#brand").classList.add("smallbrand"),setTimeout((()=>{t.target.innerHTML=a,e("#brand").classList.remove("smallbrand")}),2e3),t.stopPropagation(),t.preventDefault()},R=()=>{const e=t("figcaption > details");for(let t=0,a=e.length;t<a;t++)e[t].addEventListener("toggle",(a=>{const s=a.target.querySelector("summary"),n=s.dataset.title,r=n.length>30?`${n.substring(0,30)}…`:n;e[t].open?s.innerText=n:s.innerText=r}))},O=()=>{log.info("- listeners.addListenersToPagerLinks()")},U=()=>{const e=t("figure .reveal");for(let t=0,a=e.length;t<a;t++)e[t].addEventListener("click",N)};const P=e=>{if("between"===e.target.value){e.target.parentNode.querySelectorAll(".hidden").forEach((e=>{e.classList.contains("hidden")&&(e.classList.remove("hidden"),e.classList.add("vis"))}))}else{e.target.parentNode.querySelectorAll(".vis").forEach((e=>{e.classList.add("hidden"),e.classList.remove("vis")}))}};function K(e,t){const a=document.getElementById("tooltip");a.innerHTML=t,a.style.display="block",a.style.left=e.offsetX+"px",a.style.top=e.offsetY+"px"}function B(){document.getElementById("tooltip").style.display="none"}const Y="localhost"===window.location.hostname?"INFO":"ERROR";log.level=log[Y];const W=()=>{const e=new URL(location),t="#fs"===e.hash?"fs":"ns";if(V(t),"fs"===t&&z(),e.search){(e=>{log.info("loadBookmarkedWebSite(qs)"),log.info(`- qs: ${e}`),w(),n(e),e=$(),p(e)})(e.search.substring(1))}else(async()=>{log.info("loadBlankWebSite()"),w(),v("images")})()},V=n=>{log.info("initializing fancySearch");const r=e=>async t=>{const a=await t.json(),s=[];return"biome"===e&&(e="biome_synonym"),a.item.result.records?a.item.result.records.forEach((t=>s.push(t[e]))):s.push("nothing found… please try again"),s},i=[{key:"text contains",actualKey:"q",values:"",prompt:"search the full text of treatments",noDuplicates:!0},{key:"title",actualKey:"treatmentTitle",values:"",prompt:"search for treatmentTitles starting with the search term",noDuplicates:!0},{key:"authority",actualKey:"authorityName",values:{url:`${a.server}/treatmentAuthors?treatmentAuthor=`,cb:r("author")},prompt:"type at least 3 letters to choose an author",noDuplicates:!0},{key:"family",actualKey:"family",values:{url:`${a.server}/families?family=`,cb:r("family")},prompt:"type at least 3 letters to choose a family",noDuplicates:!1},{key:"kingdom",actualKey:"kingdom",values:{url:`${a.server}/kingdoms?kingdom=`,cb:r("kingdom")},prompt:"type at least 3 letters to choose a kingdom",noDuplicates:!1},{key:"phylum",actualKey:"phylum",values:{url:`${a.server}/phyla?phylum=`,cb:r("phylum")},prompt:"type at least 3 letters to choose a phylum",noDuplicates:!1},{key:"class",actualKey:"class",values:{url:`${a.server}/classes?class=`,cb:r("class")},prompt:"type at least 3 letters to choose a class",noDuplicates:!1},{key:"genus",actualKey:"genus",values:{url:`${a.server}/genera?genus=`,cb:r("genus")},prompt:"type at least 3 letters to choose a genus",noDuplicates:!1},{key:"order",actualKey:"order",values:{url:`${a.server}/orders?order=`,cb:r("order")},prompt:"type at least 3 letters to choose an order",noDuplicates:!1},{key:"journal year",actualKey:"journalYear",values:((e,t)=>{const a=t-e;return Array.from({length:a},((t,a)=>a+e)).map((e=>String(e)))})(1995,2022),prompt:"pick a year of publication",noDuplicates:!0},{key:"biome",actualKey:"biome",values:{url:`${a.server}/biomes?biome=`,cb:r("biome")},prompt:"type at least 3 letters to choose a biome",noDuplicates:!1}];new s({selector:e("#fs-container"),helpText:"search images",facets:i,cb:a=>{const s=new URLSearchParams(a),n=Array.from(t("input[name=resource]")).filter((e=>e.checked))[0].value,r=e("input[name=page").value,i=e("input[name=size").value;s.append("resource",n),s.append("page",r),s.append("size",i);const o=s.toString();b(o),p(o)}}),e("#fancySearch").classList.add("hidden"),e("#fancySearch").classList.add("noblock"),"fs"===n&&E()};export{B as hideTooltip,W as init,K as showTooltip};
