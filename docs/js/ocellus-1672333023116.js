/* generated: Thu Dec 29 2022 17:57:03 GMT+0100 (Central European Standard Time) */
const e=e=>document.querySelector(e),t=e=>document.querySelectorAll(e),a={server:"localhost"===window.location.hostname?"http://localhost:3010/v3":"https://test.zenodeo.org/v3",validFormFields:["page","size","source","q","refreshCache"],figureSize:250,results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],notq:["source","page","size","grid","refreshCache","cols"],validZenodo:["id","subtype","communities","q","creator","title","keywords"],validZenodeo:["httpUri","captionText","treatmentId","treatmentTitle","treatmentDOI","zenodoDep","q","journalTitle","journalYear","authorityName","kingdom","phylum","class","family","order","publicationDate","checkinTime","latitude","longitude","geolocation","isOnLand","validGeo","refreshCache","page","size","cols"],hiddenClasses:["hidden","noblock"],notInSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit","source","grid"],closedFigcaptionHeight:"30px",zenodoUri:"https://zenodo.org/record",tbUri:"https://tb.plazi.org/GgServer/html",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],treatmentIcon:{iconUrl:"/img/treatment.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]},treatmentIconHighlighted:{iconUrl:"/img/treatment-highlighted.svg",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[13,12]}},s=t=>{e(".examples").classList.contains("hidden")?e(".examples").classList.remove("hidden"):e(".examples").classList.add("hidden")},n=t=>{if(e("#fancySearch").classList.toggle("hidden"),e("#fancySearch").classList.toggle("noblock"),e("#normalSearch").classList.toggle("hidden"),e("#normalSearch").classList.toggle("noblock"),t){const t=e("#switch").checked?"#fs":"";history.pushState?history.pushState(null,null,t):location.hash=t}else e("#switch").checked=!e("#fancySearch").classList.contains("hidden")},r=a=>{const s=t("input[name=source"),n=Array.from(s).filter((e=>e.checked))[0];e("#q").placeholder=n.labels[0].innerHTML},o=e=>{if(e.target.open){var a=t("details[open]");Array.prototype.forEach.call(a,(function(t){t!==e.target&&t.removeAttribute("open")}))}},i=a=>{e("#q").value=a.target.textContent,e("#ns-go").classList.add("glowing");t("input[name=source").forEach((e=>{"treatments"===e.value&&(e.checked=!0)})),s(),a.stopPropagation(),a.preventDefault()},c=t=>{e("#refreshCach").toggleAttribute("data-pop-show")},l=t=>{""===e("#q").value?u(t):(e("#q").classList.remove("red-placeholder"),e("#throbber").classList.remove("nothrob"),e("#ns-go").classList.remove("glowing"),v()),t.stopPropagation(),t.preventDefault()},d=s=>{const n=new URL(s.target.href).hash,r=t(".modal");n.length>0?(r.forEach((e=>{e.classList.add(...a.hiddenClasses)})),e(n).classList.remove(...a.hiddenClasses)):r.forEach((e=>e.classList.add(...a.hiddenClasses)))},u=t=>{e("#q").placeholder="search for something",e("#q").classList.remove("red-placeholder"),t.stopPropagation(),t.preventDefault()},h=e=>{const t=e.target.innerText;e.target.innerText=e.target.dataset.reveal,setTimeout((()=>{e.target.innerHTML=t}),2e3),e.stopPropagation(),e.preventDefault()},p=e=>{const a=t("figcaption");for(let e=0,t=a.length;e<t;e++)a[e].querySelector("div").classList.remove("open"),a[e].querySelector("div").classList.add("closed");const s=e.target.parentElement;s.querySelector("div").classList.remove("closed"),s.querySelector("div").classList.add("open")},f=function({selector:e,helpText:t,facets:a,cb:s}){const n=a.map((e=>e.key)),r=s;let o,i;const c=function({element:e,attribs:t,container:a}){const s=document.createElement(e);for(let[e,a]of Object.entries(t))s[e]=a;return a.appendChild(s),s},l=function(){const e=c({element:"div",attribs:{className:"fs-param-empty"},container:i});c({element:"div",attribs:{className:"fs-key fs-off"},container:e});const t=c({element:"input",attribs:{className:"fs-key-input",placeholder:"choose a key…"},container:e});c({element:"div",attribs:{className:"fs-val fs-off"},container:e});const a=c({element:"input",attribs:{className:"fs-val-input fs-off",placeholder:"choose a value…"},container:e}),s=c({element:"button",attribs:{className:"fs-cancel fs-off",type:"reset",innerHTML:"&#8855;"},container:e});t.addEventListener("keydown",d),a.addEventListener("keydown",d),s.addEventListener("click",u),h({type:"key",selector:t,values:n}),t.focus()},d=function(e){const t=(e=e||window.event).which||e.keyCode;let a=e.target;const s=a.parentElement,n=s.children[2],r=s.children[3],o=s.children[4];if(13==t)return""!==r.value&&(s.className="fs-param-filled",n.innerText=r.value,n.className="fs-val fs-on",r.className="fs-off",o.className="fs-cancel fs-on",l()),e.preventDefault(),e.stopPropagation(),!1;if((8==t||46==t)&&""===a.value){const e=`div#${fsDiv.id} div.fs-param-filled`,t=document.querySelectorAll(e),a=t[t.length-1];if(a)"fs-param-filled"===a.className?a.className="fs-param-filled fs-hilite":(a.className="fs-param-filled fs-hilite")&&a.parentElement.removeChild(a);else{const e=`div#${fsDiv.id} div.fs-param-empty`,t=document.querySelectorAll(e),a=t[t.length-1];a.parentElement.removeChild(a)}}},u=function(e){const t=this.parentElement;t.parentElement.removeChild(t)},h=function({type:e,selector:s,values:r}){new autoComplete({selector:s,source:async function(e,t){let a=[];if("function"==typeof r)a=r();else if("object"==typeof r&&r.url){const t=await fetch(`${r.url}${e}`);if(!t.ok)throw Error("HTTP-Error: "+t.status);a=await r.cb(t)}else Array.isArray(r)&&(a=r);a.length&&t(a)},minChars:Array.isArray(r)?0:3,delay:150,onSelect:function(s,r,i){const c=this.selector,d=c.parentElement;if("key"===e){const e=d.children[0];e.innerText=c.value,e.className="fs-key fs-on",c.className="fs-off";const t=a.filter((e=>e.key===r))[0];t.noDuplicates&&n.splice(n.indexOf(r),1);const s=d.children[3];s.className="fs-val-input fs-on",s.placeholder=t.prompt,h({type:"val",selector:s,values:t.values}),s.focus()}else if("val"===e){o.innerHTML=t;const e=d.children[2];r&&(e.innerText=c.value,e.className="fs-val fs-on"),c.className="fs-off",d.className="fs-param-filled",d.children[4].className="fs-cancel fs-on",l()}}})},p=function(e){const t=i.childNodes;let s={},n=0;const r=t.length;for(;n<r;n++){const e=t[n].children,r=e[1].value;if(r){const t=e[3].value.replace(/\n$/,""),n=a.filter((e=>e.key===r))[0].actualKey;if(n&&t)if(n in s)if("string"==typeof s[n]){const e=s[n];s[n]=[e,t]}else s[n].push(t);else s[n]=t}}e(s)};!function(e,t){o=c({element:"div",attribs:{id:"fs-help",innerHTML:t},container:e});const a=c({element:"div",attribs:{id:"fs-widget"},container:e});i=c({element:"div",attribs:{id:"fs",className:"fs"},container:a}),c({element:"button",attribs:{id:"fs-go",type:"submit",className:"fs-button-primary",innerText:"go"},container:a}).addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),p(r)})),l()}(e,t)};let m=a.figureSize;const g=()=>{log.info("loadBlankWebSite()"),log.info("- listeners.addListeners()"),e("#refreshCache").addEventListener("click",c),e("#ns-go").addEventListener("click",l),t(".modalToggle").forEach((e=>e.addEventListener("click",d))),e("#q").addEventListener("focus",u),e("#search-help").addEventListener("click",s),t(".example-insert").forEach((e=>e.addEventListener("click",i))),e("div.examples").addEventListener("toggle",o,!0),t(".reveal").forEach((e=>e.addEventListener("click",h))),e("#switch").addEventListener("click",n),t("input[name=source]").forEach((e=>e.addEventListener("click",r)))},v=()=>{log.info("submitForm()");const e=y();b(e),k(e)},y=()=>{log.info("- form2qs()");const t=new URLSearchParams;return a.validFormFields.forEach((a=>{const s=e(`input[name=${a}`),n=s.value;if("q"===a){new URLSearchParams(n).forEach(((e,a)=>{""===e?t.append("q",a):t.append(a,e)}))}else"refreshCache"===a&&s.checked?t.append("refreshCache",!0):"source"===a&&s.checked?t.append("source",n):t.append(a,n)})),t.toString()},$=s=>{log.info("- qs2form(qs)"),log.info(`  - qs: ${s}`);const n=new URLSearchParams(s);if(n.delete("refreshCache"),n.has("grid")){"small"===n.get("grid")&&(m=100)}let r=[];n.forEach(((e,s)=>{if(a.notq.includes(s)){if("source"===s){t("input[name=source]").forEach((t=>{t.value===e&&(t.checked=!0)}))}}else{let t=s;e&&(t="q"===s?e:`${s}=${e}`),r.push(t)}})),e("#q").value=r.join("&")},b=e=>{log.info("- updateUrl(qs)"),log.info(`  - qs: ${e}`),history.pushState("",null,`?${e}`)},k=async function(e){log.info("- getImages(qs)"),log.info(`  - qs: ${e}`);const t=new URLSearchParams(e),s=t.get("source");["source","grid"].forEach((e=>t.delete(e))),t.forEach(((e,a)=>{e||(t.set("q",a),t.delete(a))}));const n=new URLSearchParams(t.toString()),r=new URLSearchParams(t.toString());n.forEach(((e,t)=>{a.validZenodo.includes(t)||n.delete(t)})),r.forEach(((e,t)=>{a.validZenodeo.includes(t)||r.delete(t)}));const o=[],i={resource:"images",queryString:n.toString()},c={resource:"treatmentimages",queryString:`${r.toString()}&cols=httpUri&cols=treatmentTitle&cols=zenodoDep&cols=treatmentId&cols=captionText`};"all"===s?o.push(L(i),L(c)):"Zenodo"===s?o.push(L(i)):"treatments"===s&&o.push(L(c));const l=t.get("page"),d=t.get("size");Promise.all(o).then((e=>{const t={prev:l>1?l-1:1,next:parseInt(l)+1,size:d,count:0,recs:[]};return e.forEach((e=>{void 0!==e&&(t.recs.push(...e.recs),t.count+=e.count,t.cacheHit=e.cacheHit)})),t})).then((t=>{const a=[];t.recs.forEach((e=>{const t=S({figureSize:m,treatmentId:e.treatmentId,title:e.title,zenodoRec:e.zenodoRec,uri:e.uri,caption:e.caption});a.push(t)})),q({figureSize:m,figures:a,qs:e,count:t.count,prev:t.prev,next:t.next,cacheHit:t.cacheHit})}))},L=async({resource:e,queryString:t})=>{log.info("- getResource()"),log.info(`  - resource: ${e}`),log.info(`  - queryString: ${t}`);const s=`${a.server}/${e}?${t}`,n=await fetch(s);if(n.ok){const t=await n.json(),s=t.item.result.records,r={count:0,recs:[],prev:"",next:"",cacheHit:t.cacheHit||!1};if(s)return r.count=r.count+t.item.result.count,s.forEach((t=>{if("images"===e){let e="/img/kein-preview.png";"thumbs"in t.links&&(e=t.links.thumbs[m]),r.recs.push({treatmentId:"",title:t.metadata.title,zenodoRec:t.id,uri:e,caption:t.metadata.description})}else if("treatmentimages"===e){const e=t.httpUri.split("/")[4],s=t.httpUri.indexOf("zenodo")>-1?`${a.zenodoUri}/${e}/thumb${m}`:t.httpUri;r.recs.push({treatmentId:t.treatmentId,title:t.treatmentTitle,zenodoRec:t.zenodoDep,uri:s,caption:t.captionText})}})),r}else alert("HTTP-Error: "+n.status)},S=({figureSize:e,treatmentId:t,title:s,zenodoRec:n,uri:r,caption:o})=>{let i="";n&&(i=`<a href="${a.zenodoUri}/${n}" target="_blank">more on Zenodo</a><br></br>`);let c="",l="";t&&(c=`<div class="treatmentId reveal" data-reveal="${t}">T</div>`,l=`<a href="${a.tbUri}/${t}" target="_blank">more on TreatmentBank</a>`);const d=`<img src="img/bug.gif" width="${e}" data-src="${r}" class="lazyload" data-recid="${t}" onerror="${`this.onerror=null; setTimeout(() => { this.src='${r}' }, 1000);`}">`;let u="";l?u=`<a href="${a.tbUri}/${t}" target="_blank">${d}</a>`:i&&(u=`<a href="${a.zenodoUri}/${n}" target="_blank">${d}</a>`);return`<figure class="figure-${e} ${t?"tb":""}">\n    <div class="switches">\n        ${c}\n        <div class="close"></div>\n    </div>\n    ${u}\n    <figcaption class="${250===e?"visible":"noblock"}">\n        <a class="transition-050">Zenodo ID: ${n}</a>\n        <div class="closed">\n            <b class="figTitle">${s}</b><br>\n            ${o}<br>\n            ${i}\n            ${l}\n        </div>\n    </figcaption>\n</figure>`},q=({figureSize:t,figures:a,qs:s,count:n,prev:r,next:o,cacheHit:i})=>{log.info(`- renderPage()\n- figureSize: ${t}px\n- figures: ${a.length} figures\n- qs: ${s}\n- count: ${n}\n- prev: ${r}\n- next: ${o}`),e("#grid-images").classList.add(`columns-${t}`),E(a,s,r,o),x(s,n,i)},E=(a,s,n,r)=>{log.info("- renderFigures()"),e("#throbber").classList.add("nothrob"),a.length&&(e("#grid-images").innerHTML=a.join(""),w(s,n,r),(()=>{const e=t("figcaption > a");for(let t=0,a=e.length;t<a;t++)e[t].addEventListener("click",p)})(),(()=>{const e=t("figure .reveal");for(let t=0,a=e.length;t<a;t++)e[t].addEventListener("click",h)})())},w=(t,a,s)=>{log.info("- renderPager()"),log.info(`  - qs: ${t}`),log.info(`  - prev: ${a}`),log.info(`  - next: ${s}`);const n=new URLSearchParams(t);n.delete("page"),e("#pager").innerHTML=`<a href="?${n.toString()}&page=${a}">prev</a> <a href="?${n.toString()}&page=${s}">next</a>`,e("#pager").classList.add("filled"),log.info("- listeners.addListenersToPagerLinks()")},x=(t,s,n)=>{log.info("- renderSearchCriteria(qs, count)"),log.info(`  - qs: ${t}`),log.info(`  - count: ${s}`);const r=new URLSearchParams(t);r.get("page"),r.get("size"),s||(s="sorry, no");const o=[];let i;a.notInSearchCriteria.forEach((e=>r.delete(e))),r.forEach(((e,t)=>{let a;a="q"===t?`<span class="crit-key">${e}</span> is in the text`:"keywords"===t?`<span class="crit-key">keyword</span> is <span class="crit-val">${e}</span>`:`<span class="crit-key">${t}</span> is <span class="crit-val">${e}</span>`,o.push(a)}));const c=o.length;i=1===c?o[0]:2===c?`${o[0]} and ${o[1]}`:`${o.slice(0,c-2).join(", ")}, and ${o[c-1]}`,i=`<span class="crit-count">${s}</span> images found where ${i}`,i+=n?'<span aria-label="cache hit" data-pop="top" data-pop-no-shadow data-pop-arrow>💥</span>':"",e("#search-criteria").innerHTML=i},z="localhost"===window.location.hostname?"INFO":"ERROR";log.level=log[z];const T=()=>{const t=new URL(location);let s=t.search;(t=>{const s=e=>async t=>{const a=await t.json(),s=[];return a.item.result.records?a.item.result.records.forEach((t=>s.push(t[e]))):s.push("nothing found… please try again"),s},r=[{key:"text contains",actualKey:"q",values:"",prompt:"search the full text of treatments",noDuplicates:!0},{key:"title",actualKey:"title",values:"",prompt:"search within the title",noDuplicates:!0},{key:"authority",actualKey:"authorityName",values:{url:`${a.server}/authors?q=`,cb:s("author")},prompt:"type at least 3 letters to choose an author",noDuplicates:!0},{key:"family",actualKey:"family",values:{url:`${a.server}/families?q=`,cb:s("family")},prompt:"type at least 3 letters to choose a family",noDuplicates:!1},{key:"phylum",actualKey:"phylum",values:{url:`${a.server}/phyla?q=`,cb:s("phylum")},prompt:"type at least 3 letters to choose a phylum",noDuplicates:!1},{key:"class",actualKey:"class",values:{url:`${a.server}/classes?q=`,cb:s("class")},prompt:"type at least 3 letters to choose a class",noDuplicates:!1},{key:"genus",actualKey:"genus",values:{url:`${a.server}/genera?q=`,cb:s("genus")},prompt:"type at least 3 letters to choose a genus",noDuplicates:!1},{key:"order",actualKey:"order",values:{url:`${a.server}/orders?q=`,cb:s("order")},prompt:"type at least 3 letters to choose an order",noDuplicates:!1},{key:"taxon",actualKey:"taxon",values:{url:`${a.server}/taxa?q=`,cb:s("taxon")},prompt:"type at least 3 letters to choose a taxon",noDuplicates:!1},{key:"journal year",actualKey:"journalYear",values:((e,t)=>{const a=2022-e;return Array.from({length:a},((t,a)=>a+e)).map((e=>String(e)))})(1995),prompt:"pick a year of publication",noDuplicates:!0}];new f({selector:e("#fs-container"),helpText:"",facets:r,cb:function(t){t.source="treatments";const a=new URLSearchParams(t);["page","size","refreshCache"].forEach((t=>{const s=e(`input[name=${t}`),n=s.value;"refreshCache"===t&&s.checked?a.append("refreshCache",!0):a.append(t,n)}));const s=a.toString();b(s),k(s)}}),e("#fancySearch").classList.add("hidden"),e("#fancySearch").classList.add("noblock"),t&&n()})(t.hash&&"#fs"===t.hash?"fs":""),s?("?"===s.substring(0,1)&&(s=s.substring(1)),(e=>{log.info("loadBookmarkedWebSite(qs)"),log.info(`- qs: ${e}`),g(),$(e),k(e)})(s)):g()};export{T as init};
