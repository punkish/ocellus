/* generated: Fri Oct 25 2024 16:36:55 GMT+0200 (Central European Summer Time) */
import{cellArea as e,UNITS as t,cellToBoundary as n}from"https://cdn.jsdelivr.net/npm/h3-js@4.1.0/+esm";const o=e=>document.querySelector(e),a=e=>document.querySelectorAll(e);const i={fetchOpts:{},uri:{zenodeo:"http://localhost:3010/v3",maps:"http://localhost:3000",zenodo:"https://zenodo.org",treatmentBank:"https://tb.plazi.org/GgServer/html"},cache:{images:{yearlyCounts:!1,totals:!1},treatments:{yearlyCounts:!1,totals:!1},journals:null,collectionCodes:null,bins:{}},figureSize:{normal:250,small:100,tiny:50},defaultPlaceholder:"search images",results:{totalCount:0,figures:[],page:1,size:30},resources:["treatments","citations","images"],pseudoResources:["about","ip","contact","privacy"],params:{notValidQ:["resource","page","size","grid","refreshCache","cols"],validImages:["httpUri","caption","captionText","q","treatmentId","treatmentTitle","articleTitle","treatmentDOI","articleDOI","zenodoDep","authorityName","collectionCode","status","journalTitle","journalYear","kingdom","phylum","class","family","order","genus","species","publicationDate","checkinTime","latitude","longitude","geolocation","isOnLand","validGeo","eco_name","biome","biome_id"],validTreatments:["treatmentId","treatmentTitle","treatmentDOI","zenodoDep","articleTitle","articleDOI","publicationDate","journalYear","authorityName","status","checkinTime","validGeo","q","latitude","longitude","geolocation","eco_name","biome","isOnLand","journalTitle","kingdom","phylum","class","family","order","genus","species"],validCommon:["refreshCache","page","size","cols","groupby"],notValidSearchCriteria:["resource","communities","communitiesChooser","refreshCache","view","size","page","reset","submit","source","grid"]},cols:{images:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","httpUri","caption","latitude","longitude"],treatments:["treatmentId","treatmentTitle","zenodoDep","treatmentDOI","articleTitle","articleAuthor","journalTitle","latitude","longitude"]},maps:{},hiddenClasses:["hidden","noblock"],closedFigcaptionHeight:"30px",H3ColorRamp:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"],markerIcons:{default:L.icon({iconUrl:"/img/marker.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[11,37]}),active:L.icon({iconUrl:"/img/marker-active.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]}),clicked:L.icon({iconUrl:"/img/marker-clicked.png",iconSize:[24,38],iconAnchor:[12,38],popupAnchor:[0,0],shadowUrl:"/img/marker-shadow.png",shadowSize:[41,41],shadowAnchor:[12,38]})},months:["January","February","March","April","May","June","July","August","September","October","November","December"],charts:{termFreq:null,yearlyCounts:null}};function s(e){const t=document.getElementById("charts");let n=960;return t.offsetWidth<n&&(n=t.offsetWidth-100),e.style.display="block",e.style.width=`${n}px`,e.style.textAlign="center",e.style.margin="0 auto",e}function r(e,t){return e<1e3?e:e>=1e3&&e<1e6?e/1e3+"K":e>=1e6&&e<1e7?e/1e6+"M":void 0}!function(e){const t="ocellus.localhost"===window.location.hostname,n="ocellus.local"===window.location.hostname,o="127.0.0.1"===window.location.hostname,a="localhost"===window.location.hostname;window.log.level="INFO",t||n||o||a||(e.uri.zenodeo="https://test.zenodeo.org/v3",e.uri.maps="https://maps.zenodeo.org",window.log.level="ERROR")}(i);const l=({yearlyCounts:e,totals:t})=>{const n=s(document.querySelector("#yearlyCounts"));n.innerHTML="";const o="Images",{years:a,series:l}=function(e,t){const n=[],o=[];"Treatments"===e||"Images"===e?(o.push({name:"Treatments",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_treatments))}),o.push({name:"Images",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_images))}),o.push({name:"Species",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_species))}),o.push({name:"Journals",type:"bar",emphasis:{focus:"series"},data:t.map((e=>e.num_of_journals))}),t.forEach((e=>n.push(e.year)))):(o.push({name:e,type:"bar",emphasis:{focus:"series"},data:t.map((t=>t[`num_of_${e.toLowerCase()}`]))}),t.forEach((e=>n.push(e.year))));return{years:n,series:o}}(o,e),c=function(e,t,n){return{legend:{left:65,top:60,orient:"horizontal",borderWidth:1,borderRadius:5,borderColor:"#444",backgroundColor:"#fff"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{precision:"0"}},formatter:'<div class="leg">\n    year {b}\n    <hr>\n    <div class="dot b"></div>{a0}: {c0}<br/>\n    <div class="dot g"></div>{a1}: {c1}<br/>\n    <div class="dot y"></div>{a2}: {c2}<br/>\n    <div class="dot r"></div>{a3}: {c3}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",splitLine:{show:!1},data:t}],yAxis:[{type:"value",axisLabel:{formatter:r}}],series:n}}(0,a,l),d=document.createElement("div");d.style.width="100%",d.style.height="200px",d.classList.add("viz"),n.appendChild(d),i.charts.yearlyCounts=echarts.init(d),i.charts.yearlyCounts.setOption(c);const u=t.treatments,h=t.images,m=t.species,p=t.journals,g=c.xAxis[0].data,f=function({resource:e,imagesTotal:t,treatmentsTotal:n,speciesTotals:o,journalsTotals:a,num_of_years:i}){let s="Treatments"===e?`with <span>${t}</span> images, and`:`in <span>${n}</span> treatments of`;s+=` <span>${o}</span> species from <span>${a}</span> journals`,i&&(s+=` over <span>${i}</span> years`);return s}({resource:o,imagesTotal:h,treatmentsTotal:u,speciesTotals:m,journalsTotals:p,num_of_years:g[g.length-1]-g[0]}),y=document.createElement("div");y.style.width="100%",y.classList.add("caption"),n.appendChild(y),y.innerHTML=f};class c{constructor(e){this.el=e,this.summary=e.querySelector("summary"),this.content=e.querySelector("#charts"),this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.summary.addEventListener("click",(e=>this.onClick(e)))}onClick(e){e.preventDefault(),this.el.style.overflow="hidden",this.isClosing||!this.el.open?this.open():(this.isExpanding||this.el.open)&&this.shrink()}shrink(){this.isClosing=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!1),this.animation.oncancel=()=>this.isClosing=!1}open(){this.el.style.height=`${this.el.offsetHeight}px`,this.el.open=!0,window.requestAnimationFrame((()=>this.expand()))}expand(){this.isExpanding=!0;const e=`${this.el.offsetHeight}px`,t=`${this.summary.offsetHeight+this.content.offsetHeight}px`;this.animation&&this.animation.cancel(),this.animation=this.el.animate({height:[e,t]},{duration:400,easing:"ease-out"}),this.animation.onfinish=()=>this.onAnimationFinish(!0),this.animation.oncancel=()=>this.isExpanding=!1}onAnimationFinish(e){this.el.open=e,this.animation=null,this.isClosing=!1,this.isExpanding=!1,this.el.style.height=this.el.style.overflow=""}}async function d(o,a){if("imageMarkerClusters"in a&&o.hasLayer(a.imageMarkerClusters)&&(log.info("removing image marker clusters"),o.removeLayer(a.imageMarkerClusters),a.slidebar.remove()),"h3"in a)o.hasLayer(a.h3)||(log.info("re-adding existing h3 layer"),o.addLayer(a.h3),a.h3info.addTo(o));else{log.info("initializing h3 layer");const s=await async function(o){const a=`${i.uri.zenodeo}/bins/${o}`,s=await fetch(a,i.fetchOpts);if(s.ok){const o={type:"FeatureCollection",features:[]},a=["81033ffffffffff","83f293fffffffff"],i=await s.json();a.forEach((e=>delete i[e]));for(const[a,s]of Object.entries(i)){const i=Math.round(e(a,t.km2)),r={type:"Feature",properties:{numOfTreatments:s,area:i,density:s/i},geometry:{type:"Polygon",coordinates:[n(a).map((e=>[e[1],e[0]]))]}};o.features.push(r)}return u(o),o}alert("HTTP-Error: "+s.status)}(3),r=s.features.map((e=>e.properties.density)),l=1/Math.min(...r),c=function({data:e,scaleFactor:t,colorRamp:n,typeOfBins:o}){const a=n.length,i=[];if("equalWidth"===o){const t=Object.values(e);t.reduce(((e,t)=>e+t));const o=Math.max(...t)+1,s=Math.min(...t),r=(o-s)/a;let l=0;for(let e=s;e<o;e+=r){const t=e+r,o=n[l];i.push({from:Math.round(e),to:Math.round(t),fillColor:o,num:0}),l++}i.forEach((t=>{t.num=Object.values(e).filter((e=>e>=t.from&&e<t.to)).length}))}else if("equalFreq"===o){const o=Object.keys(e).length,s=Math.round(o/a),r=[];for(const[n,o]of Object.entries(e))r.push({id:n,num:Math.round(o*t)});const l=r.sort(((e,t)=>e.num-t.num));for(let e=0;e<a;e++){const t=e*s,o=t+s,a=l.slice(t,o),r=a[0].num,c=a[a.length-1].num;i[e]={from:r,to:c,fillColor:n[e],num:a.length}}}return i}({data:r,scaleFactor:l,colorRamp:i.H3ColorRamp,typeOfBins:"equalFreq"}),d=function(e){let t="#f5f5f5",n=0;const o=e.properties.density*l;return o>0&&(t=function(e,t){for(let n=0,o=t.length;n<o;n++)if(e>=t[n].from&&e<t[n].to)return t[n].fillColor}(o,c),n=.7),{fillColor:t,color:"grey",weight:0,fillOpacity:n}};a.h3=L.geoJSON(s,{style:d,onEachFeature:(e,t)=>{t.on({mouseover:e=>{!function({mapLayers:e,bin:t}){t.setStyle({weight:2,color:"#666",dashArray:"",fillOpacity:.1}),L.Browser.ie||L.Browser.opera||L.Browser.edge||t.bringToFront();e.h3info.update(t.feature.properties)}({mapLayers:a,bin:e.target})},mouseout:e=>{!function({mapLayers:e,bin:t}){e.h3.resetStyle(t),e.h3info.update()}({mapLayers:a,bin:e.target})}})}}),o.addLayer(a.h3),function(e,t){const n=L.control(),o="Hover over a bin to see num of images";n.onAdd=function(e){return this._div=L.DomUtil.create("div","h3info"),this._div.innerHTML=o,this._div},n.update=function(e){this._div.innerHTML=e?`${e.numOfTreatments} treatments in ${e.area} km<sup>2</sup>`:o},t.h3info=n,n.addTo(e)}(o,a)}}function u(e){const{type:t}=e;if("FeatureCollection"===t)return void e.features.map(u);const{type:n,coordinates:o}=e.geometry;switch(n){case"LineString":return void h(o);case"Polygon":return void m(o);case"MultiPolygon":return void o.forEach((e=>m(e)));default:throw new Error(`Unknown geometry type: ${n}`)}}function h(e){let t=!1;for(let n=0;n<e.length;n++)if(Math.abs(e[0][0]-e[(n+1)%e.length][0])>180){t=!0;break}t&&e.forEach((e=>function(e){const t=e[0];e[0]=t<0?t+360:t}(e)))}function m(e){e.forEach((e=>h(e)))}const p=L.Control.extend({options:{content:"<i>Click on a marker for more info</i>",state:"full",threshold:50,doubleThreshold:200},initialize:function(e){return L.Util.setOptions(this,e),this.on("swipeup",(function(e){let t;if(e.value>this.options.doubleThreshold)t="full";else switch(this._size){case"closed":t="quarter";break;case"quarter":t="half";break;case"half":t="full"}this.toggleSize(t),L.DomEvent.stopPropagation(e)})),this.on("swipedown",(function(e){let t;if(e.value>this.options.doubleThreshold)t="closed";else switch(this._size){case"full":t="half";break;case"half":t="quarter";break;case"quarter":t="closed"}this.toggleSize(t),L.DomEvent.stopPropagation(e)})),this},toggleSize:function(e){const t=document.querySelector("#leaflet-slidebar");if(t.classList.contains(e));else{["closed","quarter","half","full"].forEach((e=>t.classList.remove(e))),t.classList.add(e),this._size=e}this.reCenter(this._newCenter)},onAdd:function(e){if(!this._div){this._div=L.DomUtil.create("div","leaflet-slidebar"),this._div.classList.add(this.options.state),this._div.id="leaflet-slidebar",this._size=this.options.state;const e="",t=L.DomUtil.create("nav",e,this._div),n="";L.DomUtil.create("hr",n,t);const o="",a=L.DomUtil.create("button",o,t),i=e=>this.toggleSize("closed");L.DomEvent.on(a,"click",i,this),L.DomEvent.on(a,"touchend",i,this);const s="";L.DomUtil.create("main",s,this._div)}return this._div},onRemove:function(e){return this},reCenter:function(){const e=this._map.latLngToLayerPoint(this._newCenter),t=[],{min:n,max:o}=this._map.getPixelBounds();if(document.body.clientWidth<400){const a=o.y-n.y;let i=0;"full"===this._size?i=.375:"half"===this._size?i=.25:"quarter"===this._size&&(i=.125),t.push(e.x,e.y+i*a)}else t.push(e.x,e.y);const a=this._map.layerPointToLatLng(t);this._map.flyTo(a)},update:async function({content:e,latlng:t}){return this._div.querySelector("#leaflet-slidebar main").innerHTML=e,this._newCenter=t,this.toggleSize("full"),this},addTo:function(e){return this.onRemove(),this._map=e,this._container=this.onAdd(e),L.DomUtil.addClass(this._container,"leaflet-slidebar"),L.Browser.touch&&L.DomUtil.addClass(this._container,"leaflet-touch"),L.DomEvent.disableScrollPropagation(this._container),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"touchstart",this._startSwipe,this),L.DomEvent.on(this._container,"touchend",this._endSwipe,this),L.DomEvent.on(this._container,"touchstart",L.DomEvent.stopPropagation),L.DomEvent.on(this._container,"touchend",L.DomEvent.stopPropagation),e._container.insertBefore(this._container,e._container.firstChild),this},_startSwipe:function(e){const t=e.touches&&e.touches[0];t&&this._map&&(e.target&&"A"==e.target.tagName||(this._startPoint=this._map.mouseEventToContainerPoint(t)))},_endSwipe:function(e){const t=e.changedTouches&&e.changedTouches[0];if(!t||!this._startPoint||!this._map)return;const n=this._map.mouseEventToContainerPoint(t).subtract(this._startPoint),o=Math.abs(n.x),a=Math.abs(n.y);if(this._startPoint=null,o<this.options.threshold&&a<this.options.threshold)return;if(o/a>.5&&o/a<2)return;let i,s;o>a?(s=o,i=n.x<0?"left":"right"):(s=a,i=n.y<0?"up":"down"),this.fire("swipe"+i,{direction:i,value:s})}});async function g(e,t){console.log("fired");const n=o("#throbber");n.classList.remove("nothrob");const a=e.getBounds(),s=await async function(e){const t=e.getSouthWest().lat,n=e.getSouthWest().lng,o=e.getNorthEast().lat,a=e.getNorthEast().lng,s=`${i.uri.zenodeo}/images?geolocation=within(min_lat:${t},min_lng:${n},max_lat:${o},max_lng:${a})&cols=treatmentId&cols=treatmentTitle&cols=latitude&cols=longitude&size=5000`,r=await fetch(s,i.fetchOpts);if(r.ok)return(await r.json()).item.result.records;alert("HTTP-Error: "+r.status)}(a);if(s){t.imageMarkerClusters||(t.imageMarkerClusters=L.markerClusterGroup({disableClusteringAtZoom:10}));const o=[];s.forEach((a=>{const s=a.images_id;if(!t.imageMarkers.has(s)){const r=a.treatmentId,l={title:r,icon:i.markerIcons.default},c=new L.LatLng(a.latitude,a.longitude),d=L.marker(c,l);d.on("click",(async function(l){n.classList.remove("nothrob");const d=l.target;d.setIcon(i.markerIcons.active);const u=await async function(e){if(!e)return"Click on an image marker for more info";{const t=e.treatmentId,n=`${i.uri.zenodeo}/images?id=${e.images_id}&cols=httpUri&cols=caption`;let o=`<h3>${e.treatmentTitle}</h3>`;const a=await fetch(n,i.fetchOpts);if(a.ok){const e=(await a.json()).item.result.records[0],n=`<a href="${i.uri.treatmentBank}/${t}" target="_blank">more on TB</a>`;if(e.httpUri){const t=250,a=e.httpUri.split("/")[4];let s;s=e.httpUri.indexOf("zenodo")>-1?e.httpUri.indexOf(".svg")>-1?"/img/kein-preview.png":`${i.uri.zenodo}/api/iiif/record:${a}:figure.png/full/250,/0/default.jpg`:`${e.httpUri}/singlefigAOF/`,o+=`\n                <figure class="figure-${t}">\n                    <img src="../img/bug.gif" width="${t}" data-src="${s}" \n                        class="lazyload" data-recid="${a}">\n                    <figcaption>${e.captionText} ${n}</figcaption>\n                </figure>\n                <hr class="style-eight">`}else o+=n;return o}}}(a);t.slidebar.update({content:u,latlng:c}),n.classList.add("nothrob");document.querySelector("#leaflet-slidebar").style.visibility="visible",function(e,t,n){const o=e.getCenter(),a=Math.round(1e5*o.lat)/1e5,i=Math.round(1e5*o.lng)/1e5,s=e.getZoom();let r=`#show=maps&lat=${a}&lng=${i}&zoom=${s}&treatmentId=${t}-${n}`;const l={zoom:s,center:{lat:a,lng:i}};window.history.pushState(l,"map",r)}(e,r,s),t.imageMarkerClusters.getVisibleParent(d);const h=o[o.length-1];h&&h.setIcon(i.markerIcons.clicked),o.push(d)})),t.imageMarkers.set(s,d),t.imageMarkerClusters.addLayer(d)}})),e.hasLayer(t.imageMarkerClusters)?log.info("used existing image marker clusters layer"):(log.info("re-adding existing image marker clusters"),e.addLayer(t.imageMarkerClusters))}n.classList.add("nothrob")}async function f(e,t,n){if("h3"in t&&e.hasLayer(t.h3)&&(log.info("removing h3 layer"),e.removeLayer(t.h3),t.h3info.remove()),"imageMarkerClusters"in t?(await g(e,t),t.slidebar.addTo(e)):(log.info("initializing image marker clusters"),function(e,t){t.slidebar=new p({state:"closed"}),t.slidebar.addTo(e)}(e,t),t.imageMarkers=new Map,await g(e,t)),n){const[e,o]=n.split("-"),a=t.imageMarkers.get(Number(o));a&&(t.imageMarkerClusters.zoomToShowLayer(a),a.fireEvent("click"))}}async function y({baseLayerSource:e,map:t}){const n={minZoom:1,maxZoom:17,zoomOffset:-1,tileSize:512};let o;if("arcgis"===e)n.attribution="&copy; ESRI",o=L.tileLayer("https://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",n).addTo(t);else if("geodeo"===e){const e=`${i.uri.maps}/nev_raster/{z}/{x}/{y}`,n={ne_50m_admin_1_states_provinces_lakes:{maxZoom:2,tms:!0,styles:{weight:1,color:"blue",fillColor:"",fillOpacity:.5,fill:!0}},ne_50m_admin_0_countries:{maxZoom:2,tms:!0,styles:{weight:1,color:"#444",fillColor:"f5f5f5",fillOpacity:.25,fill:!0}},ne_10m_admin_1_sel:{maxZoom:5,tms:!0,styles:{weight:1,color:"#444",fillColor:"#f5f5f5",fillOpacity:.25,fill:!0}},nev:{maxNativeZoom:7,maxZoom:10,tms:!0,vectorTileLayerStyles:{playa:{stroke:!0,weight:1,color:"aliceblue",fillColor:"aliceblue",fillOpacity:.25,fill:!0},urban:{stroke:!0,weight:1,color:"bisque",fillColor:"bisque",fillOpacity:.25,fill:!0},water:{stroke:!0,weight:1,color:"black",fillColor:"lightblue",fillOpacity:.25,fill:!0},ice:function(e){return"glacier"===e.type?{weight:1,color:"white",fillColor:"white",fillOpacity:.45,fill:!0}:"ice_shelf"===e.type?{weight:1,color:"white",fillColor:"lightgrey",fillOpacity:.45,fill:!0}:void 0},river:{weight:1,color:"blue",fillColor:"",fillOpacity:1,fill:!1},railroad:{stroke:!0,weight:1,color:"brown"},road:{weight:1,color:"#ffcc00",fillColor:"",fillOpacity:1,fill:!1},country_label:{stroke:!1,fill:!1},state_label:{stroke:!1,fill:!1},marine_label:{stroke:!1,fill:!1},lake_label:{stroke:!1,fill:!1},place_label:{stroke:!1,fill:!1},airport_label:{stroke:!1,fill:!1},port_label:{stroke:!1,fill:!1},admin:function(e,t){const n=e.admin_level;return 0===n?{weight:1,color:"#444",fill:!1}:1===n?{weight:.5,color:"#444",fill:!1}:2===n?{weight:1,color:"#cf52d3",dashArray:"2, 6",fillColor:"green",fillOpacity:.25,fill:!0}:void 0}}},nev_raster:{maxZoom:15,tms:!0}};L.tileLayer(e,{maxNativeZoom:6,maxZoom:10,tms:!0}).addTo(t);const o="nev",a=n[o];L.vectorGrid.protobuf(`${i.uri.maps}/${o}/{z}/{x}/{y}`,a).addTo(t)}else if("gbif"===e){n.attribution='&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> / &copy; <a href="https://www.openmaptiles.org/copyright">OpenMapTiles</a>';const e=parseInt(window.devicePixelRatio)||1;o=L.tileLayer("https://tile.gbif.org/3857/omt/{z}/{x}/{y}@{r}x.png?style=gbif-natural".replace("{r}",e),n).addTo(t)}return o}async function v({mapContainer:e,baseLayerSource:t,drawControl:n}){const{zoom:a,lat:i,lng:s,treatmentId:r}=function({zoom:e,lat:t,lng:n,treatmentId:o}){const a=new URLSearchParams(window.location.hash.substring(1));return{zoom:e=parseInt(a.get("zoom"),10)||e,lat:t=parseFloat(a.get("lat"))||t,lng:n=parseFloat(a.get("lng"))||n,treatmentId:o=a.get("treatmentId")||o}}({zoom:5,lat:0,lng:0}),l=L.map(e,{preferCanvas:!0}).setView({lat:i,lng:s},a),c=L.latLngBounds({lat:61.60639637138628,lng:131.48437500000003},{lat:-31.952162238024975,lng:-137.10937500000003});"map"===e&&L.easyButton(".",(function(){l.fitBounds(c)})).addTo(l),function(e){let t=!0;e.on("moveend",(function(){if(!t)return void(t=!0);const n=e.getCenter(),o=Math.round(1e5*n.lat)/1e5,a=Math.round(1e5*n.lng)/1e5,i=e.getZoom(),s=window.location.pathname.split(".").shift().substring(1);let r;"maps"===s?r=`#lat=${o}&lng=${a}&zoom=${i}`:"index"===s&&(r=`#show=maps&lat=${o}&lng=${a}&zoom=${i}`);const l=new URLSearchParams(window.location.hash.substring(1)).get("treatmentId")||void 0;l&&(r+=`&treatmentId=${l}`);const c={zoom:i,center:{lat:o,lng:a}};window.history.pushState(c,"map",r)})),window.addEventListener("popstate",(function(n){null!==n.state&&(e.setView(n.state.center,n.state.zoom),t=!1)}))}(l),l.attributionControl.setPrefix(""),l.on("moveend",(async function(e){await $(l,d)}));const d={baseLayer:y({baseLayerSource:t,map:l})};n&&function(e,t){t.drawControls=new L.FeatureGroup,function(e,t){e.hasLayer(t)||e.addLayer(t)}(e,t.drawControls);const n={position:"topleft",draw:{polyline:!1,polygon:!1,circle:{shapeOptions:{weight:1}},rectangle:{shapeOptions:{clickable:!1,weight:1}},circlemarker:!1,marker:!1},edit:{featureGroup:t.drawControls}},a=new L.Control.Draw(n);e.addControl(a),e.on(L.Draw.Event.CREATED,(function(e){const n=e.layerType,a=e.layer,i=o("#coords"),s=o("input[name=as-geolocation");if("rectangle"===n){const e=a.toGeoJSON().geometry.coordinates,[t,n,o,r,l]=e[0],c=t[1].toFixed(2),d=t[0].toFixed(2),u=o[1].toFixed(2),h=o[0].toFixed(2);i.innerHTML=`lower left: lat ${c}, lng: ${d}; upper right: lat ${u}, lng ${h}`,s.value=`within(min_lat:${c},min_lng:${d},max_lat:${u},max_lng:${h})`}else if("circle"===n){const t=e.layer.getLatLng(),n=t.lng.toFixed(2),o=t.lat.toFixed(2),a=(e.layer.getRadius()/1e3).toFixed(2);i.innerHTML=`within ${a} kms of ${n}, ${o}`,s.value=`within(radius:${a},units:'kilometers',lat:${o},lng:${n})`}t.drawControls.addLayer(a)})),e.on(L.Draw.Event.DELETED,(function(e){o("input[name=as-geolocation").value="",o("#coords").innerHTML=""}))}(l,d),await $(l,d,r)}async function $(e,t,n){e.getZoom()<=5?d(e,t):await f(e,t,n)}L.extend(p.prototype,L.Evented.prototype);function w(e){const t=o("input[name=resource]").checked?"treatments":"images",n=`${e.target.href}&resource=${t}`;history.pushState({},"",n);const a=new URL(location);let i;a.search&&(i=a.search.substring(1)),J(i);const s=Y();Z(s),e.preventDefault(),e.stopPropagation()}function b(e){if("/"===e.key){if(/^(?:input|textarea|select|button)$/i.test(e.target.tagName))return;const t=o("#q");t.setSelectionRange(0,t.value.length),t.focus(),e.preventDefault()}}const k=e=>{const t=o(".examples").classList;t.contains("hidden")?t.remove("hidden"):t.add("hidden")},C=e=>{const t=e.target.classList;t.contains("required")&&t.remove("required")},T=e=>{log.info("- toggling advanced search"),o("#as-container").classList.toggle("noblock");o("input[name=searchtype]").checked?(o("#q").value="",o("#q").placeholder="use advanced search below",o("#q").disabled=!0,o("#refreshCache").disabled=!0,o("#clear-q").disabled=!0,o('input[name="as-q"]').focus(),v({mapContainer:"mapSearch",baseLayerSource:"geodeo",drawControl:!0})):(o("#q").placeholder=i.defaultPlaceholder,o("#q").disabled=!1,o("#refreshCache").disabled=!1,o("#clear-q").disabled=!1)},_=e=>{const t=o("input[name=resource]").checked?"treatments":"images";K(t)},x=e=>{if(e.target.open){var t=a("details[open]");Array.prototype.forEach.call(t,(function(t){t!==e.target&&t.removeAttribute("open")}))}},S=e=>{o("#q").value=e.target.textContent,o("#ns-go").classList.add("glowing");a("input[name=source").forEach((e=>{"treatments"===e.value&&(e.checked=!0)})),k(),e.stopPropagation(),e.preventDefault()},E=e=>{o("#refreshCache").toggleAttribute("data-pop-show")},z=e=>{""===o("#q").value?(M(),setTimeout(O,4e3)):(o("#q").classList.remove("red-placeholder"),o("#throbber").classList.remove("nothrob"),o("#ns-go").classList.remove("glowing"),V()),e.stopPropagation(),e.preventDefault()},q=e=>{o("#throbber").classList.remove("nothrob"),V(),e.stopPropagation(),e.preventDefault()},j=e=>{const t=new URL(e.target.href).hash,n=a(".modal");t.length>0?(n.forEach((e=>{e.classList.add(...i.hiddenClasses)})),o(t).classList.remove(...i.hiddenClasses)):n.forEach((e=>e.classList.add(...i.hiddenClasses)))},M=()=>{o("#q").placeholder="c'mon, type something",o("#q").classList.add("red-placeholder")},O=e=>{o("#q").placeholder=i.defaultPlaceholder,o("#q").classList.remove("red-placeholder"),o("#refreshCache").checked=!1},I=e=>{e.target.innerHTML='<a href="#map" id="mapInit">MAP</a> • IMAGES • TREATMENTS',e.target.querySelector("#mapInit").addEventListener("click",D),o("#brand").classList.add("smallbrand"),o("#brand").removeEventListener("click",I),setTimeout((()=>{e.target.innerHTML=4,o("#brand").classList.remove("smallbrand"),o("#brand").addEventListener("click",I)}),3e3),e.stopPropagation(),e.preventDefault()},D=e=>{o("#not-map").classList.add("hidden"),v({mapContainer:"map",baseLayerSource:"geodeo",drawControl:!1})};function F(e){const t=e.querySelector(".next"),n=e.querySelector(".prev");let o=0;const a=e.querySelectorAll(".content .slide"),s=a.length;let r=a[0];function l(e){r.classList.remove("current"),o+=e,-1===e&&o<0&&(o=s-1),1!==e||a[o]||(o=0),r=a[o],r.classList.add("current")}e.classList.add("active"),t.addEventListener("click",(function(e){l(1),function(e){const t=e.currentTarget;if(!i.maps[t.dataset.id]){const e=L.map(`map-${t.dataset.id}`);i.maps[t.dataset.id]=e;const n="http://services.arcgisonline.com/arcgis/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}";L.tileLayer(n,{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(e);const o=L.icon({iconUrl:"img/treatment.svg",iconSize:[10,10],iconAnchor:[5,5]});let a;if("undefined"!==t.dataset.loc){JSON.parse(t.dataset.loc).map((e=>[e.latitude,e.longitude])).forEach(((t,n)=>{0===n&&(a=t),L.marker(t,{icon:o}).addTo(e)})),e.setView(a,10)}else if(t.dataset.convexhull){const n=JSON.parse(t.dataset.convexhull),a=L.polygon(n,{color:"#9BC134",weight:1}).addTo(e);n.forEach(((t,n)=>{L.marker(t,{icon:o}).addTo(e)})),e.fitBounds(a.getBounds())}}}(e)})),n.addEventListener("click",(function(e){l(-1)})),l(0)}const H=e=>{const t=e.target.name;if("between"===e.target.value){a(`#${t}-range .hidden`).forEach((e=>{e.classList.contains("hidden")&&(e.classList.remove("hidden"),e.classList.add("vis"))}))}else{a(`#${t}-range .vis`).forEach((e=>{e.classList.add("hidden"),e.classList.remove("vis")}))}};function A(e,t){const n=document.getElementById("tooltip");n.innerHTML=t,n.style.display="block",n.style.left=e.offsetX+"px",n.style.top=e.offsetY+"px"}function P(){document.getElementById("tooltip").style.display="none"}function U({resource:e,figureSize:t,rec:n}){const o="images"===e?(({figureSize:e,rec:t})=>{const n=t.zenodoRec?`<img src="img/zenodo-gradient-35.png" width="35" height="14"> <a href="${i.uri.zenodo}/records/${t.zenodoRec}" target="_blank">more on Zenodo</a>`:"",o=`<img src="img/treatmentBankLogo.png" width="35" height="14"> <a href="${i.uri.treatmentBank}/${t.treatmentId}" target="_blank">more on TreatmentBank</a>`,a=250===e?"visible":"noblock",s=`figure-${e}`+(t.treatmentId?" tb":""),r=`this.onerror=null; setTimeout(() => { this.src='${t.uri}' }, 1000);`,l=t.loc||t.convexHull?"this.parentNode.parentNode.parentNode.parentNode.style.height=this.height+150+'px'":"";return`<figure class="${s}">\n    <a class="zen" href="${t.fullImage}">\n\n            <img src="img/bug.gif" width="${t.figureSize}" \n                data-src="${t.uri}" \n                class="lazyload" \n                data-recid="${t.treatmentId}" \n                onerror="${r}"\n                onload="${l}">\n        \n    </a>\n    <figcaption class="${a}">\n        <details>\n            <summary class="figTitle" data-title="${t.treatmentTitle}">\n                ${t.treatmentTitle}\n            </summary>\n            <p>${t.captionText}</p>\n            ${o}<br>\n            ${n}\n        </details>\n    </figcaption>\n</figure>`})({figureSize:t,rec:n}):(({figureSize:e,rec:t})=>{let n="";t.zenodoRec&&(n=`<a href="${i.uri.zenodo}/records/${t.zenodoRec}" target="_blank" title="more on Zenodo" alt="more on Zenodo"><img class="zenodoLink" src="img/zenodo-gradient-round.svg" width="50"></a>`);const o=250===e?"visible":"noblock",a=`figure-${e} `+(t.treatmentId?"tb":""),s=t.treatmentDOI?`<a href="https://dx.doi.org/${t.treatmentDOI}">${t.treatmentDOI}</a>`:"";let r="";return t.articleTitle&&(r+=`<span class="articleTitle">${t.articleTitle}</span>`),t.articleAuthor&&(r+=` by <span class="articleAuthor">${t.articleAuthor}</span>`),t.journalTitle&&(r+=` in <span class="journalTitle">${t.journalTitle}</span>`),s&&(r+=`. ${s}`),`<figure class="${a}">\n    <p class="treatmentTitle">${t.treatmentTitle}</p>\n    <p class="citation">${r}</p>\n    <figcaption class="${o}">\n        \x3c!--  --\x3e\n        <div>\n            ${n} <a href="${i.uri.treatmentBank}/${t.treatmentId}" target="_blank" title="more on TreatmentBank" alt="more on TreatmentBank"><img class="tbLink" src="img/treatmentBankLogo.png" width="100"></a>\n        </div>\n    </figcaption>\n</figure>`})({figureSize:t,rec:n}),a="images"===e?`${n.treatments_id}-${n.images_id}`:n.treatments_id;return n.loc||n.convexHull?`\n        <div class="carouselbox">\n\n            <div class="buttons">\n                <button class="prev">\n                    ◀ <span class="offscreen">Previous</span>\n                </button>\n                <button class="next" \n                    data-loc=${JSON.stringify(n.loc)} \n                    data-convexhull=${JSON.stringify(n.convexHull)} \n                    data-id="${a}">\n                    <span class="offscreen">Next</span> ▶︎\n                </button>\n            </div> \n\n            <div class="content">\n                <div class="slide">\n                    ${o}\n                </div>\n                <div id="map-${a}" class="map slide"></div>\n            </div>\n        </div>`:`\n        <div class="slidr">\n            ${o}\n        </div>`}const R=({resource:e,figureSize:t,slides:n,qs:a,count:c,term:d,termFreq:u,yearlyCounts:h,prev:m,next:p,stored:g,ttl:f,cacheHit:y})=>{log.info(`- renderPage()\n    - figureSize: ${t}px\n    - figures: ${n.length} slides\n    - qs: ${a}\n    - count: ${c}\n    - prev: ${m}\n    - next: ${p}`),o("#grid-images").classList.add(`columns-${t}`),N(n),B(a,m,p),o("#throbber").classList.add("nothrob"),i.charts.termFreq&&(i.charts.termFreq.dispose(),o("#termFreq").style.visibility="hidden"),u&&u.length&&(((e,t)=>{const n=s(document.querySelector("#termFreq"));n.innerHTML="";const o="all",a="with images",l={legend:{left:55,top:60,orient:"vertical",borderWidth:1,borderRadius:5,borderColor:"silver",backgroundColor:"#fff"},tooltip:{trigger:"axis",formatter:'<div class="leg">\n    year {b}\n    <hr>\n    {a0}: {c0}<br/>\n    {a1}: {c1}\n</div>'},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",splitLine:{show:!1},data:t.map((e=>e.journalYear))},yAxis:{type:"log",minorSplitLine:{show:!0},axisLabel:{formatter:r}},series:[{name:o,type:"line",data:t.map((e=>0==e.total?null:e.total)),color:"#f00",lineStyle:{color:"#f00",width:1}},{name:a,type:"line",data:t.map((e=>0==e.withImages?null:e.withImages)),color:"#00f",lineStyle:{color:"#00f",width:1}}]},c=document.createElement("div");c.style.width="100%",c.style.height="150px",c.classList.add("viz"),n.appendChild(c),i.charts.termFreq=echarts.init(c),i.charts.termFreq.setOption(l);const d=document.createElement("div");d.style.width="100%",d.classList.add("caption"),n.appendChild(d),d.innerHTML=`occurrence of <span>${e}</span> in the text by year`})(d,u),o("#termFreq").style.visibility="visible"),function(e,t,n,a,s){log.info("- renderSearchCriteria()");const r=new URLSearchParams(e);let l=r.get("resource");const c=[],d=[],u=[];i.params.notValidSearchCriteria.forEach((e=>r.delete(e)));const h='<span class="crit-key">',m='<span class="crit-val">',p='<span class="crit-count">',g="</span>",f={checkinTime:"checked in",updateTime:"updated",publicationDate:"published"};t?t<10&&(t=W(t)):t="Sorry, no";c.push(`${p}${t}${g}`),1===t&&(l=l.slice(0,-1));c.push(l),r.forEach(((e,n)=>{let o;if(Object.keys(f).includes(n)){const a=e.match(/(?<operator1>eq|since|until)?\((?<date>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)|(?<operator2>between)?\((?<from>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\s*and\s*(?<to>[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}|yesterday)\)/);if(a){if(o=`${h}${f[n]}${g}`,a.groups.operator1){let e;e="since"===a.groups.operator1?1===t?"has been":"have been":1===t?"was":"were",c.push(e),"eq"===a.groups.operator1?o+=" on":o+=` ${a.groups.operator1}`,o+=` ${m}${a.groups.date}${g}`}else a.groups.operator2&&(o+=` ${m}between${g} ${m}${a.groups.from}${g} and ${m}${a.groups.to}${g}`);d.push(o)}}else{const t=e.match(/(?<operator>\w+)\((?<term>[\w\s]+)\)/);if(t){const{operator:e,term:a}=t.groups;o=`${h}${n}${g}${e.replace(/_/," ")} ${m}${a}${g}`}else if("q"===n)o=`${h}${e}${g} is in the text`;else if("captionText"===n)o=`${h}${e}${g} is in ${h}caption text${g}`;else if("geolocation"===n){const t=new RegExp("(?<operator>within)\\((radius:s*(?<radius>([+-]?([0-9]+)(.[0-9]+)?)),s*units:s*['\"](?<units>kilometers|miles)['\"],s*lat:s*(?<lat>([+-]?([0-9]+)(.[0-9]+)?)),s*lng:s*(?<lng>([+-]?([0-9]+)(.[0-9]+)?))|min_lat:s*(?<min_lat>([+-]?([0-9]+)(.[0-9]+)?)),min_lng:s*(?<min_lng>([+-]?([0-9]+)(.[0-9]+)?)),max_lat:s*(?<max_lat>([+-]?([0-9]+)(.[0-9]+)?)),max_lng:s*(?<max_lng>([+-]?([0-9]+)(.[0-9]+)?)))\\)"),n=e.match(t);if(n){let{operator:e,radius:t,units:a,lat:i,lng:s,min_lat:r,min_lng:l,max_lat:c,max_lng:d}=n.groups;t?(s=Number(s).toFixed(2),i=Number(i).toFixed(2),o=`${h}location${g} is within ${m}${t}${g} ${m}${a}${g} of ${m}lat ${i}${g} and ${m}lng ${s}${g}`):(l=Number(l).toFixed(2),r=Number(r).toFixed(2),d=Number(d).toFixed(2),c=Number(c).toFixed(2),o=`${h}location${g} is within a box with ${h}lower left corner${g} at ${m}lat ${r}, lng ${l}${g} and ${h}upper right corner${g} at ${m}lat ${c}, lng ${d}${g}`)}}else n=n.split(/([A-Z][a-z]+)/).filter((function(e){return e})).map((e=>e.toLowerCase())).join(" "),o=`${h}${n}${g} is ${m}${e}${g}`;u.push(o)}}));const y=[];d.length?y.push(...d):c.push("found");u.length&&c.push("where");let v;y.push(...u);const $=y.length;v=1===$?y[0]:2===$?`${y[0]} and ${y[1]}`:`${y.slice(0,$-2).join(", ")}, and ${y[$-1]}`;if(c.push(v),s){const e=new Date(n),t=new Date(n+a)-new Date;c.push(`<span aria-label="cache hit, stored ${ee(e)}, expires in ${X(t)}" data-html="true" data-pop="top" data-pop-no-shadow data-pop-arrow data-pop-multiline>💥</span>`)}o("details.charts summary").innerHTML=c.join(" "),o("#charts-container summary").style.visibility="visible"}(a,c,g,f,y),i.charts.yearlyCounts&&(i.charts.yearlyCounts.dispose(),o("#yearlyCounts").style.visibility="hidden"),h&&(l({yearlyCounts:h.yearlyCounts,totals:h.totals}),o("#yearlyCounts").style.visibility="visible"),(u||h)&&(o("#charts").style.visibility="visible");o("input[name=searchtype]").checked&&(o("input[name=searchtype]").checked=!1,T(),J(a)),"images"===e&&new SimpleLightbox({elements:"figure",loadingCaption:'<img src="../../img/bug.gif">'})},N=(e,t,n,i)=>{log.info("- renderSlides()"),e.length?(o("#grid-images").innerHTML=e.join(""),(()=>{const e=a("figcaption > details");for(let t=0,n=e.length;t<n;t++)e[t].addEventListener("toggle",(n=>{const o=n.target.querySelector("summary"),a=o.dataset.title,i=a.length>30?`${a.substring(0,30)}…`:a;o.innerText=e[t].open?a:i}))})(),(()=>{const e=a("figure .reveal");for(let t=0,n=e.length;t<n;t++)e[t].addEventListener("click",I)})(),a(".carouselbox").forEach((e=>{F(e)}))):o("#grid-images").innerHTML=""},B=(e,t,n)=>{log.info("- renderPager()"),log.info(`  - qs: ${e}`),log.info(`  - prev: ${t}`),log.info(`  - next: ${n}`);const a=new URLSearchParams(e);a.delete("page"),o("#pager").innerHTML=`<a href="?${a.toString()}&page=${t}">prev</a> <a href="?${a.toString()}&page=${n}">next</a>`,o("#pager").classList.add("filled"),log.info("- listeners.addListenersToPagerLinks()")};const Z=async e=>{log.info("- getResource(qs)"),o("#throbber").classList.remove("nothrob");const t=new URLSearchParams(e),n=t.get("page"),a=t.get("size"),s=t.get("grid")||"normal",r=i.figureSize[s],l=t.get("resource");let c;t.delete("resource"),t.has("q")&&(c=t.get("q"));const d="images"===l?i.params.validImages:i.params.validTreatments;d.push(...i.params.validCommon);let u=!0;if(Array.from(t).forEach((([e,n])=>{var a;d.includes(e)?n||(t.set("q",e),t.delete(e),c=e):(a=`"${e}" is not a valid param`,o(".warn").classList.contains("hidden")&&(o(".warn").innerHTML=a,o(".warn").classList.remove("hidden"),o("#throbber").classList.add("nothrob"),setTimeout((()=>{o(".warn").innerHTML="",o(".warn").classList.add("hidden")}),3e3)),u=!1)})),!1===u)return;const h="images"===l?`${i.cols.images.join("&cols=")}`:`${i.cols.treatments.join("&cols=")}`;let m=`${t.toString()}&cols=${h}`;c&&(m+="&termFreq=true"),t.has("treatmentId")||(m+="&yearlyCounts=true");const p=[];p.push(G({resource:l,queryString:m,figureSize:r})),Promise.all(p).then((e=>{const t={resource:l,prev:n>1?n-1:1,next:parseInt(n)+1,size:a,count:0,recs:[]};return e.forEach((e=>{void 0!==e&&(t.recs.push(...e.recs),t.count+=e.count,t.termFreq=e.termFreq,t.yearlyCounts=e.yearlyCounts,t.cacheHit=e.cacheHit,t.stored=e.stored,t.ttl=e.ttl)})),t})).then((t=>{const n=t.recs.map((e=>U({resource:l,figureSize:r,rec:e}))),o={resource:l,figureSize:r,slides:n,qs:e,count:t.count,prev:t.prev,next:t.next,stored:t.stored,ttl:t.ttl,cacheHit:t.cacheHit};t.termFreq&&(o.termFreq=t.termFreq,o.term=c),t.yearlyCounts&&(o.yearlyCounts=t.yearlyCounts),R(o)}))},G=async({resource:e,queryString:t,figureSize:n})=>{log.info(`- getResults({ resource, queryString, figureSize })\n    - resource: ${e}\n    - queryString: ${t},\n    - figureSize: ${n}`);const o=`${i.uri.zenodeo}/${e}?${t}`,a=await fetch(o,i.fetchOpts);if(a.ok){const t=await a.json(),o=t.item.result.records;let s;if(t.item.result.yearlyCounts){s={};const e=t.item.result.yearlyCounts,n=e.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});s.yearlyCounts=e,s.totals=n}const r={resource:e,count:0,recs:[],termFreq:t.item.result.termFreq,yearlyCounts:s,prev:"",next:"",stored:t.stored,ttl:t.ttl,cacheHit:t.cacheHit||!1};if(o)return r.count=r.count+t.item.result.count,o.forEach((t=>{const o={};if("images"===e){o.treatmentId=t.treatmentId,o.treatments_id=t.treatments_id,o.images_id=t.images_id,o.treatmentTitle=t.treatmentTitle,o.zenodoRec=t.zenodoDep,o.figureSize=n;const e=t.httpUri.split("/")[4];t.httpUri.indexOf("zenodo")>-1?t.httpUri.indexOf(".svg")>-1?(o.uri="/img/kein-preview.png",o.fullImage="/img/kein-preview.png"):(o.uri=`https://zenodo.org/api/iiif/record:${e}:figure.png/full/250,/0/default.jpg`,o.img=`${i.zenodoUri}/${e}/thumb${n}`,o.fullImage=`https://zenodo.org/api/iiif/record:${e}:figure.png/full/^1200,/0/default.jpg`,o.fullImg=`${i.zenodoUri}/${e}/thumb1200`):(o.uri=`${t.httpUri}/singlefigAOF/`,o.fullImage=t.httpUri),o.captionText=t.captionText,o.treatmentDOI=t.treatmentDOI,o.articleTitle=t.articleTitle,o.articleAuthor=t.articleAuthor,o.latitude=t.latitude,o.longitude=t.longitude,o.loc=t.loc,t.convexHull?o.convexHull=t.convexHull[0].map((([e,t])=>[t,e])):o.convexHull=void 0}else"treatments"===e&&(o.treatmentId=t.treatmentId,o.treatments_id=t.treatments_id,o.treatmentTitle=t.treatmentTitle,o.zenodoRec=t.zenodoDep,o.figureSize=n,o.journalTitle=t.journalTitle,o.treatmentDOI=t.treatmentDOI,o.articleTitle=t.articleTitle,o.articleAuthor=t.articleAuthor,o.latitude=t.latitude,o.longitude=t.longitude,o.loc=t.loc,t.convexHull?o.convexHull=t.convexHull[0].map((([e,t])=>[t,e])):o.convexHull=void 0);r.recs.push(o)})),r}else alert("HTTP-Error: "+a.status)},J=e=>{log.info(`- qs2form(qs)\n    - qs: ${e}`);const t=new URLSearchParams(e);t.delete("refreshCache");const n=[];t.forEach(((e,t)=>{if(log.info(`val: ${e}, key: ${t}`),i.params.notValidQ.includes(t))"resource"===t?(log.info(`setting form to query resource ${e}`),K(e),"treatments"===e?(log.info("setting toggle-resource to true"),o("input[name=resource]").checked=!0):(log.info("setting toggle-resource to false"),o("input[name=resource]").checked=!1)):(log.info(`setting input name ${t} to ${e}`),o(`input[name=${t}]`).value=e);else{let o=t;e&&(o="q"===t?decodeURIComponent(e):`${t}=${e}`),n.push(o)}})),o("#q").value=n.join("&")},W=e=>e<10?["One","Two","Three","Four","Five","Six","Seven","Eight","Nine"][e-1].toLowerCase():e,V=()=>{log.info("submitForm()");const e=Y();if(!e)return!1;Q(e),Z(e)},K=async e=>{const t=await(async(e,t)=>{if(!i.cache[e].yearlyCounts){let n=`${i.uri.zenodeo}/${e}?cols=`;t&&(n+="&yearlyCounts=true");const o={method:"GET",headers:new Headers({"ngrok-skip-browser-warning":!0})},a=await fetch(n,o);if(a.ok){const n=await a.json(),o=n.item.result.count;if(t){const t=n.item.result.yearlyCounts,o=t.reduce(((e,t)=>(e.images+=t.num_of_images,e.treatments+=t.num_of_treatments,e.species+=t.num_of_species,e.journals+=t.num_of_journals,e)),{images:0,treatments:0,species:0,journals:0});i.cache[e].yearlyCounts=t,i.cache[e].totals=o}else i.cache[e].totals[e]=o}else alert("HTTP-Error: "+a.status)}return i.cache[e]})(e,!0);((e,t)=>{let{images:n,treatments:a,species:i,journals:s}=t.totals;const r=t.yearlyCounts;let l="images"===e?n:a;o("#q").placeholder=`search ${e}`;const c=r.length,d=3*c;Math.max(...r);const u=40/l;function h(t,n,o,a,i,s,r){return`<g class="${n}" transform="translate(${t*i},0)">\n            <rect height="${o}" y="${a-o}" width="${i}" onmousemove="showTooltip(evt, '${s}: ${r} ${e}');" onmouseout="hideTooltip();"></rect>\n        </g>`}let m=`<svg id="svgSpark" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="chart" height="40" width="${d}" aria-labelledby="title" role="img">`;for(let t=0;t<c;t++){const n=r[t].year,o=r[t][`num_of_${e}`];m+=h(t,"bar",o*u,40,3,n,o)}m+="</svg>";const p=document.querySelector("#sparkBox");let g=m;l=Math.round(l/1e3,0),a=Math.round(a/1e3,0),n=Math.round(n/1e3,0),i=Math.round(i/1e3,0),s=Math.round(s/1e3,0),g+="images"===e?` <span>~${l}K</span> ${e}, <span>~${a}K</span> treatments, `:`<span>~${l}K</span> ${e}, <span>~${n}K</span> images, `,g+=`<span>~${i}K</span> species, <span>~${s}K</span> journals`,p.innerHTML=g})(e,t),o("#q").placeholder=`search ${e}`},Y=()=>{const e=new URLSearchParams,t=!0===o("input[name=searchtype").checked?"as":"ss";let n=!0;if("ss"===t)log.info("- form2qs(): simple search"),Array.from(a("form input.query")).filter((e=>e.value)).forEach((t=>{let n=t.name,o=t.value;if("q"===t.name){const a=t.value.replaceAll(/ & /g,"%20%26%20");new URLSearchParams(a).forEach(((t,a)=>{if(""===t){const e=o.match(/(^10\.[0-9]{4,}.*)/);e&&e[1]?(n="articleDOI",o=e[1]):(n="q",o=a)}else n=a,o=t;e.append(n,o)}))}else"radio"===t.type||"checkbox"===t.type?"resource"===t.name?t.checked||"true"===t.checked?e.append(n,o):e.append(n,"images"):(t.checked||"true"===t.checked)&&e.append(n,o):e.append(n,o)}));else if("as"===t){log.info("- form2qs(): advanced search");["page","size","resource","refreshCache"].forEach((t=>{const n=o(`input[name=${t}]`);"resource"===t?n.checked||"true"===n.checked?e.append(t,n.value):e.append(t,"images"):(n.checked||"true"===n.checked)&&e.append(t,n.value)}));["q","treatmentTitle","authorityName","articleTitle","journalTitle","collectionCode"].forEach((t=>{const n=o(`input[name="as-${t}"]`);n.value&&e.append(t,n.value)}));["status","refreshCache"].forEach((t=>{const n=o(`input[name="as-${t}"]`);(n.checked||"true"===n.checked)&&e.append(t,n.value)}));const t=["journalYear","publicationDate","checkinTime","biome"],a=t=>{const n=o(`select[name="as-${t}"]`),a=n.selectedIndex,i=n.options[a].value;if(i)if("journalYear"===t)e.append(t,i);else if("biome"===t)e.append(t,i);else if("between"===i){const n=o(`input[name="as-${t}From`),a=n.value,i=o(`input[name="as-${t}To`),s=i.value;if(a&&s)e.append(t,`between(${a} and ${s})`);else{let e=!0;if(""===a&&(n.classList.add("required"),e=!1),""===s&&(i.classList.add("required"),e=!1),!e)return!1}}else{const n=o(`input[name="as-${t}From`);console.log(t);const a=n.value;if(!a)return n.classList.add("required"),!1;e.append(t,`${i}(${a})`)}return!0};for(const e of t){if(!a(e)){n=!1;break}}["geolocation"].forEach((t=>{const n=o(`input[name="as-${t}"]`);n.value&&e.append(t,n.value)}))}if(n){const t=e.toString();return console.log(t),t}return console.log("false"),!1},Q=e=>{log.info("- updateUrl(qs)");const t=`?${e}`;history.pushState({},"",t)},X=e=>{const t=36e5,n=864e5;let o=Math.floor(e/n),a=Math.floor((e-o*n)/t),i=Math.round((e-o*n-a*t)/6e4);const s=e=>e<10?"0"+e:e;return 60===i&&(a++,i=0),24===a&&(o++,a=0),`${o} days ${s(a)} hours ${s(i)} mins`},ee=e=>{const t=e.getFullYear(),n=e.getMonth(),o=e.getDate(),a=e.getHours(),s=e.getMinutes(),r=e.getSeconds();return`${o} ${i.months[n]}, ${t} ${a}:${s}:${r}`};function te(){new autoComplete({selector:'input[name="as-journalTitle"]',minChars:2,source:async function(e,t){e=e.toLowerCase();const n=await async function(){if(i.cache.journals)return i.cache.journals;{const e=`${i.uri.zenodeo}/journals?size=1100&sortby=journalTitle:asc`,t=await fetch(e);if(t.ok){const e=(await t.json()).item.result.records;if(e)return i.cache.journals=e.map((e=>({journals_id:e.journals_id,journalTitle:e.journalTitle}))),i.cache.journals}else alert("HTTP-Error: "+t.status)}}(),o=[];for(let t=0;t<n.length;t++)~n[t].journalTitle.toLowerCase().indexOf(e)&&o.push({journals_id:n[t].journals_id,journalTitle:n[t].journalTitle});t(o)},renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");const n=new RegExp("("+t.split(" ").join("|")+")","gi"),o=e.journalTitle.replace(n,"<b>$1</b>");return`<div class="autocomplete-suggestion" data-id="${e.journalTitle}" data-val="${e.journalTitle}">${o}</div>`},onSelect:function(e,t,n){document.querySelector('input[name="as-journalTitle"]').value=n.getAttribute("data-id")}})}function ne(){new autoComplete({selector:'input[name="as-collectionCode"]',minChars:2,source:async function(e,t){e=e.toLowerCase();const n=await async function(){if(i.cache.collectionCodes)return i.cache.collectionCodes;{const e=`${i.uri.zenodeo}/collectioncodes?cols=collectionCode&cols=name&size=4300`,t=await fetch(e);if(t.ok){const e=(await t.json()).item.result.records;if(e)return i.cache.collectionCodes=e.map((e=>({collectionCode:e.collectionCode,name:e.name}))),i.cache.collectionCodes}else alert("HTTP-Error: "+t.status)}}(),o=[];for(let t=0;t<n.length;t++)~n[t].collectionCode.toLowerCase().indexOf(e)&&o.push({collectionCode:n[t].collectionCode,name:n[t].name});t(o)},renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");const n=new RegExp("("+t.split(" ").join("|")+")","gi");let o=e.collectionCode.replace(n,"<b>$1</b>");return e.name&&(o+=` (${e.name})`),`<div class="autocomplete-suggestion" data-id="${e.collectionCode}">${o}</div>`},onSelect:function(e,t,n){document.querySelector('input[name="as-collectionCode"]').value=n.getAttribute("data-id")}})}var oe;function ae(){const e=new URLSearchParams(window.location.hash.substring(1));if("maps"===(e?e.get("show"):"index"))v({mapContainer:"map",baseLayerSource:"geodeo",drawControl:!1});else{const e=new URL(location);if(e.search){log.info(`- locSearch: ${e.search.substring(1)}`),J(e.search.substring(1));const t=Y();Z(t)}else K("images");log.info("- addListeners()"),o("#refreshCache").addEventListener("click",E),o("#ns-go").addEventListener("click",z),o("#as-go").addEventListener("click",q),o("#q").addEventListener("focus",O),o("#search-help").addEventListener("click",k),o("div.examples").addEventListener("toggle",x,!0),a(".modalToggle").forEach((e=>e.addEventListener("click",j))),a(".example-insert").forEach((e=>e.addEventListener("click",S))),o("input[name=searchtype").addEventListener("click",T),o("input[name=resource").addEventListener("click",_),o('select[name="as-publicationDate"]').addEventListener("change",H),o('select[name="as-checkinTime"]').addEventListener("change",H),a("input[type=date").forEach((e=>e.addEventListener("change",C))),a("#charts-container").forEach((e=>{new c(e)})),document.addEventListener("keydown",b),a("a.quicksearch").forEach((e=>e.addEventListener("click",w))),te(),ne()}}log.level=log[(oe=window.location.hostname,"localhost"===oe?"INFO":"ERROR")];export{P as hideTooltip,ae as init,v as initializeMap,A as showTooltip};
