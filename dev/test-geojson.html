<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="Ocellus, an explorer for the Biodiversity Literature Repository (BLR) on Zenodo">
    <meta name="version" content="4.0">
    <meta name="author" content="Puneet Kishor">
    <meta name="copyright" content="CC0 Public Domain Dedication">
    <meta name="date" content="%date%">
    <meta http-equiv="Cache-Control" content="max-age=604800, public">

    <title>ocellus^4</title>

    <link rel="icon" type="image/png" href="../img/ocellus.png">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

    <style>
#map { height: 500px; }
    </style>
  </head>
  <body>
    <header>
        <div id="brand">4</div>
        <div class="title">
            <h1>ocellus</h1>
            <small>A Plazi Project</small><br>
            <a href="#about" class="modalToggle">about</a>
        </div>
        
        <form>
            <div class="form-wrapper">
                <div class="input-wrapper">
                    <input id="q" type="text" placeholder="search for something" class="clearable">
                    <span id="refreshCacheWrapper" aria-label="refresh cache" data-pop="top" data-pop-no-shadow data-pop-arrow>
                        <input name="refreshCache" id="refreshCache" type="checkbox" value="true" class="unchecked">
                    </span>
                    <span id="clear-q" aria-label="clear input" data-pop="top" data-pop-no-shadow data-pop-arrow>&times;</span>
                </div>
                <button type="submit" id="go">GO</button>
            </div>
            <div id="refreshCacheMsg" class="hidden">This will refresh the cache. You probably donâ€™t want to do this.</div>
        </form>
    </header>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


    <script>
        // const treatments = {
        //     "type": "FeatureCollection",
        //     "features": [
        //         {
        //             "type": "Feature",
        //             "geometry": {
        //                 "type": "MultiPoint",
        //                 "coordinates": [
        //                     [ 14.5041, 46.0434 ],
        //                     [ 14.5367, 45.8631 ]
        //                 ]
        //             },
        //             "properties": {
        //                 "treatmentId": "038587E9FFFBFFA114B39157FEA1B9D5",
        //                 "other": [
        //                     { "color": "blue" },
        //                     { "color": "red" }
        //                 ]
        //             }
        //         },
        //         {
        //             "type": "Feature",
        //             "geometry": {
        //                 "type": "MultiPoint",
        //                 "coordinates": [
        //                     [ 15.5041, 44.0434 ],
        //                     [ 15.5367, 43.8631 ]
        //                 ]
        //             },
        //             "properties": {
        //                 "treatmentId": "0002CCEA6E14946162FAECDE5B68E880",
        //                 "other": [
        //                     { "color": "mauve" },
        //                     { "color": "pink" }
        //                 ]
        //             }
        //         }
        //     ]
        // };

        const treatments = [
            {
                "materialsCitationId": "38C13CBDE32BFF9EFF7EFC1BFD91FBE7",
                "treatmentId": "000087F6E32BFF9FFDE7FDC5FEC2FD41",
                "longitude": 140.57011,
                "latitude": -34.26742,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C13CBDE32FFF9AFF7EFE9FFD49FE6B",
                "treatmentId": "000087F6E32CFF9BFDAEFAB4FD49FBDF",
                "longitude": 116.07842,
                "latitude": -31.92036,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C13CBDE32EFF9BFF7EF8F2FC0CF89C",
                "treatmentId": "000087F6E32EFF9EFDAFFB94FBD9FE11",
                "longitude": 152.872,
                "latitude": -27.45883,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C13CBDE337FF82FF7EFE0FFAB5FDFB",
                "treatmentId": "000087F6E335FF86FDBFFEC9FD1DFA58",
                "longitude": 148.83333,
                "latitude": -35.55,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "B732AE53F283EA6D170B8E37D6C51144",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 11.50163,
                "latitude": 61.28375,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "CC129A0FB2EC9BD740F017CDB3BFB7F3",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 11.50163,
                "latitude": 61.28375,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "1219C7F3F662FF459972722D4CED57EE",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 6.3741,
                "latitude": 59.54636,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "6056BC537EB8C36DF37BECE82A45364D",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 6.3741,
                "latitude": 59.54636,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "B83BE41F465DD101655C234507E17387",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 48.73159,
                "latitude": 55.91237,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "0AF316036A6129D8DF21B87C3AF45002",
                "treatmentId": "00014D1475A55890B4284F14452AB498",
                "longitude": 48.73159,
                "latitude": 55.91237,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C5CE0EFFDAFFE2AFDAFC3EE967EA36",
                "treatmentId": "00047545FFDAFFEBAFDAFCA4EA7FEC76",
                "longitude": -56.670177,
                "latitude": -16.42255,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C53CC0CE1AD07FFF58FE68F1B3FDCC",
                "treatmentId": "0004878BCE1AD075FF58FEB0F351FD28",
                "longitude": 92.32667,
                "latitude": 20.613056,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "19325B47274DC7B60C78E6AEBFAB8689",
                "treatmentId": "0006F643081580F9ADA32607FA6A7FC0",
                "longitude": -61.175003,
                "latitude": -12.134167,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "BDE33DD349202FC775D73276F97D1497",
                "treatmentId": "0006F643081580F9ADA32607FA6A7FC0",
                "longitude": -61.175003,
                "latitude": -12.613334,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "BCFC6410430391439E0CDABA3F81B2D3",
                "treatmentId": "0006F643081580F9ADA32607FA6A7FC0",
                "longitude": -61.44778,
                "latitude": -11.431389,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38C63CC3D74EDE15E88B8FD8FD2FD942",
                "treatmentId": "00078788D74FDE15E88B884FFD2FD942",
                "longitude": -76.72765,
                "latitude": 18.08903,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38CB880CFFA04414FABCF816FBD1A6E5",
                "treatmentId": "000A3347FFA04413F849F958FEB7A0E8",
                "longitude": 98.79195,
                "latitude": 25.302776,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38CB880CFFA04414FAEBFE6AFEDEA367",
                "treatmentId": "000A3347FFA14414F876FE6CFEA6A7B3",
                "longitude": 110.4131,
                "latitude": 31.3406,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38CB880CFFA04414FABCFD0CFC56A3DA",
                "treatmentId": "000A3347FFA14414F876FE6CFEA6A7B3",
                "longitude": 110.4131,
                "latitude": 31.3406,
                "isOnLand": 1
            },
            {
                "materialsCitationId": "38CB880CFFA34417FAEBF986FB55A791",
                "treatmentId": "000A3347FFA34415F866FBABFEABA0BB",
                "longitude": 94.96601,
                "latitude": 30.009642,
                "isOnLand": 1
            }
        ];

        const map = L.map('map').setView([45, 15], 7);
        const basemap = L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            subdomains: ['a','b','c']
        }).addTo(map);

        map.on('click', (e) => {
            if (selectedMarkers.length) {
                selectedMarkers.forEach(m => m.setIcon(iconNormal));
            }

            selectedMarkers.length = 0;
        })

        const makeIcon = (iconUrl) => {
            return L.icon({
                iconUrl,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }


        const iconNormal = makeIcon('/img/treatment.svg');
        const iconHighlighted = makeIcon('/img/treatment-highlighted.svg');

        const allMarkers = {};
        const selectedMarkers = [];

        const popup = (gp) => {
            return () => {
                const thisFid = gp.properties.fid;
                const html = `<h4 class="popup">fid: ${thisFid}</h4>`;
                const thisMarker = allMarkers[thisFid];

                const el = document.createElement('div');
                el.innerHTML = html;
                return el;
            }
        }

        const click = (gp) => {
            return {
                click: (e) => {
                    const m = e.target;
                    const thisFid = gp.properties.fid;

                    for (let [key, val] of Object.entries(allMarkers)) {
                        if (key === thisFid) {
                            selectedMarkers.push(...val);
                        }
                    }

                    selectedMarkers.forEach(m => m.setIcon(iconHighlighted));                        
                }
            }
        }

        const multipoints = L.geoJSON(geojsonFeature, {
            pointToLayer: (gp, latlng) => {
                const marker = L.marker(latlng, { icon: iconNormal });
                marker.bindPopup(popup(gp));
                marker.on(click(gp));
                
                const fid = gp.properties.fid;
                if (fid in allMarkers) {
                    allMarkers[fid].push(marker);
                }
                else {
                    allMarkers[fid] = [marker];
                }

                return marker;
            }
        });
        
        multipoints.addTo(map);
    </script>
  </body>
</html>